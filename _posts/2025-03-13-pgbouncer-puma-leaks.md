---
layout: post
subtitle: <div id="terminal"></div>
title: "PgBouncer –Ω–µ —Å–ø–∞—Å—ë—Ç, –µ—Å–ª–∏ –≤—ã –Ω–µ —É–º–µ–µ—Ç–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"
date: 2025-03-13 15:00:00 +0300
rate: 3
tags: PgBouncer,PostgreSQL,Rails,—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è,—É—Ç–µ—á–∫–∏,CPU
version: A49X3
categories:
  - postgres
  - rails
toc: true
menubar_toc: true
hero_image: /images/architecture.jpg
hero_darken: true
---
PgBouncer ‚Äî —ç—Ç–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏ PostgreSQL, –Ω–æ –æ–Ω –Ω–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —É—Ç–µ—á–µ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ –≤–∞—à–µ–º Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. –ï—Å–ª–∏ –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–æ–≤, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—ã—Å—Ç—Ä–æ —Å—Ç–æ–ª–∫–Ω—ë—Ç—Å—è —Å –ø–µ—Ä–µ–≥—Ä—É–∑–∫–æ–π CPU, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Puma –∏–ª–∏ Sidekiq. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö –∏ –≤–æ—Ä–∫–µ—Ä–∞—Ö ‚Äî –∫–ª—é—á –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ —Å–∏—Å—Ç–µ–º—ã.

---

> ¬´–£ –Ω–∞—Å PgBouncer!¬ª  
> ¬´–ü–æ—á–µ–º—É –±–∞–∑–∞ –Ω–∞ 100% CPU?¬ª  
> ‚Äî –ö–ª–∞—Å—Å–∏–∫–∞.

## ü§î –í —á—ë–º —Å—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

PgBouncer —É–º–µ–µ—Ç —Ä–∞–∑–¥–∞–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, **–Ω–æ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∏—Ö –∑–∞ –≤–∞—Å**.  
–ï—Å–ª–∏ –≤ Puma (–∏–ª–∏ –¥—Ä—É–≥–æ–º web-—Å–µ—Ä–≤–µ—Ä–µ) –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –æ–Ω–∏ **–≤–∏—Å—è—Ç –Ω–∞–≤–µ—á–Ω–æ**.

---

## üß™ –ü—Ä–∏–º–µ—Ä

–í—ã –¥–µ–ª–∞–µ—Ç–µ `User.find(...)`, –Ω–æ **–Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç–µ** `ActiveRecord::Base.clear_active_connections!`  
–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∂–∏—Ç—å –¥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞.

---

## üßØ –ß—Ç–æ –¥–µ–ª–∞—Ç—å

### 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `config/initializers/connection_management.rb` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:

```ruby
# config/initializers/connection_management.rb
Rails.application.config.after_initialize do
  ActiveSupport.on_load(:action_controller) do
    after_action do
      ActiveRecord::Base.clear_active_connections!
    end
  end
end
````

–≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è:

* Web-—Å–µ—Ä–≤–µ—Ä–æ–≤ (Puma, Unicorn)
* Background job workers (Sidekiq)

---

### 2. Sidekiq: –Ω–µ –∑–∞–±—É–¥—å `ActiveRecord::Base.clear_all_connections!`

–í worker'–µ:

```ruby
def perform(*args)
  # ...
ensure
  ActiveRecord::Base.clear_all_connections!
end
```

---

## üß† –ê PgBouncer —Ç—É—Ç –ø—Ä–∏ —á—ë–º?

–û–Ω **—Ä–∞–∑–¥–∞—ë—Ç** —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.
–ù–æ –µ—Å–ª–∏ –≤—ã **–∏—Ö –Ω–µ –æ—Ç–¥–∞—ë—Ç–µ –æ–±—Ä–∞—Ç–Ω–æ** ‚Äî –æ–Ω–∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è.

–ü—Ä–∏–º–µ—Ä: –ø—É–ª –Ω–∞ 20, –Ω–æ 20 –≤–æ—Ä–∫–µ—Ä–æ–≤ –ø–æ–≤–∏—Å–ª–∏ –Ω–∞ –≤–µ—á–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è—Ö ‚Äî –∏ –≤–æ—Ç —É–∂–µ –æ—á–µ—Ä–µ–¥—å —Ä–∞—Å—Ç—ë—Ç, –±–∞–∑–∞ —Ç–æ—Ä–º–æ–∑–∏—Ç, PgBouncer –Ω–µ –ø—Ä–∏ —á—ë–º.

---

## ‚úÖ –í—ã–≤–æ–¥

PgBouncer ‚Äî –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç. –ù–æ –±–µ–∑ –∫—É–ª—å—Ç—É—Ä—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏ –≤—ã –ø—Ä–æ—Å—Ç–æ –ø–æ–ª—É—á–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –±–æ–ª–µ–µ –º–µ–¥–ª–µ–Ω–Ω—É—é —Å–º–µ—Ä—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ PostgreSQL.
