---
layout: post
subtitle: <div id="terminal"></div>
title:  "–ö–æ–≥–¥–∞ enum —É–∂–µ –Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è: State Machine –∫–∞–∫ —Å–ø–∞—Å–µ–Ω–∏–µ"
date:   2024-09-18 12:00:00 +0300
rate: 3
tags: Ruby,enum,–º–µ—Ç–æ–¥—ã,—É—Å–ª–æ–≤–∏—è,–ø—Ä–æ–≤–µ—Ä–∫–∏,—Å–æ—Å—Ç–æ—è–Ω–∏—è
version: A49X3
categories:
  - pattern
  - rails
hero_image: /images/ruby.jpg
hero_darken: true
toc: true
menubar_toc: true
---

Enum –≤ Rails ‚Äî —ç—Ç–æ —É–¥–æ–±—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –ª–µ–≥–∫–æ –ø–µ—Ä–µ—Ä–∞—Å—Ç–∞–µ—Ç –≤ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—É.
–í—ã –Ω–∞—á–∞–ª–∏ —Å –Ω–µ–≤–∏–Ω–Ω–æ–≥–æ `enum status: [:draft, :published, :archived]`.
–ê —Ç–µ–ø–µ—Ä—å –≤ –∫–æ–¥–µ: `if post.draft? && user.admin? && !weekend? && moon_in_taurus?`.
–ü–æ–∑–¥—Ä–∞–≤–ª—è—é ‚Äî —É –≤–∞—Å –Ω–µ enum, –∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤, –∑–∞–ø—Ä—è—Ç–∞–Ω–Ω–∞—è –≤ —É—Å–ª–æ–≤–∏—è—Ö.

–í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º—Å—è, **—á—Ç–æ —Ç–∞–∫–æ–µ State Machine**, –∫–æ–≥–¥–∞ –æ–Ω–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ –ø–æ–º–æ—â—å, –∏ –ø–æ—á–µ–º—É –æ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∞—à–∏–º —Å–ø–∞—Å–µ–Ω–∏–µ–º –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö `if`. –ü–æ–∫–∞–∂–µ–º, –∫–∞–∫ –≤–Ω–µ–¥—Ä–∏—Ç—å –µ—ë –≤ Rails-–ø—Ä–æ–µ–∫—Ç –∫—Ä–∞—Å–∏–≤–æ, –±–µ–∑ –º–∞–≥–∏–∏ –∏ –±–æ–ª–∏.

---

## üßô‚Äç‚ôÇÔ∏è –¢–µ–æ—Ä–∏—è: —á—Ç–æ —Ç–∞–∫–æ–µ State Machine?

**State Machine (—Å—Ç–µ–π—Ç-–º–∞—à–∏–Ω–∞, –∞–≤—Ç–æ–º–∞—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–π)** ‚Äî —ç—Ç–æ –º–æ–¥–µ–ª—å, –≥–¥–µ:  
- –û–±—ä–µ–∫—Ç –º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –≤ **–æ–¥–Ω–æ–º –∏–∑ –∫–æ–Ω–µ—á–Ω–æ–≥–æ —á–∏—Å–ª–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π**  
- –ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ **—Å—Ç—Ä–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã**  
- –ú–æ–∂–Ω–æ –Ω–∞–≤–µ—Å–∏—Ç—å **–∫–æ–ª–±—ç–∫–∏, –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ guard-—É—Å–ª–æ–≤–∏—è**  

–≠—Ç–æ –∫–∞–∫ —Å–≤–µ—Ç–æ—Ñ–æ—Ä: –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–π—Ç–∏ —Å "–∑–µ–ª—ë–Ω–æ–≥–æ" —Å—Ä–∞–∑—É –Ω–∞ "–∫—Ä–∞—Å–Ω—ã–π", –º–∏–Ω—É—è "–∂—ë–ª—Ç—ã–π".

---

## üí£ –ö–æ–≥–¥–∞ enum —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤—Ä–∞–≥–æ–º

```ruby
class Article < ApplicationRecord
  enum status: [:draft, :published, :archived]

  def publish!
    return if archived? || (draft? && !user.has_permission?)
    update!(status: :published)
    NotifySubscribers.call(self)
    AuditLog.record!(self)
  end
end
```

**–ü—Ä–æ–±–ª–µ–º—ã:**  
1. –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ **—Ä–∞–∑–º–∞–∑–∞–Ω–∞** –ø–æ –º–µ—Ç–æ–¥–∞–º  
2. –ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –≤–∏–¥–Ω—ã **–≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã**  
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ = **—Ä–µ–≤—å—é –≤—Å–µ–≥–æ –∫–æ–¥–∞**  

---

## üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç–µ–π—Ç-–º–∞—à–∏–Ω—É

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–∏—à–µ–º —Å–≤–æ—é (–¥–ª—è –º–∞–∑–æ—Ö–∏—Å—Ç–æ–≤)

```ruby
class Article
  STATES = %i[draft published archived].freeze

  def initialize(state)
    @state = state
  end

  def publish!
    raise "–ù–µ–ª—å–∑—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∞—Ä—Ö–∏–≤" if @state == :archived
    @state = :published
  end
end
```

**–ú–∏–Ω—É—Å—ã:**  
- –í–µ–ª–æ—Å–∏–ø–µ–¥—ã –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ  
- –ù–µ—Ç —É–¥–æ–±–Ω—ã—Ö –∫–æ–ª–±—ç–∫–æ–≤  

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑—É–µ–º `aasm` (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```ruby
class Article < ApplicationRecord
  include AASM

  aasm column: :status do
    state :draft, initial: true
    state :published
    state :archived

    event :publish do
      transitions from: :draft, to: :published, guard: :valid_author?
      after { NotifySubscribers.call(self) }
    end

    event :archive do
      transitions from: [:draft, :published], to: :archived
    end
  end

  def valid_author?
    user.has_permission? && !user.banned?
  end
end
```

**–§–∏—à–∫–∏:**  
‚úÖ –í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã **—è–≤–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω—ã** –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ  
‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **before/after —Ö—É–∫–æ–≤**  
‚úÖ **Guard-—É—Å–ª–æ–≤–∏—è** –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤  

---

## üî• –ì–æ—Ä—è—á–∏–µ –≥—Ä–∞–±–ª–∏

### 1. –ù–µ —É—á–∏—Ç—ã–≤–∞–π—Ç–µ –≤—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã

```ruby
event :archive do
  transitions from: :published, to: :archived # –∑–∞–±—ã–ª–∏ :draft
end
```

**–†–µ—à–µ–Ω–∏–µ:** —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ coverage-—Ç–µ—Å—Ç–∞–º–∏:

```ruby
Article.state_machine.states.each do |state|
  it "–ø–æ–∑–≤–æ–ª—è–µ—Ç –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–∑ #{state}" do
    # ...
  end
end
```

---

### 2. –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∫–æ–ª–±—ç–∫–æ–≤

```ruby
after_publish :notify, :audit, :update_elastic, :invalidate_cache
```

**–ò—Ç–æ–≥:** –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `publish!` –ø–æ–ª—É—á–∞–µ—Ç–µ **–Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ —Å–∞–π–¥-—ç—Ñ—Ñ–µ–∫—Ç—ã**.  

**–†–µ—à–µ–Ω–∏–µ:** –≤—ã–Ω–æ—Å–∏—Ç–µ –≤ —Å–µ—Ä–≤–∏—Å—ã:

```ruby
PublishArticle.call(article) # –≤–Ω—É—Ç—Ä–∏: article.publish! + –ø–æ–±–æ—á–∫–∏
```

---

### 3. –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏

```ruby
article.publish! # User 1
article.archive! # User 2 (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
```

**–§–∏–∫—Å:**  
- –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (`lock_version`)  
- PostgreSQL advisory locks  

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≥–µ–º–æ–≤

| –ì–µ–º          | –ü–ª—é—Å—ã                          | –ú–∏–Ω—É—Å—ã                   |
|--------------|-------------------------------|--------------------------|
| `aasm`       | –ì–∏–±–∫–æ—Å—Ç—å, –∞–∫—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ   | –ú–∞–≥–∏—è –≤ –∫–æ–ª–±—ç–∫–∞—Ö         |
| `statesman`  | –ß–∏—Å—Ç—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã, –∏—Å—Ç–æ—Ä–∏—è      | –ë–æ–ª—å—à–µ –∫–æ–¥–∞              |
| `workflow`   | –ü—Ä–æ—Å—Ç–æ—Ç–∞                      | –£—Å—Ç–∞—Ä–µ–≤—à–∏–π               |

**–ú–æ–π –≤—ã–±–æ—Ä ‚Äî `aasm`** –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤.

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```ruby
RSpec.describe Article, type: :model do
  describe "state transitions" do
    context "from draft" do
      let(:article) { create(:article, status: :draft) }

      it "allows publishing" do
        expect { article.publish! }
          .to change(article, :status).to("published")
      end

      it "forbids archiving for guests" do
        article.user = build(:user, role: :guest)
        expect { article.archive! }.to raise_error(AASM::InvalidTransition)
      end
    end
  end
end
```

---

## üé§ –ß—Ç–æ —Å–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏

> ‚Äî –ü–æ—á–µ–º—É –Ω–µ enum?  

‚Äî –ö–æ–≥–¥–∞ –ø–æ—è–≤–∏–ª–∏—Å—å —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤, –º—ã –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ —Å—Ç–µ–π—Ç-–º–∞—à–∏–Ω—É. –≠—Ç–æ —Å–¥–µ–ª–∞–ª–æ –∫–æ–¥:  
- **–ü–æ–Ω—è—Ç–Ω–µ–µ** (–≤—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ)  
- **–ù–∞–¥—ë–∂–Ω–µ–µ** (–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º)  
- **–õ–µ–≥—á–µ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è**  

---

## üßæ –í—ã–≤–æ–¥

**State Machine ‚Äî —ç—Ç–æ –ì—ç–Ω–¥–∞–ª—å—Ñ –≤–∞—à–µ–≥–æ –∫–æ–¥–∞.**  
–û–Ω –ø–æ—è–≤–ª—è–µ—Ç—Å—è, –∫–æ–≥–¥–∞ enum —É–∂–µ –Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –æ—Ä–∫–∞–º–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.  

**–í–Ω–µ–¥—Ä—è–π—Ç–µ, –µ—Å–ª–∏:**  
- –ï—Å—Ç—å —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤  
- –ù—É–∂–Ω—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–ª–±—ç–∫–∏  
- –•–æ—á–µ—Ç—Å—è —è–≤–Ω–æ –≤–∏–¥–µ—Ç—å –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –æ–±—ä–µ–∫—Ç–∞  

**–ù–æ –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞–π—Ç–µ –≤ "–º–∞–≥–∏—é":**  
- –ò–∑–±–µ–≥–∞–π—Ç–µ —Å–∫—Ä—ã—Ç—ã—Ö —Å–∞–π–¥-—ç—Ñ—Ñ–µ–∫—Ç–æ–≤  
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã  
- –°–ª–µ–¥–∏—Ç–µ –∑–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏  

–¢–µ–ø–µ—Ä—å –≤–∞—à –∫–æ–¥ —Å–º–æ–∂–µ—Ç —Å–ø–æ–∫–æ–π–Ω–æ –ø—Ä–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –ú–æ—Ä–∏—é –±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π. üßô‚Äç‚ôÇÔ∏è
