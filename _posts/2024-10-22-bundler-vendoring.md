---
layout: post
title:  "Vendoring –≥–µ–º–æ–≤: –∫–æ–≥–¥–∞ —Ç–≤–æ–π CI –Ω–µ –ª—é–±–∏—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç"
rate: 3
tags: Ruby,gems,vendoring,CI,dependencies,network errors
version: A49X3
date:   2024-09-18 12:00:00 +0300
categories:
  - ruby
  - devops
hero_image: /images/ruby.jpeg
hero_darken: true
toc: true
menubar_toc: true
---

–í—ã –∑–Ω–∞–µ—Ç–µ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ CI –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π `Network error: Failed to download gem 'some-gem-42.0'`, –∞ –¥–µ–¥–ª–∞–π–Ω ‚Äî –≤—á–µ—Ä–∞?  
–ü–æ–∑–¥—Ä–∞–≤–ª—è—é: –≤—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏ **–≥–ª–∞–≤–Ω—É—é –±–æ–ª—å distributed-—Å–∏—Å—Ç–µ–º ‚Äî –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞**.  

–í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ **vendoring –≥–µ–º–æ–≤** —Å–ø–∞—Å–∞–µ—Ç –æ—Ç —Ö–∞–æ—Å–∞, –∫–æ–≥–¥–∞:  
- GitHub –ª–µ–∂–∏—Ç,  
- RubyGems —Ç–æ—Ä–º–æ–∑–∏—Ç,  
- –∞ –≤–∞—à —Ä–µ–ª–∏–∑ –¥–æ–ª–∂–µ–Ω —É–π—Ç–∏ **–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å**.

---

## ÔøΩ –ü–æ—á–µ–º—É ¬´–ø—Ä–æ—Å—Ç–æ bundle install¬ª ‚Äî —ç—Ç–æ —Ä—É—Å—Å–∫–∞—è —Ä—É–ª–µ—Ç–∫–∞

–¢–∏–ø–∏—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:  

```bash
bundle install
# ... —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç ...
Gem::RemoteFetcher::FetchError: bad response Not Found 404
```

**–ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–±–∏–≤–∞—é—Ç –≤–∞—à CI/CD:**  
1. **–•—Ä—É–ø–∫–æ—Å—Ç—å**: –≤–Ω–µ—à–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.  
2. **–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**: `bundle update` –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–µ—Å—Ç–∏ —Å—é—Ä–ø—Ä–∏–∑—ã (–æ—Å–æ–±–µ–Ω–Ω–æ —Å `~>` –∏ `>=`).  
3. **–°–∫–æ—Ä–æ—Å—Ç—å**: –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç–µ–Ω –º–µ–≥–∞–±–∞–π—Ç –≥–µ–º–æ–≤ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –±–∏–ª–¥–µ.  

> ¬´–ù–æ —É –Ω–∞—Å –∂–µ –∫–µ—à!¬ª ‚Äî —Å–∫–∞–∂–µ—Ç–µ –≤—ã.  
> –ê —Ç–µ–ø–µ—Ä—å –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ **–Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–ª–∏ emergency-—Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ**.

---

## üß∞ –ß—Ç–æ —Ç–∞–∫–æ–µ vendoring –≥–µ–º–æ–≤?

**Vendoring** ‚Äî —ç—Ç–æ –ø—Ä–∞–∫—Ç–∏–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è **–≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä—è–º–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—Ä–æ–µ–∫—Ç–∞**.  
–í–º–µ—Å—Ç–æ:  

```
Gemfile
Gemfile.lock
```

–í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ:  

```
Gemfile
Gemfile.lock
vendor/cache/ # ‚Üê –≤—Å–µ .gem —Ñ–∞–π–ª—ã —Ç—É—Ç
```

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

1. **–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ**: –≥–µ–º—ã —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ –∫–ª–∞–¥—É—Ç—Å—è –≤ `vendor/cache`.  
2. **–û—Ñ—Ñ–ª–∞–π–Ω-—É—Å—Ç–∞–Ω–æ–≤–∫–∞**: `bundle install --local` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã.  
3. **–ì–∞—Ä–∞–Ω—Ç–∏—è –≤–µ—Ä—Å–∏–π**: –Ω–∏–∫–∞–∫–∏—Ö –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ—Å—Ç–µ–π –ø—Ä–∏ –¥–µ–ø–ª–æ–µ.  

---

## üîß –ü—Ä–∞–∫—Ç–∏–∫–∞: –∫–∞–∫ –∑–∞–≤–µ—Å—Ç–∏ vendoring –≤ –ø—Ä–æ–µ–∫—Ç–µ

### –®–∞–≥ 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```bash
bundle package --all
```

–§–ª–∞–≥ `--all` –≤–∫–ª—é—á–∞–µ—Ç –¥–∞–∂–µ –≥–µ–º—ã –∏–∑ optional-–≥—Ä—É–ø–ø (—Ç–∏–ø–∞ `:development`).  

–¢–µ–ø–µ—Ä—å –≤ `vendor/cache` –ª–µ–∂–∞—Ç **–≤—Å–µ .gem-—Ñ–∞–π–ª—ã**, –∞ —Ç–∞–∫–∂–µ –∏—Ö checksums.  

### –®–∞–≥ 2. CI/CD –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞

–î–æ–±–∞–≤–ª—è–µ–º –≤ –≤–∞—à —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è:  

```bash
bundle install --local || exit 1
```

–ï—Å–ª–∏ –≥–µ–º–æ–≤ –Ω–µ—Ç –≤ –∫–µ—à–µ ‚Äî –±–∏–ª–¥ **–ø–∞–¥–∞–µ—Ç**, –∞ –Ω–µ –ª–µ–∑–µ—Ç –≤ —Å–µ—Ç—å.  

### –®–∞–≥ 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–µ–º–æ–≤

–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:  

```bash
bundle update some-gem
bundle package --all
git add vendor/cache
git commit -m "Update some-gem to v42.0"
```

---

## üí£ –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã

### 1. ¬´Vendor‚Äô–∏–º —Ç–æ–ª—å–∫–æ production-–≥–µ–º—ã¬ª  

```bash
bundle package --no-install
```

–ü—Ä–æ–±–ª–µ–º–∞: **–Ω–∞ CI —É–ø–∞–¥—É—Ç —Ç–µ—Å—Ç—ã**, –ø–æ—Ç–æ–º—É —á—Ç–æ `rspec` –∏–ª–∏ `rubocop` –Ω–µ —Å–∫–∞—á–∞–Ω—ã.  

### 2. ¬´–î–æ–±–∞–≤–∏–º vendor/cache –≤ .dockerignore¬ª  

–¢–µ–ø–µ—Ä—å –≤–∞—à –æ–±—Ä–∞–∑ **—Å–Ω–æ–≤–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–µ—Ç–∏**.  

### 3. ¬´–ó–∞—á–µ–º —ç—Ç–æ, –µ—Å–ª–∏ –µ—Å—Ç—å Docker layer caching?¬ª  

–ê —Ç–µ–ø–µ—Ä—å —Å–æ–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞–∑ **–Ω–∞ –Ω–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ**.  

---

## üèóÔ∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Rails –∏ PostgreSQL

### –ü—Ä–∏–º–µ—Ä –¥–ª—è Dockerfile

```dockerfile
COPY Gemfile Gemfile.lock ./
COPY vendor/cache /vendor/cache
RUN bundle install --local
```

### –î–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –Ω–∞—Ç–∏–≤–Ω—ã–º–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏

–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –≥–µ–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `pg` –¥–ª—è PostgreSQL) —Ç—Ä–µ–±—É—é—Ç **–∫–æ–º–ø–∏–ª—è—Ü–∏–∏**.  

–†–µ—à–µ–Ω–∏–µ:  

```bash
bundle config set force_ruby_platform true
bundle package --all
```

–¢–µ–ø–µ—Ä—å –≤ `vendor/cache` –ø–æ–ø–∞–¥—ë—Ç **—á–∏—Å—Ç–∞—è Ruby-–≤–µ—Ä—Å–∏—è** –≥–µ–º–∞.  

---

## üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º vendoring

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç **–±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞**:  

```bash
rm -rf ~/.bundle/cache
bundle install --local
```

–ï—Å–ª–∏ –ø–∞–¥–∞–µ—Ç ‚Äî –∑–Ω–∞—á–∏—Ç, **–∫–∞–∫–∏–µ-—Ç–æ –≥–µ–º—ã –ø—Ä–æ–ø—É—â–µ–Ω—ã**.  

---

## üé§ –ß—Ç–æ —Å–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏

> ‚Äî –ö–∞–∫ –≤—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –¥–µ–ø–ª–æ–µ–≤?  

‚Äî –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º vendoring –≥–µ–º–æ–≤, —á—Ç–æ–±—ã CI –∏ production-—Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è **–Ω–µ –∑–∞–≤–∏—Å–µ–ª–∏ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤**. –≠—Ç–æ –¥–∞—ë—Ç:  
- **–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å** (—Ç–µ –∂–µ –≤–µ—Ä—Å–∏–∏ –≥–µ–º–æ–≤),  
- **—Å–∫–æ—Ä–æ—Å—Ç—å** (–Ω–µ –∫–∞—á–∞–µ–º –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ .gem-—Ñ–∞–π–ª—ã),  
- **–Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å** (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –æ—Ç–∫–ª—é—á—ë–Ω–Ω–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ).  

---

## üßæ –í—ã–≤–æ–¥

**Vendoring ‚Äî —ç—Ç–æ –∫–∞–∫ –Ω–æ—Å–∏—Ç—å —Å —Å–æ–±–æ–π –∞–ø—Ç–µ—á–∫—É –≤–º–µ—Å—Ç–æ –Ω–∞–¥–µ–∂–¥—ã –Ω–∞ –±–ª–∏–∂–∞–π—à—É—é –±–æ–ª—å–Ω–∏—Ü—É.**  
- ‚úÖ –ë–æ–ª—å—à–µ –Ω–∏–∫–∞–∫–∏—Ö `bundle install` —Å –º–æ–ª–∏—Ç–≤–æ–π.  
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π **–Ω–∞ 100%**.  
- ‚úÖ –î–µ–ø–ª–æ–π **–¥–∞–∂–µ –≤ –æ—Ñ—Ñ–ª–∞–π–Ω–µ**.  

–¶–µ–Ω–∞? **–õ–∏—à–Ω–∏–µ –º–µ–≥–∞–±–∞–π—Ç—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏**.  
–ù–æ –µ—Å–ª–∏ –≤–∞—à CI —É–∂–µ –ø–∞–¥–∞–ª –∏–∑-–∑–∞ `rubygems.org` ‚Äî –≤—ã –∑–Ω–∞–µ—Ç–µ, —á—Ç–æ –¥–µ–ª–∞—Ç—å.  

```bash
git add vendor/cache
git commit -m "Make CI great again"
```