---
layout: post
subtitle: <div id="terminal"></div>
title: "–û—á–µ—Ä–µ–¥—å –∏–ª–∏ –ø–æ—Ç–æ–∫? Kafka vs RabbitMQ —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º —É–∫–ª–æ–Ω–æ–º"
date:   2024-09-20 12:00:00 +0300
rate: 3
tags: Ruby on Rails,Kafka,RabbitMQ,–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞,PostgreSQL,–±—Ä–æ–∫–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π
version: A9X
categories:
  - architecture
  - rails
  - performance
hero_image: /images/ruby.jpg
hero_darken: true
toc: true
menubar_toc: true
---
–í—ã–±–æ—Ä –º–µ–∂–¥—É –æ—á–µ—Ä–µ–¥—è–º–∏ –∏ –ø–æ—Ç–æ–∫–∞–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äî —ç—Ç–æ –∫–∞–∫ –≤—ã–±–æ—Ä –º–µ–∂–¥—É –ø–æ—á—Ç–∞–ª—å–æ–Ω–æ–º –∏ —Ä–∞–¥–∏–æ—Å—Ç–∞–Ω—Ü–∏–µ–π: –æ–¥–∏–Ω –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –¥–æ—Å—Ç–∞–≤–∏—Ç –ø–∏—Å—å–º–æ, –¥—Ä—É–≥–æ–π –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Ä–∞–∑–æ—à–ª—ë—Ç –Ω–æ–≤–æ—Å—Ç–∏ —Ç—ã—Å—è—á–∞–º. –í —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º Kafka –∏ RabbitMQ –Ω–∞ –ø—Ä–∏–º–µ—Ä–∞—Ö –∏–∑ Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –ø–æ–∫–∞–∂–µ–º, –∫–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å ¬´–±—Ä–æ–∫–µ—Ä–Ω–æ–≥–æ –∞–¥–∞¬ª –∏ –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å PostgreSQL —Ñ–æ–Ω–æ–≤—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏.

---
–í—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª–∏ `Sidekiq.perform_async` –≤ 42 –º–µ—Å—Ç–∞—Ö –∫–æ–¥–∞‚Ä¶  
–ê –ø–æ—Ç–æ–º: `OrderProcessorJob`, `AnalyticsTrackerJob`, `EmailNotifierJob` –ø–∞–¥–∞—é—Ç –∏–∑-–∑–∞ –æ–¥–Ω–æ–π –º–µ–¥–ª–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏.  
–ü–æ—Ä–∞ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω—ã **–æ—á–µ—Ä–µ–¥–∏**, –∞ –∫–æ–≥–¥–∞ ‚Äî **–ø–æ—Ç–æ–∫–∏ —Å–æ–±—ã—Ç–∏–π**.

---

## üß† –¢–µ–æ—Ä–∏—è: –æ—á–µ—Ä–µ–¥–∏ vs –ø–æ—Ç–æ–∫–∏

### RabbitMQ (–æ—á–µ—Ä–µ–¥–∏)
- **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞**: –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ (–∏–ª–∏ N —Ä–∞–∑ –ø—Ä–∏ —Ä–µ—Ç—Ä–∞—è—Ö).
- **–¢–æ—á–µ—á–Ω–∞—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è**: –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∑–Ω–∞–µ—Ç, –∫—Ç–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `billing_service`).
- **–ì–∏–±–∫–æ—Å—Ç—å**: –æ–±–º–µ–Ω–Ω–∏–∫–∏, routing keys, dead-letter –æ—á–µ—Ä–µ–¥–∏.

### Kafka (–ø–æ—Ç–æ–∫–∏)
- **–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π**: —Å–æ–æ–±—â–µ–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ—á–∏—Ç–∞–Ω—ã (–∫–∞–∫ –∂—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π).
- **–®–∏—Ä–æ–∫–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è**: –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ —Å–∞–º–∏ —Ä–µ—à–∞—é—Ç, –∫–∞–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –∏–º –Ω—É–∂–Ω—ã.
- **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å**: —Ç—ã—Å—è—á–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É.

---

## üîß –ü—Ä–∞–∫—Ç–∏–∫–∞ –≤ Rails

### RabbitMQ + Bunny
```ruby
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
conn = Bunny.new(host: 'rabbitmq')
conn.start
channel = conn.create_channel
queue = channel.queue('orders')

# –û—Ç–ø—Ä–∞–≤–∫–∞
queue.publish({ order_id: 42 }.to_json)

# –ü–æ–ª—É—á–µ–Ω–∏–µ
queue.subscribe do |delivery_info, properties, body|
  OrderProcessor.call(JSON.parse(body))
end
```

### Kafka + rdkafka-ruby
```ruby
# Producer
producer = Rdkafka::Config.new({ "bootstrap.servers": "kafka:9092" }).producer
producer.produce(
  topic: "user_events",
  payload: { event: "signup", user_id: 123 }.to_json
)

# Consumer
consumer = Rdkafka::Config.new({ "bootstrap.servers": "kafka:9092", "group.id": "analytics" }).consumer
consumer.subscribe("user_events")
consumer.each do |message|
  Analytics.track(JSON.parse(message.payload))
end
```

---

## üí° –ö–æ–≥–¥–∞ —á—Ç–æ –≤—ã–±—Ä–∞—Ç—å?

### RabbitMQ –µ—Å–ª–∏:
- –û–±—Ä–∞–±–æ—Ç–∫–∞ **—Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è PDF).
- –¢—Ä–µ–±—É–µ—Ç—Å—è **—Ç–æ—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å** –∑–∞ –¥–æ—Å—Ç–∞–≤–∫–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–ª–∞—Ç–µ–∂–∏).
- –†–∞–±–æ—Ç–∞ —Å **–¥–æ–ª–≥–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏** (—Ä–µ—Ç—Ä–∞–∏, –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ).

### Kafka –µ—Å–ª–∏:
- –ù—É–∂–Ω–∞ **–∏—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π** (–∞—É–¥–∏—Ç—ã, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞).
- –ú–Ω–æ–∂–µ—Å—Ç–≤–æ **–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤** (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ + –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ + –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ).
- –í—ã—Å–æ–∫–∏–µ **–Ω–∞–≥—Ä—É–∑–∫–∏** (—Ç—Ä–µ–∫–µ—Ä—ã –∫–ª–∏–∫–æ–≤, IoT-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞).

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### RabbitMQ (–∏—Å–ø–æ–ª—å–∑—É–µ–º fake adapter)
```ruby
# spec/rails_helper.rb
config.before(:suite) do
  BunnyMock.use_bunny_queue_mock = true
end

# –í —Ç–µ—Å—Ç–µ
it "–ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å" do
  expect(BunnyMock.queue(:orders)).to receive(:publish).with(/order_id/)
  OrderCreator.call(params)
end
```

### Kafka (–º–æ–∫–∞–µ–º producer)
```ruby
let(:fake_producer) { instance_double(Rdkafka::Producer) }
before do
  allow(Rdkafka::Config).to receive(:new).and_return(fake_producer)
end

it "–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–≤–µ–Ω—Ç –≤ Kafka" do
  expect(fake_producer).to receive(:produce).with(topic: "user_events", payload: /signup/)
  User.signup!(email: "test@example.com")
end
```

---

## üî• –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã

| –û—à–∏–±–∫–∞                          | –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è                     | –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?                  |
|---------------------------------|---------------------------------|---------------------------------|
| –û—Ç–ø—Ä–∞–≤–∫–∞ 1 –ú–ë JSON –≤ Kafka      | –ë—Ä–æ–∫–µ—Ä –∑–∞—Ö–ª–µ–±–Ω—ë—Ç—Å—è              | –°–∂–∏–º–∞—Ç—å –∏–ª–∏ —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ S3     |
| 1000 –æ—á–µ—Ä–µ–¥–µ–π –≤ RabbitMQ        | –°–ª–æ–∂–Ω–æ—Å—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞          | –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ –¥–æ–º–µ–Ω–∞–º         |
| –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—Å–µ —Ç–æ–ø–∏–∫–∏ Kafka    | Consumer —Ç–æ—Ä–º–æ–∑–∏—Ç               | –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞  |
| –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ `delivery_tag`    | –ü–æ—Ç–µ—Ä—è —Å–æ–æ–±—â–µ–Ω–∏–π               | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏    |

---

## üé§ –ß—Ç–æ —Å–∫–∞–∑–∞—Ç—å –Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–º —Ä–µ–≤—å—é

> ‚Äî –ü–æ—á–µ–º—É –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º RabbitMQ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏?

‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ Kafka –¥–∞—ë—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—á–∏—Ç–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–±—ã—Ç–∏–π –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –Ω–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –ø—Ä–æ–¥—é—Å–µ—Ä–æ–≤.

---

## üßæ –í—ã–≤–æ–¥

**RabbitMQ ‚Äî –≤–∞—à –Ω–∞–¥—ë–∂–Ω—ã–π –ø–æ—á—Ç–∞–ª—å–æ–Ω –¥–ª—è –∑–∞–¥–∞—á, Kafka ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ª–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è —Å–æ–±—ã—Ç–∏–π.**  
–í—ã–±–∏—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–æ–≤, –≤—Ç–æ—Ä–æ–π ‚Äî –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏. –ò –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –±—Ä–æ–∫–µ—Ä–µ ‚Äî —Ç–æ–ª—å–∫–æ –≤ PostgreSQL.

> P.S. –ï—Å–ª–∏ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ–±–æ–ª—å—à–æ–µ ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, –≤–∞–º —Ö–≤–∞—Ç–∏—Ç –∏ Sidekiq. –ù–æ –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è —Å–ª–æ–≤–æ ¬´–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã¬ª ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ.
