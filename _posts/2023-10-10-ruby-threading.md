---
layout: post
title:  "Ruby: –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç ‚Äî –ø–æ—Ç–æ–∫–∏, GIL –∏ Mutex"
date:   2023-10-10 10:00:00 +0300
categories:
  - ruby
toc: true
menubar_toc: true
hero_image: /images/ruby.jpeg
hero_darken: true
---

Ruby –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ—Ç–æ–∫–∏. –ù–æ –µ—Å–ª–∏ —Ç—ã –¥—É–º–∞–µ—à—å, —á—Ç–æ –º–æ–∂–µ—à—å —Ä–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏—Ç—å –∫–æ–¥ –∫–∞–∫ –≤ Java ‚Äî —É –Ω–∞—Å –¥–ª—è —Ç–µ–±—è –Ω–æ–≤–æ—Å—Ç–∏: **MRI Ruby –∏—Å–ø–æ–ª—å–∑—É–µ—Ç GIL**, –∏ –≤—Å—ë –Ω–µ —Ç–∞–∫ –ø—Ä–æ—Å—Ç–æ.

---

## üöß –ß—Ç–æ —Ç–∞–∫–æ–µ GIL?

**GIL** ‚Äî Global Interpreter Lock (–≤ MRI Ruby —ç—Ç–æ GVL: Global VM Lock).  
–û–Ω **–Ω–µ –¥–∞—ë—Ç –¥–≤—É–º Ruby-–ø–æ—Ç–æ–∫–∞–º –∏—Å–ø–æ–ª–Ω—è—Ç—å Ruby-–∫–æ–¥ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**.

---

## ü§î –¢–æ–≥–¥–∞ –∑–∞—á–µ–º –≤–æ–æ–±—â–µ –ø–æ—Ç–æ–∫–∏?

- –û–Ω–∏ **–ø–æ–ª–µ–∑–Ω—ã –ø—Ä–∏ I/O**: —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤, —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –æ–∂–∏–¥–∞–Ω–∏–µ –ë–î.
- –û–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ**, –Ω–æ –Ω–µ **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ**.
- –ü–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è `sleep`, `gets`, `read`, `open-uri`, Net::HTTP –∏ –ø—Ä–æ—á–∏—Ö.

---

## üß™ –ü—Ä–∏–º–µ—Ä: —Ä–∞–±–æ—Ç–∞–µ—Ç —Å I/O

```ruby
threads = []

3.times do |i|
  threads << Thread.new do
    puts "Start #{i}"
    sleep 1
    puts "End #{i}"
  end
end

threads.each(&:join)
````

‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–≤ —Å–º—ã—Å–ª–µ –∑–∞–¥–µ—Ä–∂–µ–∫ `sleep`), –Ω–æ –Ω–µ –≤ 3 –ø–æ—Ç–æ–∫–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ Ruby-–∫–æ–¥–∞.

---

## üß® –ü—Ä–∏–º–µ—Ä: –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å CPU

```ruby
threads = []

3.times do
  threads << Thread.new do
    10_000_000.times { Math.sqrt(1234) }
  end
end

threads.each(&:join)
```

‚ùå –†–∞–±–æ—Ç–∞–µ—Ç **–º–µ–¥–ª–µ–Ω–Ω–µ–µ, —á–µ–º –æ–¥–∏–Ω –ø–æ—Ç–æ–∫**. GIL –Ω–µ –¥–∞—ë—Ç Ruby-–∫–æ–¥—É –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.

---

## üîê Mutex –∏ –∑–∞—â–∏—Ç–∞ –æ—Ç –≥–æ–Ω–æ–∫

```ruby
mutex = Mutex.new
counter = 0

threads = 10.times.map do
  Thread.new do
    1000.times do
      mutex.synchronize { counter += 1 }
    end
  end
end

threads.each(&:join)
puts counter  # => 10000
```

–ë–µ–∑ `Mutex` –∑–Ω–∞—á–µ–Ω–∏–µ –º–æ–≥–ª–æ –±—ã—Ç—å –Ω–µ —Ç–æ ‚Äî –≥–æ–Ω–∫–∞ –¥–∞–Ω–Ω—ã—Ö (`race condition`).

---

## üì¶ Queue ‚Äî –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å

```ruby
q = Queue.new

producer = Thread.new do
  5.times { |i| q << i }
  q << :done
end

consumer = Thread.new do
  loop do
    val = q.pop
    break if val == :done
    puts "Got #{val}"
  end
end

[producer, consumer].each(&:join)
```

`Queue` ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –≤ Ruby –∏ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏.

---

## üß† –¢–∞–∫ –∫–∞–∫ –∂–µ –¥–µ–ª–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å?

* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–ø—Ä–æ—Ü–µ—Å—Å—ã**, –∞ –Ω–µ –ø–æ—Ç–æ–∫–∏: `fork`, `Parallel`, `Process.spawn`
* –ò–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Ruby:

    * **JRuby** ‚Äî –Ω–∞—Å—Ç–æ—è—â–∞—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å
    * **TruffleRuby** ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏
* –ò–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å –≤–Ω–µ MRI: Rust, Go, Elixir ü§ñ

---

## ‚ö†Ô∏è –ù–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏ –º–æ–≥—É—Ç —Å–ø—Ä–æ—Å–∏—Ç—å:

> ‚Äú–ê –∫–∞–∫ —Ç—ã —Ä–µ–∞–ª–∏–∑—É–µ—à—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É 100 URL–æ–≤ –≤ MRI Ruby?‚Äù

–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:

* `Thread` + `Net::HTTP` –∏–ª–∏ `open-uri`
* –ò–ª–∏ `Typhoeus`, `HTTPX`, `async`
* –ì–ª–∞–≤–Ω–æ–µ: –Ω–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å –Ω–∞ —É—Å–∫–æ—Ä–µ–Ω–∏–µ CPU-–∑–∞–¥–∞—á

---

üîö **–í—ã–≤–æ–¥:**
Ruby —É–º–µ–µ—Ç –¥–µ–ª–∞—Ç—å **–≤–∏–¥**, —á—Ç–æ —É –Ω–µ–≥–æ –µ—Å—Ç—å –ø–æ—Ç–æ–∫–∏. –ù–æ –Ω–µ –ø—É—Ç–∞–π I/O —Å CPU.
–í MRI ‚Äî —ç—Ç–æ –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å, –∞ –Ω–µ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å. –ù–æ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –∂–¥—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–ª–∏ API, —ç—Ç–æ–≥–æ —á–∞—Å—Ç–æ —Ö–≤–∞—Ç–∞–µ—Ç —Å –≥–æ–ª–æ–≤–æ–π.
