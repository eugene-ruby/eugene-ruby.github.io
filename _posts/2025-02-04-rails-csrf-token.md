---
layout: post
subtitle: <div id="terminal"></div>
title:  "CSRF –≤ Rails: –∑–∞—á–µ–º —ç—Ç–æ—Ç authenticity_token –≤–æ–æ–±—â–µ –Ω—É–∂–µ–Ω"
date:   2024-09-18 12:00:00 +0300
rate: 2
tags: Ruby on Rails,–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å,CSRF,–≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
version: A9X
categories:
  - security
  - rails
hero_image: /images/posts/73.jpg
hero_darken: true
toc: true
menubar_toc: true
---

–ö–∞–∂–¥—ã–π Rails-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∞–ª–∫–∏–≤–∞–ª—Å—è —Å –∑–∞–≥–∞–¥–æ—á–Ω—ã–º `authenticity_token` –≤ —Ñ–æ—Ä–º–∞—Ö. –û–Ω –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –ø–æ –≤–æ–ª—à–µ–±—Å—Ç–≤—É, –ª–æ–º–∞–µ—Ç —Ç–µ—Å—Ç—ã, –µ—Å–ª–∏ –µ–≥–æ –∑–∞–±—ã—Ç—å, –Ω–æ –º–∞–ª–æ –∫—Ç–æ –ø–æ–Ω–∏–º–∞–µ—Ç, –∑–∞—á–µ–º –æ–Ω –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –Ω—É–∂–µ–Ω. –†–∞–∑–±–µ—Ä—ë–º—Å—è, –∫–∞–∫ —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω –∑–∞—â–∏—â–∞–µ—Ç –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç CSRF-–∞—Ç–∞–∫, –ø–æ—á–µ–º—É –µ–≥–æ –Ω–µ–ª—å–∑—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å –Ω–∏–º —Ä–∞–±–æ—Ç–∞—Ç—å.

---

## üîê –ß—Ç–æ —Ç–∞–∫–æ–µ CSRF?

**CSRF (Cross-Site Request Forgery)** ‚Äî —ç—Ç–æ –∞—Ç–∞–∫–∞, –∫–æ–≥–¥–∞ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –±—Ä–∞—É–∑–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–ø–æ–ª–Ω—è—Ç—å –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –¥—Ä—É–≥–æ–º –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.

–ü—Ä–∏–º–µ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è:
1. –í—ã –∑–∞–ª–æ–≥–∏–Ω–µ–Ω—ã –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–±–∞–Ω–∫–µ.
2. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π —Å–∞–π—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ `/transfer_money?amount=1000&to=attacker`.
3. –ë—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤–∞—à–∏ –∫—É–∫–∏ ‚Äî –∏ –¥–µ–Ω—å–≥–∏ —É—Ö–æ–¥—è—Ç –º–æ—à–µ–Ω–Ω–∏–∫—É.

---

## üõ°Ô∏è –ö–∞–∫ Rails –∑–∞—â–∏—â–∞–µ—Ç—Å—è –æ—Ç CSRF?

Rails –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **authenticity_token** ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π:
1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏.
2. –í—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º—ã –∏ AJAX-–∑–∞–ø—Ä–æ—Å—ã.
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –¥–µ–π—Å—Ç–≤–∏–π.

```html
<form action="/posts" method="post">
  <input type="hidden" name="authenticity_token" value="k3j5h...">
  <!-- –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è -->
</form>
```

–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî Rails –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Å –æ—à–∏–±–∫–æ–π `ActionController::InvalidAuthenticityToken`.

---

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º?

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞**:
   ```ruby
   # –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ
   def form
     @token = form_authenticity_token
   end
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞** (–≤ `ActionController::RequestForgeryProtection`):
   ```ruby
   def verify_authenticity_token
     raise InvalidAuthenticityToken unless verified_request?
   end
   ```

3. **–ú–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–æ–≤–µ—Ä–∫–∏**:
   - –î–ª—è —Ñ–æ—Ä–º: —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å —Ç–æ–∫–µ–Ω–æ–º –≤ —Å–µ—Å—Å–∏–∏.
   - –î–ª—è JSON API: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-CSRF-Token`.

---

## üí• –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### 1. "–£ –º–µ–Ω—è API ‚Äî –∑–∞—á–µ–º –º–Ω–µ CSRF?"
–ï—Å–ª–∏ –≤–∞—à API **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—É–∫–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ JWT), –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç—É:
```ruby
class ApiController < ActionController::Base
  skip_forgery_protection
end
```

### 2. "–¢–æ–∫–µ–Ω —Å–ª–æ–º–∞–ª –º–æ–∏ —Ç–µ—Å—Ç—ã"
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `post :create, params: { ... }, as: :json` –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤—Ä—É—á–Ω—É—é:
```ruby
post :create, params: { authenticity_token: @controller.form_authenticity_token }
```

### 3. "–§–æ—Ä–º–∞ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è —á–µ—Ä–µ–∑ Turbo Stream"
Turbo –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω, –Ω–æ –µ—Å–ª–∏ –≤—ã —Ä–µ–Ω–¥–µ—Ä–∏—Ç–µ —á–∞—Å—Ç–∏—á–Ω—ã–µ —Ñ–æ—Ä–º—ã —á–µ—Ä–µ–∑ `render partial: 'form'`, –Ω–µ –∑–∞–±—É–¥—å—Ç–µ:
```erb
<%= form_with(model: @post) do |form| %>
  <%= form.hidden_field :authenticity_token %>
<% end %>
```

---

## ‚ö†Ô∏è –û–ø–∞—Å–Ω—ã–µ –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã

### ‚ùå –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∑–∞—â–∏—Ç—ã
```ruby
# config/application.rb
config.action_controller.default_protect_from_forgery = false # –ù–ò–ö–û–ì–î–ê –¢–ê–ö –ù–ï –î–ï–õ–ê–ô–¢–ï
```

### ‚ùå –ü–µ—Ä–µ–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–∞ –≤ URL
```ruby
link_to "–£–¥–∞–ª–∏—Ç—å", post_path(@post, authenticity_token: form_authenticity_token), method: :delete
```
–¢–æ–∫–µ–Ω –º–æ–∂–µ—Ç –ø–æ–ø–∞—Å—Ç—å –≤ –ª–æ–≥–∏ –∏–ª–∏ –∏—Å—Ç–æ—Ä–∏—é –±—Ä–∞—É–∑–µ—Ä–∞.

### ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```ruby
# –ù–µ –¥–µ–ª–∞–π—Ç–µ —Ç–∞–∫!
def form_authenticity_token
  "static_token"
end
```

---

## üõ†Ô∏è –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–∞–º–∏

### –î–ª—è AJAX-–∑–∞–ø—Ä–æ—Å–æ–≤:
```javascript
// –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–∞-—Ç–µ–≥
const token = document.querySelector('meta[name="csrf-token"]').content;
fetch('/posts', {
  method: 'POST',
  headers: {
    'X-CSRF-Token': token
  }
});
```

### –î–ª—è API —Å —Å–µ—Å—Å–∏—è–º–∏:
–î–æ–±–∞–≤—å—Ç–µ –≤ `ApplicationController`:
```ruby
protect_from_forgery with: :exception
after_action :set_csrf_cookie

def set_csrf_cookie
  cookies['CSRF-TOKEN'] = form_authenticity_token
end
```

---

## üéØ –í—ã–≤–æ–¥

`authenticity_token` ‚Äî —ç—Ç–æ –Ω–µ "–º–∞–≥–∏—è Rails", –∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- **–ó–∞—â–∏—â–∞–µ—Ç** –æ—Ç CSRF-–∞—Ç–∞–∫ –±–µ–∑ —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- **–†–∞–±–æ—Ç–∞–µ—Ç** –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤.
- **–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è** –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å API –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ JavaScript-–∑–∞–ø—Ä–æ—Å–∞–º–∏.

–ö–∞–∫ –∏ —Ä–µ–º–Ω–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ ‚Äî –æ–Ω –º–æ–∂–µ—Ç –∫–∞–∑–∞—Ç—å—Å—è –Ω–µ—É–¥–æ–±–Ω—ã–º, –ø–æ–∫–∞ –≤—ã –Ω–µ —Å—Ç–æ–ª–∫–Ω—ë—Ç–µ—Å—å —Å —Ä–µ–∞–ª—å–Ω–æ–π —É–≥—Ä–æ–∑–æ–π. –ù–µ –æ—Ç–∫–ª—é—á–∞–π—Ç–µ –µ–≥–æ –±–µ–∑ –∫—Ä–∞–π–Ω–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏ –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ, —á—Ç–æ –æ–Ω –Ω–∞ –º–µ—Å—Ç–µ –≤ –≤–∞—à–∏—Ö —Ñ–æ—Ä–º–∞—Ö!
