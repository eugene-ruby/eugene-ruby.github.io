---
layout: post
title:  "Ruby: GIL, MRI, MJIT, YJIT ‚Äî –≥–ª–æ—Å—Å–∞—Ä–∏–π —Ä—É–±–∏—Å—Ç–æ–≤—Å–∫–∏—Ö —Å—Ç—Ä–∞—à–∏–ª–æ–∫"
date:   2025-01-30 10:00:00 +0300
rate: 3
tags: Ruby,GVL,YJIT,Ractors,Fiber Scheduler,CRuby
version: A49X3
categories:
  - ruby
toc: true
menubar_toc: true
hero_image: /images/ruby.jpeg
hero_darken: true
---
Ruby –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è, –ø—Ä–µ–¥–ª–∞–≥–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –Ω–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º –∫–ª—é—á–µ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã ‚Äî –æ—Ç GVL –∏ YJIT –¥–æ Ractors –∏ Fiber Scheduler, ‚Äî –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –≥–ª—É–±–∂–µ –ø–æ–Ω—è—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —è–∑—ã–∫–∞ –∏ –µ–≥–æ —ç–∫–æ—Å–∏—Å—Ç–µ–º—É.

---
–ï—Å–ª–∏ —Ç—ã —á–∏—Ç–∞–µ—à—å —Ä–µ–ª–∏–∑-–Ω–æ—Ç—ã Ruby, –∞ —Ç–∞–º –≤ –∫–∞–∂–¥–æ–º –≤—Ç–æ—Ä–æ–º –∞–±–∑–∞—Ü–µ: ‚ÄúGVL‚Äù, ‚ÄúJIT‚Äù, ‚ÄúMJIT‚Äù, ‚ÄúYJIT‚Äù, ‚ÄúCRuby‚Äù –∏ —á—Ç–æ-—Ç–æ –ø—Ä–æ Ractors ‚Äî –Ω–µ –ø—É–≥–∞–π—Å—è.  
–≠—Ç–æ –≤—Å–µ–≥–æ –ª–∏—à—å –∂–∞—Ä–≥–æ–Ω. –ù–∏–∂–µ ‚Äî —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–Ω—è—Ç–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –ª—é–±—è—Ç –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è—Ö, –º–∏—Ç–∞–ø–∞—Ö –∏ changelog'–∞—Ö.

## üß† MRI (–∏–ª–∏ CRuby)

**Matz‚Äôs Ruby Interpreter** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Ruby, –Ω–∞–ø–∏—Å–∞–Ω–Ω–∞—è –Ω–∞ C.

- –í–µ—Ä—Å–∏—è Ruby, –∫–æ—Ç–æ—Ä—É—é —Ç—ã —Å—Ç–∞–≤–∏—à—å —á–µ—Ä–µ–∑ `rbenv`/`rvm`
- –ò–Ω–æ–≥–¥–∞ –Ω–∞–∑—ã–≤–∞—é—Ç **CRuby** (Ruby, –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–π –Ω–∞ C)

---

## üõ° GIL / GVL

**GIL** ‚Äî Global Interpreter Lock (–≤ Ruby ‚Üí **GVL** ‚Äî Global VM Lock)

- –ù–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏–º Ruby-–ø–æ—Ç–æ–∫–∞–º –≤—ã–ø–æ–ª–Ω—è—Ç—å Ruby-–∫–æ–¥ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ü–æ—ç—Ç–æ–º—É Ruby –ø–æ—Ç–æ–∫–∏ ‚â† –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å

---

## ‚öôÔ∏è JIT (Just-In-Time Compiler)

Ruby –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ–º—ã–π, –Ω–æ —Å 2.6 –ø–æ—è–≤–∏–ª–∞—Å—å –æ–ø—Ü–∏—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ "–Ω–∞ –ª–µ—Ç—É":

- Ruby-–∫–æ–¥ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç—Å—è –≤ C, –ø–æ—Ç–æ–º –≤ –º–∞—à–∏–Ω–Ω—ã–π –∫–æ–¥
- –≠—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç —á–∞—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º—ã–µ –º–µ—Ç–æ–¥—ã

---

## üîß MJIT (Method-based JIT)

–ü–æ—è–≤–∏–ª—Å—è –≤ Ruby 2.6‚Äì3.2. –†–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫:

- Ruby-–∫–æ–¥ ‚Üí C-–∫–æ–¥ ‚Üí —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `.so` ‚Üí –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
- –†–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ –∏ —Å –Ω–∞–≥—Ä–µ–≤–æ–º (warm-up)

Ruby 3.2 —É–±—Ä–∞–ª MJIT –∏–∑ –ø—Ä–æ–¥–∞–∫—à–Ω-–ø—É—Ç–∏ (–æ—Å—Ç–∞–ª—Å—è –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)

---

## ‚ö°Ô∏è YJIT (Yet another JIT)

–°–æ–∑–¥–∞–Ω Shopify. –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ **Rust**, –≤—Å—Ç—Ä–æ–µ–Ω –ø—Ä—è–º–æ –≤ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä.  

- –ë—ã—Å—Ç—Ä–µ–µ —Ä–∞–∑–æ–≥—Ä–µ–≤–∞–µ—Ç—Å—è
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á—ë–Ω —Å Ruby 3.3 (–Ω–∞ Linux/macOS)
- –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

---

## üßµ Fiber

–û–±–ª–µ–≥—á—ë–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –≤–Ω—É—Ç—Ä–∏ Ruby:

```ruby
f = Fiber.new do
  puts "start"
  Fiber.yield
  puts "resume"
end

f.resume # => start
f.resume # => resume
````

---

## üîÅ Fiber Scheduler API

–ü–æ–∑–≤–æ–ª—è–µ—Ç Ruby –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ I/O (`sleep`, `gets`, `open-uri`) –∏ –¥–µ–ª–∞—Ç—å –∏—Ö **–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–º–∏**:

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏ –≤—Ä–æ–¥–µ `async`, `httpx`, `falcon`
* –û—Å–Ω–æ–≤–Ω–æ–π —à–∞–≥ –∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–º—É async –≤ Ruby

---

## üë• Ractor

–ù–æ–≤—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç–∏ (—Å Ruby 3.0):

* –ó–∞–ø—É—Å–∫–∞–µ—Ç Ruby-–∫–æ–¥ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
* –ë–µ–∑ GVL!
* –ñ—ë—Å—Ç–∫–∞—è –∏–∑–æ–ª—è—Ü–∏—è ‚Äî —Ç–æ–ª—å–∫–æ `shareable` –æ–±—ä–µ–∫—Ç—ã

---

## üí† Data

–õ—ë–≥–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ `Struct`) —Å –∏–º–º—É—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å—é:

```ruby
Point = Data.define(:x, :y)
Point.new(1, 2)
```

* –†–∞–±–æ—Ç–∞–µ—Ç —Å Ractor (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ shareable)
* –ë—ã—Å—Ç—Ä–µ–µ –∏ –ø—Ä–æ—â–µ Struct

---

## üß™ RuboCop, Sorbet, RBS ‚Äî —ç—Ç–æ –Ω–µ —è–¥—Ä–æ, –Ω–æ —Ç–æ–∂–µ —Å–ª–æ–≤–µ—á–∫–∏

* **RuboCop** ‚Äî –ª–∏–Ω—Ç–µ—Ä, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∏–ª—å –∫–æ–¥–∞
* **Sorbet** ‚Äî —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –æ—Ç Shopify
* **RBS** ‚Äî –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–µ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã —Ç–∏–ø–æ–≤ (–≤—Å—Ç—Ä–æ–µ–Ω—ã –≤ Ruby 3+)

---

## üî¨ TruffleRuby / JRuby / mruby

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

| –†–µ–∞–ª–∏–∑–∞—Ü–∏—è  | –ù–∞–ø–∏—Å–∞–Ω–∞ –Ω–∞ | –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                |
| ----------- | ----------- | -------------------------- |
| JRuby       | Java        | –ü–æ—Ç–æ–∫–∏ –±–µ–∑ GIL, JVM        |
| TruffleRuby | Java+Graal  | –ë—ã—Å—Ç—Ä–∞—è, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è |
| mruby       | C           | –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π Ruby          |

---

üîö **–í—ã–≤–æ–¥:**
Ruby ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ —è–∑—ã–∫, –∞ —Ü–µ–ª–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä. –ù–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è—Ö –º–æ–≥—É—Ç —Å–ø—Ä–æ—Å–∏—Ç—å —Ö–æ—Ç—å `GVL`, —Ö–æ—Ç—å `YJIT`. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –∑–∞–ø–æ–º–∏–Ω–∞—Ç—å —Ç–µ—Ä–º–∏–Ω—ã, –∞ **–ø–æ–Ω–∏–º–∞—Ç—å –∑–∞—á–µ–º –æ–Ω–∏ –Ω—É–∂–Ω—ã**.
