---
layout: post
subtitle: <div id="terminal"></div>
title:  "Docker-–æ–±—Ä–∞–∑—ã –∫–∞–∫ —á–µ–º–æ–¥–∞–Ω—ã: –∫–∞–∫ —Å–æ–±—Ä–∞—Ç—å –±—ã—Å—Ç—Ä–æ –∏ –Ω–µ —Ç–∞—â–∏—Ç—å –ª–∏—à–Ω–µ–µ"
date:   2024-09-21 12:00:00 +0300
rate: 2
tags: Docker,CI/CD,–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è,DevOps,–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
version: A9X
categories:
  - devops
  - pet
hero_image: /images/ruby.jpg
hero_darken: true
toc: true
menubar_toc: true
---
–°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–æ–≤ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –∫–≤–µ—Å—Ç –Ω–∞ –≤—ã–∂–∏–≤–∞–Ω–∏–µ, –∫–æ–≥–¥–∞ –∫–∞–∂–¥—ã–π `docker build` –∑–∞–Ω–∏–º–∞–µ—Ç 15 –º–∏–Ω—É—Ç, –∞ –∏—Ç–æ–≥–æ–≤—ã–π –æ–±—Ä–∞–∑ –≤–µ—Å–∏—Ç –∫–∞–∫ –≥–∏–ø–ø–æ–ø–æ—Ç–∞–º? –í —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ ‚Äî –æ—Ç –±–∞–∑–æ–≤—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ –¥–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö —Ç–µ—Ö–Ω–∏–∫ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∫—Ä–∞—Ç—è—Ç –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏ –≤ —Ä–∞–∑—ã –∏ –æ–±–ª–µ–≥—á–∞—Ç –≤–∞—à CI/CD-–∫–æ–Ω–≤–µ–π–µ—Ä.

---
–í—ã –Ω–∞–∂–∏–º–∞–µ—Ç–µ `docker build -t my-app .` –∏ –∏–¥—ë—Ç–µ –ø–∏—Ç—å –∫–æ—Ñ–µ‚Ä¶  
–ê –ø–æ—Ç–æ–º –µ—â—ë –æ–¥–∏–Ω. –ò –µ—â—ë.  
–ü–æ—Ä–∞ –º–µ–Ω—è—Ç—å –ø–æ–¥—Ö–æ–¥ ‚Äî **Docker –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ—Ä–º–æ–∑–æ–º**.

---

## üê¢ –ü–æ—á–µ–º—É –æ–±—Ä–∞–∑—ã —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–æ?

–¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

1. **–°–ª–æ–∏—Å—Ç–∞—è –±—é—Ä–æ–∫—Ä–∞—Ç–∏—è** ‚Äî Dockerfile –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –∏ –∫–∞–∂–¥—ã–π `RUN`, `COPY` —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —Å–ª–æ–π
2. **–ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –Ω–µ–∏–∑–º–µ–Ω–Ω–æ–≥–æ** ‚Äî `apt install` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤ –∫–æ–¥–µ
3. **–ú—É—Å–æ—Ä –≤ —Ñ–∏–Ω–∞–ª–µ** ‚Äî –≤ –æ–±—Ä–∞–∑ –ø–æ–ø–∞–¥–∞—é—Ç –∫—ç—à–∏ –ø–∞–∫–µ—Ç–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ Dockerfile:

```dockerfile
FROM ubuntu:latest
COPY . /app      # ‚Üê –õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ —Å–±—Ä–æ—Å–∏—Ç –∫—ç—à –Ω–∏–∂–µ
RUN apt update && apt install -y ruby-dev nodejs
RUN bundle install
RUN npm install
CMD ["rails", "server"]
```

---

## üß† –ü—Ä–∏–Ω—Ü–∏–ø: "–ú–µ–Ω—è–µ—Ç—Å—è —Ä–µ–¥–∫–æ ‚Äî —Å—Ç–∞–≤—å –≤—ã—à–µ"

**–°–ª–æ–∏ Dockerfile –∫—ç—à–∏—Ä—É—é—Ç—Å—è —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑**. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ 4-–π —Å—Ç—Ä–æ–∫–µ ‚Äî –≤—Å—ë –Ω–∏–∂–µ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è.

–†–µ—à–µ–Ω–∏–µ:  

1. –†–∞–∑–º–µ—â–∞–π—Ç–µ —Ä–µ–¥–∫–æ –º–µ–Ω—è—é—â–∏–µ—Å—è –æ–ø–µ—Ä–∞—Ü–∏–∏ (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤) **–≤ –Ω–∞—á–∞–ª–µ**
2. –ß–∞—Å—Ç–æ –º–µ–Ω—è—é—â–∏–µ—Å—è (–∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è) ‚Äî **–≤ –∫–æ–Ω—Ü–µ**

---

## üõ†Ô∏è –ü—Ä–∞–∫—Ç–∏–∫–∞: –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Dockerfile

```dockerfile
# –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ —Å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
FROM ruby:3.2-alpine AS base

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ (–∫—ç—à–∏—Ä—É–µ—Ç—Å—è)
RUN apk add --no-cache build-base nodejs postgresql-dev

# –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–æ–π –¥–ª—è –≥–µ–º–æ–≤ (–∫—ç—à–∏—Ä—É–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è Gemfile)
COPY Gemfile Gemfile.lock .
RUN bundle install --jobs=4 --retry=3

# –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–æ–π –¥–ª—è npm (–∫—ç—à–∏—Ä—É–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è package.json)
COPY package.json yarn.lock .
RUN yarn install --frozen-lockfile

# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—á–∞—Å—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è ‚Äî –∏–¥—ë—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–º)
COPY . .

CMD ["rails", "server"]
```

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**

- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π `alpine`-–æ–±—Ä–∞–∑
- –†–∞–∑–¥–µ–ª–∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∫—É –≥–µ–º–æ–≤ –∏ npm-–ø–∞–∫–µ—Ç–µ–π –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–ª–æ–∏
- –ö–æ–¥ –∫–æ–ø–∏—Ä—É–µ–º –≤ –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—á–µ—Ä–µ–¥—å

---

## üêò –ö–∞–∫ —É–º–µ–Ω—å—à–∏—Ç—å –≤–µ—Å –æ–±—Ä–∞–∑–∞?

1. **–ú–Ω–æ–≥–æ—Å—Ç—É–ø–µ–Ω—á–∞—Ç–∞—è —Å–±–æ—Ä–∫–∞** ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
2. **–ß–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏** ‚Äî —É–¥–∞–ª—è–µ–º –∫—ç—à–∏ –ø–∞–∫–µ—Ç–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
3. **–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –º—É—Å–æ—Ä–∞** ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `.dockerignore`

–ü—Ä–∏–º–µ—Ä –¥–ª—è Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

```dockerfile
# –≠—Ç–∞–ø —Å–±–æ—Ä–∫–∏
FROM ruby:3.2 AS builder

WORKDIR /app
COPY . .
RUN bundle install && \
    rails assets:precompile && \
    rm -rf node_modules tmp/* log/*

# –§–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑
FROM ruby:3.2-alpine

COPY --from=builder /app /app
WORKDIR /app
CMD ["rails", "server"]
```

–†–∞–∑–º–µ—Ä —É–º–µ–Ω—å—à–∏–ª—Å—è —Å 1.8GB –¥–æ 420MB!

---

## üî• –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã

| –û—à–∏–±–∫–∞                          | –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è                     | –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å                  |
|---------------------------------|---------------------------------|--------------------------------|
| `COPY . .` –≤ –Ω–∞—á–∞–ª–µ Dockerfile  | –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –Ω–∞ –∫–∞–∂–¥–æ–º –±–∏–ª–¥–µ | –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –ø–æ—Å–ª–µ–¥–Ω–∏–º       |
| –ù–µ –æ—á–∏—â–∞—Ç—å –∫—ç—à–∏ –ø–∞–∫–µ—Ç–æ–≤         | –†–∞–∑–¥—É—Ç—ã–µ –æ–±—Ä–∞–∑—ã                 | `apt clean`, `rm -rf /var/lib/apt/lists/*` |
| –û–¥–∏–Ω –≥–∏–≥–∞–Ω—Ç—Å–∫–∏–π `RUN`           | –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è       | –†–∞–∑–¥–µ–ª—è—Ç—å –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —ç—Ç–∞–ø—ã  |

---

## üöÄ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –±–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –í CI/CD –∫–∞–∂–¥—ã–π –ø—Ä–æ–≥–æ–Ω –∑–∞–Ω–æ–≤–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Ruby, PostgreSQL-client –∏ –ø—Ä–æ—á–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –±–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ –∏ –≤—ã–∫–ª–∞–¥—ã–≤–∞—Ç—å –µ–≥–æ –≤ registry.

```dockerfile
# Dockerfile.base
FROM ruby:3.2-alpine
RUN apk add --no-cache build-base nodejs postgresql-dev
```

–°–æ–±–∏—Ä–∞–µ–º –∏ –ø—É—à–∏–º:
```bash
docker build -t my-registry/base-rails:latest -f Dockerfile.base .
docker push my-registry/base-rails:latest
```

–¢–µ–ø–µ—Ä—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º Dockerfile:
```dockerfile
FROM my-registry/base-rails:latest  # ‚Üê –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ –∑–¥–µ—Å—å!
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –°–±–æ—Ä–∫–∞ –∏–∑ 15 –º–∏–Ω—É—Ç ‚Üí 2 –º–∏–Ω—É—Ç—ã.

---

## ü§ñ CI/CD: —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Å–±–æ—Ä–∫–∏

**–ü–ª–æ—Ö–æ:**  
```yaml
# .gitlab-ci.yml (–ø–ª–æ—Ö–æ–π –ø—Ä–∏–º–µ—Ä)
deploy:
  script:
    - docker build -t my-app .  # –°–æ–±–∏—Ä–∞–µ–º —Å –Ω—É–ª—è –∫–∞–∂–¥—ã–π —Ä–∞–∑
    - docker push my-app
```

**–•–æ—Ä–æ—à–æ:**  
```yaml
# .gitlab-ci.yml (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
build:
  stage: build
  only:
    - master
  script:
    - docker pull my-registry/base-rails:latest || true
    - docker build --cache-from my-registry/base-rails:latest -t my-app .
    - docker push my-app
```

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
{% raw %}
```bash
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–æ–≤
docker images

# –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–ª–æ–∏ –æ–±—Ä–∞–∑–∞
docker history my-app

# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–µ—Å –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ—è
docker inspect my-app --format='{{.RootFS.Layers}}' | tr ' ' '\n' | xargs -I {} sh -c 'echo {}; docker inspect --format="{{.Size}}" {}'
```
{% endraw %}

---

## üé§ –ß—Ç–æ —Å–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏

> ‚Äî –ö–∞–∫ –≤—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç–µ Docker-–æ–±—Ä–∞–∑—ã –¥–ª—è production?

‚Äî –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–Ω–æ–≥–æ—Å—Ç—É–ø–µ–Ω—á–∞—Ç—É—é —Å–±–æ—Ä–∫—É, –∫–∞—Å—Ç–æ–º–Ω—ã–µ –±–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ –∏ —Å—Ç—Ä–æ–≥–∏–π `.dockerignore`. –≠—Ç–æ —Å–æ–∫—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏ —Å 20 –¥–æ 3 –º–∏–Ω—É—Ç –∏ —É–º–µ–Ω—å—à–∞–µ—Ç –æ–±—Ä–∞–∑—ã –Ω–∞ 70%.

---

## üßæ –í—ã–≤–æ–¥

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Docker ‚Äî —ç—Ç–æ –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –º–∏–Ω–∏–º–∞–ª–∏–∑–º–æ–º.**  
–ü—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Dockerfile —ç–∫–æ–Ω–æ–º–∏—Ç —á–∞—Å—ã CI/CD-—Ä–∞–Ω–Ω–µ—Ä–æ–≤, –≥–∏–≥–∞–±–∞–π—Ç—ã —Ç—Ä–∞—Ñ–∏–∫–∞ –∏ –≤–∞—à–∏ –Ω–µ—Ä–≤—ã.  

–ì–ª–∞–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:  
1. **–ú–µ–Ω—è–µ—Ç—Å—è —Ä–µ–¥–∫–æ ‚Äî —Å—Ç–∞–≤—å –≤—ã—à–µ**  
2. **–†–∞–∑–¥–µ–ª—è–π –∏ –∫—ç—à–∏—Ä—É–π**  
3. **–ù–µ —Ç–∞—â–∏ –º—É—Å–æ—Ä –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω**  

–¢–µ–ø–µ—Ä—å –≤–∞—à `docker build` –±—É–¥–µ—Ç –±—ã—Å—Ç—Ä—ã–º –∫–∞–∫ –≥–µ–ø–∞—Ä–¥, –∞ –æ–±—Ä–∞–∑—ã ‚Äî –ª—ë–≥–∫–∏–º–∏ –∫–∞–∫ –ø–µ—Ä–æ. üöÄ
