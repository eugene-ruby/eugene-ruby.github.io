---
layout: post
subtitle: <div id="terminal"></div>
title:  "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ Rails + PostgreSQL: –∫–æ–º–º–∏—Ç –∏–ª–∏ –æ—Ç–∫–∞—Ç?"
date:   2024-12-10 14:00:00 +0300
rate: 3
tags: PostgreSQL,Rails,—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏,ActiveRecord,savepoints,—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
version: A9X
categories:
  - orm
  - rails
  - postgres
toc: true
menubar_toc: true
hero_image: /images/posts/56.jpg
hero_darken: true
---
–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ PostgreSQL –∏ Rails –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∑–≤–æ–ª—è—è –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Ç–æ–º–∞—Ä–Ω–æ ‚Äî –ª–∏–±–æ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è, –ª–∏–±–æ –Ω–∏ –æ–¥–Ω–æ. –í —ç—Ç–æ–º –º–∞—Ç–µ—Ä–∏–∞–ª–µ —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å savepoints –∏ –∫–∞–∫–∏–µ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å ActiveRecord.

---
–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ PostgreSQL ‚Äî –Ω–∞–¥—ë–∂–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–¥–µ–ª–∞—Ç—å —Å–µ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π –∞—Ç–æ–º–∞—Ä–Ω–æ–π. –ê Rails –ø–æ–º–æ–≥–∞–µ—Ç —Å —ç—Ç–∏–º –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π: `ActiveRecord::Base.transaction`.

## üîÅ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

```ruby
ActiveRecord::Base.transaction do
  user.update!(name: "John")
  account.withdraw!(100)
end
````

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —É–ø–∞–¥—ë—Ç ‚Äî –≤—Å—ë –æ—Ç–∫–∞—Ç–∏—Ç—Å—è. –≠—Ç–æ –≤–∞–∂–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ –¥–µ–Ω–µ–≥ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.

---

## ‚ùå –ß—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç rollback

* `raise` –∏–ª–∏ `raise ActiveRecord::Rollback` –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞
* `update!` —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
* –õ—é–±–∞—è –æ—à–∏–±–∫–∞, –≤—ã–±—Ä–æ—à–µ–Ω–Ω–∞—è –≤ –±–ª–æ–∫–µ

Rails –ª–æ–≤–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è.

---

## üß¨ –í–ª–æ–∂–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

```ruby
ActiveRecord::Base.transaction do
  user.update!(name: "Outer")

  ActiveRecord::Base.transaction(requires_new: true) do
    user.update!(name: "Inner")
  end
end
```

–ï—Å–ª–∏ `requires_new: true` ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è **savepoint**. –ú–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤–ª–æ–∂–µ–Ω–Ω—É—é —á–∞—Å—Ç—å.

---

## üò± –ê –µ—Å–ª–∏ –±–µ–∑ `requires_new`?

Rails –Ω–µ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é. –û—à–∏–±–∫–∞ –≤–æ –≤–ª–æ–∂–µ–Ω–Ω–æ–º –±–ª–æ–∫–µ –æ—Ç–∫–∞—Ç–∏—Ç **–≤—Å—é –≤–Ω–µ—à–Ω—é—é** —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.

```ruby
ActiveRecord::Base.transaction do
  # ...

  ActiveRecord::Base.transaction do
    raise "Boom"
  end
end
# => –≤—Å—ë –æ—Ç–∫–∞—Ç–∏—Ç—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ outer —á–∞—Å—Ç—å –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–∞
```

---

## üß† PostgreSQL –∏ savepoint

* PostgreSQL **–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç savepoints**
* Rails –¥–µ–ª–∞–µ—Ç `SAVEPOINT` –∏ `ROLLBACK TO SAVEPOINT` –ø—Ä–∏ `requires_new: true`
* –í –ª–æ–≥–∞—Ö –ë–î —ç—Ç–æ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å

---

## ‚ö†Ô∏è –°–æ–≤–µ—Ç—ã

* –ù–µ –≥–Ω–µ–∑–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–µ–∑ `requires_new`, –µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—à–∏–±–∫–∞
* –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `!` –º–µ—Ç–æ–¥—ã (`update!`, `create!`), —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å silent fail
* –ï—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å email –∏–ª–∏ –ø—É—à–∏—à—å –≤ –æ—á–µ—Ä–µ–¥—å ‚Äî **–Ω–µ –¥–µ–ª–∞–π —ç—Ç–æ –¥–æ –∫–æ–º–º–∏—Ç–∞!**
