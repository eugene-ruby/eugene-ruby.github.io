---
layout: post
subtitle: <div id="terminal"></div>
title:  "Pundit –∏ CanCanCan: –±–æ—Ä—å–±–∞ –∑–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –±–µ–∑ –±–æ–ª–∏"
date:   2024-09-18 12:00:00 +0300
rate: 2
tags: Ruby on Rails,–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è,–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å,PostgreSQL,–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
version: A9X
categories:
  - gems
  - rails
hero_image: /images/ruby.jpg
hero_darken: true
toc: true
menubar_toc: true
---
–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö ‚Äî —ç—Ç–æ –∫–∞–∫ –æ—Ö—Ä–∞–Ω–∞ –≤ –Ω–æ—á–Ω–æ–º –∫–ª—É–±–µ: –µ—Å–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç –Ω–µ —Ç–æ–≥–æ, –±—É–¥–µ—Ç —Å–∫–∞–Ω–¥–∞–ª, –∞ –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∞—è ‚Äî –Ω–∏–∫—Ç–æ –Ω–µ –≤–æ–π–¥—ë—Ç. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º –¥–≤–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ ‚Äî **Pundit** –∏ **CanCanCan** ‚Äî –∏ –≤—ã—è—Å–Ω–∏–º, –∫–æ–≥–¥–∞ –∫–∞–∫–æ–π –≤—ã–±—Ä–∞—Ç—å, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –∫–æ–¥ –≤ –∫—Ä–µ–ø–æ—Å—Ç—å —Å –∫–æ–ª—é—á–µ–π –ø—Ä–æ–≤–æ–ª–æ–∫–æ–π.

---

## üß† –¢–µ–æ—Ä–∏—è: Pundit vs CanCanCan ‚Äî –≤ —á—ë–º —Ä–∞–∑–Ω–∏—Ü–∞?

–û–±–∞ –≥–µ–º–∞ —Ä–µ—à–∞—é—Ç –æ–¥–Ω—É –∑–∞–¥–∞—á—É: **"–ú–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–¥–µ–ª–∞—Ç—å X?"**, –Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç –∫ –Ω–µ–π —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω.

| –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å          | CanCanCan                          | Pundit                             |
|----------------------|------------------------------------|------------------------------------|
| **–ü–æ–¥—Ö–æ–¥**           | –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π (Ability-–∫–ª–∞—Å—Å)   | –î–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π (Policy-–∫–ª–∞—Å—Å—ã) |
| **–ì–¥–µ –∂–∏–≤—É—Ç –ø—Ä–∞–≤–∏–ª–∞**| –û–¥–∏–Ω —Ñ–∞–π–ª `ability.rb`             | –ú–Ω–æ–∂–µ—Å—Ç–≤–æ `*_policy.rb`            |
| **–°–∏–Ω—Ç–∞–∫—Å–∏—Å**        | `can :read, Project`               | `policy(@project).read?`           |
| **–ì–∏–±–∫–æ—Å—Ç—å**         | –£–º–µ—Ä–µ–Ω–Ω–∞—è                          | –í—ã—Å–æ–∫–∞—è                            |

**CanCanCan** –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç —à–≤–µ–π—Ü–∞—Ä—Å–∫–∏–π –Ω–æ–∂ ‚Äî –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ. **Pundit** ‚Äî —ç—Ç–æ –º–æ–¥—É–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –≥–¥–µ –∫–∞–∂–¥–∞—è —Å—É—â–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ—é "–ø–æ–ª–∏—Ç–∏–∫—É".

---

## üîß CanCanCan: –ø—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–µ–º:

```ruby
# Gemfile
gem 'cancancan'
```

–°–æ–∑–¥–∞—ë–º Ability-–∫–ª–∞—Å—Å:

```ruby
# app/models/ability.rb
class Ability
  include CanCan::Ability

  def initialize(user)
    user ||= User.new # –≥–æ—Å—Ç—å

    if user.admin?
      can :manage, :all
    else
      can :read, Project, public: true
      can :manage, Project, user_id: user.id
    end
  end
end
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ:

```ruby
class ProjectsController < ApplicationController
  load_and_authorize_resource # –º–∞–≥–∏—è!

  def show
    # @project —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
  end
end
```

---

## üîß Pundit: –ø—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–µ–º:

```ruby
# Gemfile
gem 'pundit'
```

–ü–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞:

```ruby
# app/policies/project_policy.rb
class ProjectPolicy
  attr_reader :user, :project

  def initialize(user, project)
    @user = user
    @project = project
  end

  def read?
    project.public? || user.admin? || project.user == user
  end
end
```

–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä:

```ruby
class ProjectsController < ApplicationController
  include Pundit::Authorization

  def show
    @project = Project.find(params[:id])
    authorize @project, :read?
  end
end
```

---

## üí° –ö–æ–≥–¥–∞ —á—Ç–æ –≤—ã–±—Ä–∞—Ç—å?

### CanCanCan –ø–æ–¥—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏:
- –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—Å—Ç—ã–µ –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω—ã
- –•–æ—á–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö
- –ù—É–∂–Ω–∞ "–∏–∑ –∫–æ—Ä–æ–±–∫–∏" –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Rails Admin

### Pundit –≤—ã—Ä—É—á–∞–µ—Ç, –∫–æ–≥–¥–∞:
- –ü—Ä–∞–≤–∏–ª–∞ —Å–ª–æ–∂–Ω—ã–µ –∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–Ω–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ–± –æ—à–∏–±–∫–∞—Ö
- –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: CanCanCan vs Pundit

**CanCanCan (RSpec):**

```ruby
describe Ability do
  it "—Ä–∞–∑—Ä–µ—à–∞–µ—Ç –∞–¥–º–∏–Ω—É –≤—Å—ë" do
    admin = build(:user, admin: true)
    ability = Ability.new(admin)
    expect(ability).to be_able_to(:manage, :all)
  end
end
```

**Pundit (RSpec):**

```ruby
describe ProjectPolicy do
  let(:user) { build(:user) }
  let(:project) { build(:project, user: user) }

  it "—Ä–∞–∑—Ä–µ—à–∞–µ—Ç —á—Ç–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É" do
    expect(ProjectPolicy.new(user, project).to permit_action(:read?)
  end
end
```

Pundit –∑–¥–µ—Å—å –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç –∑–∞ —Å—á—ë—Ç —è–≤–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤.

---

## üî• –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã

### –î–ª—è CanCanCan:
1. **Ability-–º–æ–Ω—Å—Ç—Ä** (500+ —Å—Ç—Ä–æ–∫ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ)
2. **–ú–∞–≥–∏—á–µ—Å–∫–∏–µ —É—Å–ª–æ–≤–∏—è** (`can :update, Project, { tasks: { assignee_id: user.id } }`)
3. **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞** (–∫–æ–≥–¥–∞ `cannot :manage, :all` –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å—ë)

### –î–ª—è Pundit:
1. **Policy-—Å–ø–∞–≥–µ—Ç—Ç–∏** (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –º–µ–∂–¥—É –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏)
2. **–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–Ω—ã–π —Ö–∞–æ—Å** (—Ä—É—á–Ω—ã–µ `authorize` –≤ –∫–∞–∂–¥–æ–º –º–µ—Ç–æ–¥–µ)
3. **–ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ-–∫–æ—Å—Ç—ã–ª—å** (–∫–æ–≥–¥–∞ `AdminPolicy < UserPolicy` –∑–∞–ø—É—Ç—ã–≤–∞–µ—Ç –≤—Å—ë)

---

## üé§ –ß—Ç–æ —Å–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏

> ‚Äî –ü–æ—á–µ–º—É –≤—ã –≤—ã–±—Ä–∞–ª–∏ Pundit, –∞ –Ω–µ CanCanCan?

‚Äî –í –Ω–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –±—ã–ª–∏ —Ç–µ—Å–Ω–æ —Å–≤—è–∑–∞–Ω—ã —Å –±–∏–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ—Å—Ç—É–ø –∫ —á–µ—Ä–Ω–æ–≤–∏–∫–∞–º —Å—Ç–∞—Ç–µ–π –∑–∞–≤–∏—Å–µ–ª –æ—Ç 5+ —Ñ–∞–∫—Ç–æ—Ä–æ–≤). Pundit –ø–æ–∑–≤–æ–ª–∏–ª —Ä–∞–∑–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É –ø–æ –¥–æ–º–µ–Ω–Ω—ã–º –æ–±—ä–µ–∫—Ç–∞–º –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—ë –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ.

---

## üßæ –í—ã–≤–æ–¥

**CanCanCan** ‚Äî —ç—Ç–æ "–±—ã—Å—Ç—Ä–æ –∏ –ø—Ä–æ—Å—Ç–æ" –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤. **Pundit** ‚Äî "–≥–∏–±–∫–æ –∏ —è–≤–Ω–æ" –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º. 

–í—ã–±–∏—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π, –µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π. –í—Ç–æ—Ä–æ–π ‚Äî –∫–æ–≥–¥–∞ "–º–æ–∂–Ω–æ –ª–∏?" –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞, –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ –∏ —Ñ–∞–∑—ã –ª—É–Ω—ã. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –¥–∞–∂–µ –≤—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ –ø–æ–ª–≥–æ–¥–∞.
