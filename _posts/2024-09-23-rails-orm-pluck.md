---
layout: post
subtitle: <div id="terminal"></div>
title:  "ActiveRecord: select, pluck –∏ .ids ‚Äî –∫–∞–∫ –Ω–µ —É—Ä–æ–Ω–∏—Ç—å –±–∞–∑—É"
date:   2024-10-23 10:30:00 +0300
rate: 3
tags: Rails,PostgreSQL,ActiveRecord,–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤,pluck,select
version: A49X3
categories:
  - rails
toc: true
menubar_toc: true
hero_image: /images/rails.jpg
hero_darken: true
---
–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Rails ‚Äî –∫–ª—é—á–µ–≤–æ–π –Ω–∞–≤—ã–∫ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Å PostgreSQL. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º —Ç–æ–Ω–∫–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `pluck`, `select` –∏ `ids` –≤ ActiveRecord, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ –Ω–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –£–∑–Ω–∞–µ–º, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ SQL, –∞ –Ω–µ –≤ Ruby, –∏ –∫–æ–≥–¥–∞ –∫–∞–∂–¥—ã–π –∏–∑ –º–µ—Ç–æ–¥–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω.

---
–ò–Ω–æ–≥–¥–∞ `pluck` —Å–ø–∞—Å–∞–µ—Ç –æ—Ç N+1. –ò–Ω–æ–≥–¥–∞ ‚Äî –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç `SELECT` –≤ RAM-–∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å.
–†–∞–∑–±–µ—Ä—ë–º—Å—è, –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `.select(:id)`, `.pluck(:id)` –∏ `.ids`, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É.

---

## üß® –ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:

```ruby
Post.where(user_id: User.active.pluck(:id))
```

–ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äî **100\_000**, —Ç–æ `pluck(:id)` —Å–Ω–∞—á–∞–ª–∞ –≤—ã–≥—Ä—É–∑–∏—Ç –≤—Å–µ ID –≤ Ruby, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –≤—Å—Ç–∞–≤–∏—Ç –∏—Ö –≤ `WHERE ... IN (...)`.

üîé SQL:

```sql
SELECT "id" FROM "users" WHERE "active" = TRUE;
-- –ê –ø–æ—Ç–æ–º:
SELECT * FROM "posts" WHERE "user_id" IN (1, 2, 3, ..., 100000);
```

üôÄ –û–≥—Ä–æ–º–Ω—ã–π —Å–ø–∏—Å–æ–∫ ID —Å–æ–∑–¥–∞—ë—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞:

* –°–µ—Ç—å (–µ—Å–ª–∏ –±–∞–∑–∞ —É–¥–∞–ª—ë–Ω–Ω–∞—è)
* –ü–∞—Ä—Å–∏–Ω–≥ SQL –≤ PostgreSQL (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –¥–ª–∏–Ω—É –∑–∞–ø—Ä–æ—Å–∞)
* –ü–∞–º—è—Ç—å –Ω–∞ Ruby-—Å—Ç–æ—Ä–æ–Ω–µ

---

## ‚úÖ –ö–∞–∫ –ª—É—á—à–µ:

```ruby
Post.where(user_id: User.active.select(:id))
```

üîé SQL:

```sql
SELECT * FROM "posts" WHERE "user_id" IN (
  SELECT "id" FROM "users" WHERE "active" = TRUE
);
```

‚úÖ –í—Å—ë –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–∞–∑—ã**. –ë–µ–∑ –ø–µ—Ä–µ–¥–∞—á–∏ –º–∞—Å—Å–∏–≤–æ–≤. –ë–µ–∑ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –ø–∞–º—è—Ç–∏.

---

## üì¶ –ê .ids?

```ruby
User.active.ids
```

–¢–æ –∂–µ —Å–∞–º–æ–µ, —á—Ç–æ `.pluck(:id)`, –Ω–æ **–Ω–µ–º–Ω–æ–≥–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `id`, –∏ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –º–∞—Å—Å–∏–≤ –º–æ–¥–µ–ª–µ–π.

> –ù–æ –≤—Å—ë —Ä–∞–≤–Ω–æ ‚Äî —ç—Ç–æ Ruby-–º–∞—Å—Å–∏–≤. –ù–µ –ø—Ä–∏–º–µ–Ω—è–π `.ids` –≤ `where(... IN (...))`, –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–Ω–æ–≥–æ.

---

## üìå –†–µ–∑—é–º–µ

| –ú–µ—Ç–æ–¥         | –ì–¥–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è   | –†–∏—Å–∫–∏ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –≤—ã–±–æ—Ä–∫–∞—Ö |
| ------------- | --------------- | -------------------------- |
| `pluck(:id)`  | Ruby            | –î–∞                         |
| `select(:id)` | SQL (–≤–ª–æ–∂–µ–Ω–Ω—ã–π) | –ù–µ—Ç                        |
| `ids`         | Ruby            | –î–∞                         |

üß† –í—Å–µ–≥–¥–∞ –¥—É–º–∞–π: **–≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è?**
–ï—Å–ª–∏ –≤ Ruby ‚Äî –∂–¥–∏ –±–µ–¥—É. –ï—Å–ª–∏ –≤ SQL ‚Äî –±—É–¥–µ—Ç —Å—á–∞—Å—Ç—å–µ.
