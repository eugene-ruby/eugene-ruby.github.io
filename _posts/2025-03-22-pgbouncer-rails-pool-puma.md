---
layout: post
subtitle: <div id="terminal"></div>
title: "PgBouncer, Puma –∏ Rails ‚Äî –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –ø—É–ª—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ"
date: 2025-03-22 18:00:00 +0300
rate: 4
tags: Ruby,PostgreSQL,Rails,DevOps,Puma,PgBouncer
version: A49X3
categories:
  - postgres
  - rails
toc: true
menubar_toc: true
hero_image: /images/rails.jpg
hero_darken: true
---
Ruby, PostgreSQL –∏ Rails ‚Äî –º–æ—â–Ω—ã–π —Å—Ç–µ–∫ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –Ω–æ –±–µ–∑ –≥—Ä–∞–º–æ—Ç–Ω–æ–≥–æ DevOps-–ø–æ–¥—Ö–æ–¥–∞ –¥–∞–∂–µ –æ–ø—ã—Ç–Ω—ã–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–≥—É—Ç —Å—Ç–æ–ª–∫–Ω—É—Ç—å—Å—è —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä–µ–º –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö, –ø—É–ª–µ—Ä–∞–º–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å—é, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –∏–∑–±–µ–∂–∞—Ç—å —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ. –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ —É–¥–µ–ª–∏–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—é Puma, ActiveRecord –∏ PgBouncer ‚Äî —Ç—Ä–∏–æ, –∫–æ—Ç–æ—Ä–æ–µ —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–Ω–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π.

---

## üß† TL;DR

–ï—Å–ª–∏ —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å PgBouncer —Å Rails, –∏ —É —Ç–µ–±—è Puma –≤ —Ä–µ–∂–∏–º–µ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏ ‚Äî  
**–≤–Ω–∏–º–∞–Ω–∏–µ: ActiveRecord –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π!**

---

## üîÅ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ Puma?

Puma –∑–∞–ø—É—Å–∫–∞–µ—Ç *–Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤*, –∫–∞–∂–¥—ã–π –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å.  
–í–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ ‚Äî *–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤* (–ø–æ `threads` –≤ `puma.rb`).

–ò –∫–∞–∂–¥—ã–π **–ø–æ—Ç–æ–∫** –º–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –ë–î —á–µ—Ä–µ–∑ ActiveRecord.

---

## üßÆ –°–∫–æ–ª—å–∫–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –±—É–¥–µ—Ç?

–§–æ—Ä–º—É–ª–∞ –ø—Ä–æ—Å—Ç–∞—è:

```text
connection_count = workers * max_threads
````

–î–æ–ø—É—Å—Ç–∏–º:

```ruby
workers 4
threads 1, 8
```

–¢–æ–≥–¥–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ ‚Äî 4 √ó 8 = **32** —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ PgBouncer *–æ—Ç Rails*.

---

## üß© –ê PgBouncer –Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è?

PgBouncer –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ —Ä–µ–∂–∏–º–µ `session` ‚Äî –∏ —ç—Ç–æ –ø–ª–æ—Ö–æ.

–ö–∞–∂–¥–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–∑ Rails ‚Üí –¥–µ—Ä–∂–∏—Ç—Å—è –∑–∞ backend –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–∫–ª—é—á–∏—Ç—Å—è.
–ê Puma –Ω–µ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è ‚Äî —ç—Ç–æ long-lived –ø—Ä–æ—Ü–µ—Å—Å—ã.

---

## ü©π –ß—Ç–æ –¥–µ–ª–∞—Ç—å?

1. –ü–µ—Ä–µ–∫–ª—é—á–∏ PgBouncer –≤ —Ä–µ–∂–∏–º `transaction`:

```ini
pool_mode = transaction
```

–¢–µ–ø–µ—Ä—å backend —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞.

2. –í `database.yml` –¥–æ–±–∞–≤—å:

```yaml
production:
  adapter: postgresql
  ...
  variables:
    application_name: myapp
  prepared_statements: false
```

‚ö†Ô∏è `prepared_statements: false` ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –∏–Ω–∞—á–µ PostgreSQL –≤—ã–¥–∞—Å—Ç –æ—à–∏–±–∫–∏.

---

## üìâ –ê —á—Ç–æ –µ—Å–ª–∏ –Ω–µ –æ—Ç–∫–ª—é—á–∏—Ç—å?

ActiveRecord –±—É–¥–µ—Ç –¥—É–º–∞—Ç—å, —á—Ç–æ –¥–µ—Ä–∂–∏—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–æ–ª–≥–æ ‚Äî
–∞ PgBouncer –æ—Ç–¥–∞—Å—Ç –µ–≥–æ –¥—Ä—É–≥–æ–º—É ‚Äî
–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ `server closed the connection unexpectedly`.

---

## üí° –í—ã–≤–æ–¥

–ï—Å–ª–∏ —É —Ç–µ–±—è PgBouncer –∏ Puma ‚Äî
**–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–±–µ—Ä–∏, –∫–∞–∫ –∏ –≥–¥–µ —Ä–∞–±–æ—Ç–∞—é—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è**.

* `pool_mode = transaction`
* `prepared_statements = false`
* `max connections = workers * threads`
* `PgBouncer pool_size ‚â• sum of all clients per DB`
