---
layout: post
subtitle: <div id="terminal"></div>
title:  "ActiveRecord: joins, includes –∏ preload ‚Äî –∫—Ç–æ –µ—Å—Ç—å –∫—Ç–æ?"
date:   2024-10-23 10:30:00 +0300
rate: 3
tags: Rails,ActiveRecord,PostgreSQL,–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è,–∑–∞–ø—Ä–æ—Å—ã,N+1
version: A49X3
categories:
  - orm
  - rails
toc: true
menubar_toc: true
hero_image: /images/rails.jpg
hero_darken: true
---
–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Rails ‚Äî –∫–ª—é—á–µ–≤–æ–π –Ω–∞–≤—ã–∫ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Å PostgreSQL. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–∏—Ä–∞–µ–º—Å—è, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã ActiveRecord (`joins`, `includes`, `preload`, `eager_load`), —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ N+1 –∑–∞–ø—Ä–æ—Å–∞–º–∏.

---
–ö–æ–≥–¥–∞ –∑–∞–ø—Ä–æ—Å—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω—ã–º–∏, –∞ –ª–æ–≥ —Ä–∞—Å—Ç–µ—Ç –Ω–∞ –¥–µ—Å—è—Ç–∫–∏ —Å—Ç—Ä–æ–∫ ‚Äî –ø–æ—Ä–∞ —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è, —á–µ–º –æ—Ç–ª–∏—á–∞—é—Ç—Å—è `joins`, `includes` –∏ `preload` –≤ ActiveRecord.

---

## ü§ù joins

–°–æ–∑–¥–∞—ë—Ç SQL JOIN, –Ω–æ **–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –ø–∞–º—è—Ç—å**.

```ruby
User.joins(:company).where(companies: { active: true })
```

üîé SQL:

```sql
SELECT "users".* FROM "users"
INNER JOIN "companies" ON "companies"."id" = "users"."company_id"
WHERE "companies"."active" = TRUE
```

* –†–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–æ
* –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—è–º
* –ù–æ `user.company` –≤—ã–∑–æ–≤–µ—Ç **–¥–æ–ø. –∑–∞–ø—Ä–æ—Å**

---

## üì¶ includes

–ü–æ–¥–≥—Ä—É–∂–∞–µ—Ç –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å N+1:

```ruby
User.includes(:company).each { |u| puts u.company.name }
```

üîé SQL:

```sql
SELECT "users".* FROM "users";
SELECT "companies".* FROM "companies" WHERE "companies"."id" IN (...)
```

ActiveRecord **—Ä–µ—à–∞–µ—Ç —Å–∞–º**, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ `JOIN` –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π `SELECT`. –ò–Ω–æ–≥–¥–∞ —ç—Ç–æ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ `eager_load`.

---

## üöö preload

–ó–∞—Å—Ç–∞–≤–ª—è–µ—Ç ActiveRecord –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ **–æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å**:

```ruby
User.preload(:company)
```

üîé SQL:

```sql
SELECT "users".* FROM "users";
SELECT "companies".* FROM "companies" WHERE "companies"."id" IN (...)
```

* –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–µ–ª–∞–µ—Ç JOIN
* –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ

---

## üîç eager\_load

–≠—Ç–æ `includes` + `JOIN`, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —É—Å–ª–æ–≤–∏–π:

```ruby
User.eager_load(:company).where(companies: { name: "Acme" })
```

üîé SQL:

```sql
SELECT "users"."id" AS t0_r0, "users"."name" AS t0_r1, ..., 
       "companies"."id" AS t1_r0, "companies"."name" AS t1_r1, ... 
FROM "users"
LEFT OUTER JOIN "companies" ON "companies"."id" = "users"."company_id"
WHERE "companies"."name" = 'Acme'
```

* –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å—Ä–∞–∑—É
* –í—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ `SELECT ... LEFT OUTER JOIN`

---

## üí° –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —á—Ç–æ

| –ó–∞–¥–∞—á–∞                                | –ú–µ—Ç–æ–¥                    |
| ------------------------------------- | ------------------------ |
| –ù—É–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –ø–æ–ª—è–º –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ | `joins`                  |
| –ù—É–∂–Ω–æ –∏–∑–±–µ–∂–∞—Ç—å N+1                    | `includes` –∏–ª–∏ `preload` |
| –ù—É–∂–Ω–æ –≤—Å—ë –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ             | `eager_load`             |
| –ù—É–∂–Ω–æ 100% –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ               | `preload`                |

üîö **–í—ã–≤–æ–¥**: –µ—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—à—å —Å—é—Ä–ø—Ä–∏–∑–æ–≤ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π `preload`. –ê `joins` ‚Äî —Ç–≤–æ–π –¥—Ä—É–≥, –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω SQL-–∫–æ–Ω—Ç—Ä–æ–ª—å.
