---
layout: post
subtitle: <div id="terminal"></div>
title:  "Ruby: Enumerator, Lazy, Fiber ‚Äî –∏—Å–∫—É—Å—Å—Ç–≤–æ –Ω–µ –¥–µ–ª–∞—Ç—å –ª–∏—à–Ω–µ–≥–æ"
date:   2023-04-05 13:00:00 +0300
rate: 5
tags: Ruby,–∏—Ç–µ—Ä–∞—Ç–æ—Ä—ã,Enumerator,Lazy,Fiber,–ª–µ–Ω–∏–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
version: 3.2.2
categories:
  - ruby
toc: true
menubar_toc: true
hero_image: /images/posts/10.jpg
hero_darken: true
---
–ò—Ç–µ—Ä–∞—Ç–æ—Ä—ã –≤ Ruby ‚Äî –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –≤—ã—Ö–æ–¥—è—â–∏–π –¥–∞–ª–µ–∫–æ –∑–∞ —Ä–∞–º–∫–∏ –ø—Ä–æ—Å—Ç–æ–≥–æ `each`. –í —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç `Enumerator`, `Lazy` –∏ `Fiber` –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º, –ø–æ—á–µ–º—É –ª–µ–Ω–∏–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —ç–∫–æ–Ω–æ–º—è—Ç –ø–∞–º—è—Ç—å –∏ –∫–∞–∫ —ç—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö. –í—ã —É–∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–æ–ª—å—à–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–∏—Å–∞—Ç—å –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–¥ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π.

---

## ü™ú –ß—Ç–æ —Ç–∞–∫–æ–µ Enumerator?

```ruby
enum = [1, 2, 3].each
puts enum.class # => Enumerator

enum.each { |x| puts x }
````

`Enumerator` ‚Äî —ç—Ç–æ –ª–µ–Ω–∏–≤—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ:

* —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é,
* –∏—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é,
* –ø–µ—Ä–µ–¥–∞—Ç—å –∫—É–¥–∞ —É–≥–æ–¥–Ω–æ.

---

## üßÉ `Enumerator::Lazy`

```ruby
lazy = (1..Float::INFINITY).lazy
        .select(&:even?)
        .map { |x| x * 10 }

puts lazy.first(5) # => [20, 40, 60, 80, 100]
```

**–õ–µ–Ω–∏–≤—ã–π —Ü–µ–ø–Ω–æ–π –≤—ã–∑–æ–≤** ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏**.
–ë–µ–∑ `.lazy` ‚Äî Ruby –∑–∞–≤–∏—Å –±—ã –Ω–∞ `INFINITY`.

---

## üßµ Fiber ‚Äî –Ω–∏—Ç–æ—á–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```ruby
f = Fiber.new do
  Fiber.yield "–ø–∞—É–∑–∞ 1"
  Fiber.yield "–ø–∞—É–∑–∞ 2"
  "–∑–∞–≤–µ—Ä—à–µ–Ω–æ"
end

puts f.resume  # => –ø–∞—É–∑–∞ 1
puts f.resume  # => –ø–∞—É–∑–∞ 2
puts f.resume  # => –∑–∞–≤–µ—Ä—à–µ–Ω–æ
```

**Fiber** ‚Äî —ç—Ç–æ –º–∏–Ω–∏-–∫–æ—Ä—É—Ç–∏–Ω–∞: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ `Enumerator`, `Lazy`, –∏ –¥–∞–∂–µ `Rails` (ActionCable).

---

## üß¨ Enumerator.create

```ruby
e = Enumerator.new do |yielder|
  yielder << 1
  yielder << 2
  yielder << 3
end

puts e.to_a # => [1, 2, 3]
```

`yielder` ‚Äî –æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ `Enumerator::Yielder`, –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—Ä—É—á–Ω—É—é –æ—Ç–¥–∞–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è.

---

## üìå –°—Ä–∞–≤–Ω–µ–Ω–∏–µ

| –ß—Ç–æ          | –õ–µ–Ω–∏–≤—ã–π? | –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ? | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ               |
| ------------ | -------- | -------------------- | ------------------------ |
| `each`       | –Ω–µ—Ç      | –Ω–µ—Ç                  | –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤             |
| `Enumerator` | –¥–∞       | –¥–∞                   | –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã, –∏—Ç–µ—Ä–∞—Ç–æ—Ä—ã    |
| `Lazy`       | –¥–∞       | –¥–∞                   | –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏    |
| `Fiber`      | –¥–∞       | –¥–∞                   | –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è |

---

## üß® –í–æ–ø—Ä–æ—Å –Ω–∞ —Å–æ–±–µ—Å–µ

```ruby
enum = Enumerator.new do |y|
  3.times { |i| y << i }
end

puts enum.next  # => ?
puts enum.next  # => ?
puts enum.next  # => ?
puts enum.next  # => ?
```

**–û—Ç–≤–µ—Ç:**

```
0
1
2
StopIteration (–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º –≤—ã–∑–æ–≤–µ)
```

---

## üß† –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?

* **Enumerator** –¥–∞—ë—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å: –º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å, –ø–µ—Ä–µ–¥–∞—Ç—å.
* **Lazy** –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–æ–ª—å—à–∏–µ (–∏–ª–∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ) –∫–æ–ª–ª–µ–∫—Ü–∏–∏.
* **Fiber** ‚Äî –±–∞–∑–∞ –¥–ª—è –∫–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Å–µ—Ç–µ–≤—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ö –∏–ª–∏ `async`-–¥–∂–µ–º–∞—Ö).

---

## üí° –ü—Ä–∏–º–µ—Ä: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–æ–≥–æ CSV –ª–µ–Ω–∏–≤–æ

```ruby
require 'csv'

File.open("big.csv") do |file|
  csv_enum = Enumerator.new do |y|
    file.each_line do |line|
      y << CSV.parse_line(line)
    end
  end

  csv_enum.lazy.select { |row| row[1] == "admin" }
          .first(10)
end
```

–ù–∏—á–µ–≥–æ –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç—å –∑–∞—Ä–∞–Ω–µ–µ. –í—Å—ë –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ –∑–∞–ø—Ä–æ—Å—É.

---

üîö **–í—ã–≤–æ–¥:**
Ruby —É–º–µ–µ—Ç –±—ã—Ç—å –ª–µ–Ω–∏–≤—ã–º ‚Äî –∏ —ç—Ç–æ —Ö–æ—Ä–æ—à–æ. –ü–æ–Ω–∏–º–∞–Ω–∏–µ `Enumerator`, `Lazy` –∏ `Fiber` –æ—Ç–ª–∏—á–∞–µ—Ç –∫–æ–¥–µ—Ä–∞ –æ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–∞. –ù–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏ ‚Äî –ø–æ–∫–∞–∂–∏, —á—Ç–æ –∑–Ω–∞–µ—à—å, –∫–æ–≥–¥–∞ –Ω–µ –Ω–∞–¥–æ –¥–µ–ª–∞—Ç—å `each`.
