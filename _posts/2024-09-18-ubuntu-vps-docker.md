---
layout: post
subtitle: <div id="terminal"></div>
title: "–ú–æ–π –ø–µ—Ä–≤—ã–π Pet + VPS: –û–ø–ª–∞—Ç–∏–ª —Å–µ—Ä–≤–µ—Ä, –µ—Å—Ç—å SSH ‚Äî –∞ —á—Ç–æ –¥–∞–ª—å—à–µ? –õ–∞–π—Ç-–≥–∞–π–¥ –ø–æ Ubuntu –¥–ª—è Docker"
date: 2024-09-18 12:00:00 +0300
rate: 1
tags: Ubuntu, Docker, VPS, pet
version: 3.2.2
categories:
  - pet
  - devops
hero_image: /images/posts/28.jpg
hero_darken: true
toc: true
menubar_toc: true
---
–í—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ —Å–≤–æ–µ–º—É –ø–µ—Ä–≤–æ–º—É VPS –Ω–∞ Ubuntu 24.04 ‚Äî –∏ —Ç–µ–ø–µ—Ä—å —Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ —á—ë—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ —Å —á—É–≤—Å—Ç–≤–æ–º, –±—É–¥—Ç–æ –æ—Ç–∫—Ä—ã–ª–∏ –¥–≤–µ—Ä—å –≤ –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π –∫–æ—Ä–∞–±–ª—å. –ù–µ –≤–æ–ª–Ω—É–π—Ç–µ—Å—å! –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –º—ã —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –≥–æ–ª—ã–π Ubuntu-—Å–µ—Ä–≤–µ—Ä –≤ –≥–æ—Ç–æ–≤—É—é –ø–ª–æ—â–∞–¥–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å Ruby on Rails –∏ PostgreSQL.

---

## üöÄ –®–∞–≥ 1: –ü–µ—Ä–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞

–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ SSH:
```bash
ssh root@–≤–∞—à_ip
```

**–ß—Ç–æ —Å—Ä–∞–∑—É —Å–¥–µ–ª–∞—Ç—å:**

1. **–û–±–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç—ã** (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å "—É –º–µ–Ω—è –Ω–∞ –ª–æ–∫–∞–ª–µ —Ä–∞–±–æ—Ç–∞–ª–æ!"):
   ```bash
   apt update && apt upgrade -y
   ```

2. **–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç root ‚Äî –∫–∞–∫ —Ä–µ–∑–∞—Ç—å —Ö–ª–µ–± –±–µ–Ω–∑–æ–ø–∏–ª–æ–π):
   ```bash
   adduser deploy
   usermod -aG sudo deploy  # –î–∞—ë–º –ø—Ä–∞–≤–∞ sudo
   ```
---

## üê≥ –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∏ Docker Compose

**–î–ª—è Ubuntu 24.04**:
```bash
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker
apt install -y docker.io

# –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker
usermod -aG docker deploy

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
```

–ü—Ä–æ–≤–µ—Ä—è–µ–º:
```bash
docker --version
docker-compose --version
```

---

## üõ†Ô∏è –®–∞–≥ 3: –õ–∞–π—Ç-–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è Docker

1. **–õ–∏–º–∏—Ç—ã –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤** (—á—Ç–æ–±—ã –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Å–æ–∂—Ä–∞–ª –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã):
   ```bash
   nano /etc/docker/daemon.json
   ```
   –î–æ–±–∞–≤–ª—è–µ–º:

   ```json
   {
     "default-ulimits": {
       "nofile": {
         "Name": "nofile",
         "Hard": 65536,
         "Soft": 65536
       }
     },
     "log-driver": "json-file",
     "log-opts": {
       "max-size": "10m",
       "max-file": "3"
     }
   }
   ```

üß† **–ß—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

* `nofile` ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —á–∏—Å–ª–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤ (65536).
  üîí –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —É—Ç–µ—á–∫—É –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤, –æ—à–∏–±–∫–∏ `EMFILE`, –æ–±–≤–∞–ª—ã –∏–∑-–∑–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è —Å–æ–∫–µ—Ç–æ–≤ –∏–ª–∏ –ª–æ–≥–æ–≤.

* `log-driver: json-file` ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä –ª–æ–≥–æ–≤ Docker.

* `max-size: 10m` ‚Äî –∫–∞–∂–¥—ã–π log-—Ñ–∞–π–ª –º–∞–∫—Å–∏–º—É–º 10 –º–µ–≥–∞–±–∞–π—Ç.

* `max-file: 3` ‚Äî —Ö—Ä–∞–Ω—è—Ç—Å—è 3 —Ñ–∞–π–ª–∞: –∞–∫—Ç–∏–≤–Ω—ã–π + 2 —Å—Ç–∞—Ä—ã—Ö.

üßØ **–ó–∞—á–µ–º:**
–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ä–æ—Å—Ç –ª–æ–≥–æ–≤, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–±–∏–ª –≤–µ—Å—å –¥–∏—Å–∫ `/var/lib/docker/containers/‚Ä¶/container.log`.

üìå –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º:
   
```bash
   systemctl restart docker
   ```
---

---

## üåê –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: NGINX –∫–∞–∫ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ + HTTPS

–ï—Å–ª–∏ –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å HTTP/HTTPS

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º:

```bash
apt install nginx -y
```

–ë–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π 3000 HTTP –ø–æ—Ä—Ç –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è):

```nginx
server {
    listen 80;
    server_name example.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º:

```bash
ln -s /etc/nginx/sites-available/myapp /etc/nginx/sites-enabled/
nginx -t && systemctl reload nginx
```

---

### üîê Let's Encrypt + Certbot (HTTPS –∑–∞ 1 –º–∏–Ω—É—Ç—É)

```bash
apt install certbot python3-certbot-nginx -y
certbot --nginx -d example.com
```

> üîÅ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ cron-–æ–º!


## üîê –ë–æ–Ω—É—Å: –£—Å–∏–ª–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞

> ‚ö†Ô∏è –ï—Å–ª–∏ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç–µ —á—Ç–æ –¥–∞–ª—å—à–µ –∏ —ç—Ç–æ –≤–∞—à –ø–µ—Ä–≤—ã–π —Å–µ—Ä–≤–µ—Ä, —Ç–æ –ª—É—á—à–µ –Ω–µ –¥–µ–ª–∞–π—Ç–µ

### üö™ –ó–∞—â–∏—Ç–∞ SSH: –Ω–æ–≤—ã–π –ø–æ—Ä—Ç –∏ –∫–ª—é—á–∏ –≤–º–µ—Å—Ç–æ –ø–∞—Ä–æ–ª—è

1. –ò–∑–º–µ–Ω–∏—Ç–µ –ø–æ—Ä—Ç SSH (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ 2222) –∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ –≤—Ö–æ–¥ –ø–æ –ø–∞—Ä–æ–ª—é:
   ```bash
   nano /etc/ssh/sshd_config
   ```

–ó–∞–º–µ–Ω–∏—Ç–µ:

```
Port 2222
PasswordAuthentication no
PermitRootLogin no
```

2. –î–æ–±–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –≤ `~/.ssh/authorized_keys`.

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ SSH:

   ```bash
   systemctl restart sshd
   ```

> üí° –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é ‚Äî —Å–Ω–∞—á–∞–ª–∞ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–æ–≤—ã–π –ø–æ—Ä—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç!

---

### üî• –ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ UFW (—Ñ–∞–µ—Ä–≤–æ–ª)

```bash
ufw allow 2222/tcp     # SSH (–Ω–æ–≤—ã–π –ø–æ—Ä—Ç)
ufw allow 80,443/tcp   # HTTP/HTTPS
ufw enable             # –í–∫–ª—é—á–∞–µ–º —Ñ–∞–µ—Ä–≤–æ–ª
ufw status verbose     # –ü—Ä–æ–≤–µ—Ä–∫–∞
```

> ‚ùó –°–æ–≤–µ—Ç: –æ—Ç–∫—Ä–æ–π —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ—Ä—Ç—ã. –ù–µ–ª—å–∑—è –ø–æ–ø–∞—Å—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä = –Ω–µ–ª—å–∑—è –µ–≥–æ —Å–ø–∞—Å—Ç–∏.

---

### üõ°Ô∏è Fail2Ban ‚Äî –±–∞–Ω–∏–º –±—Ä—É—Ç—Ñ–æ—Ä—Å–µ—Ä–æ–≤

```bash
apt install fail2ban -y
systemctl enable fail2ban --now
```

–≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω IP-–∞–¥—Ä–µ—Å–æ–≤ –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

## üí° –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–æ–≤–∏—á–∫–æ–≤

1. **–†–∞–±–æ—Ç–∞ –æ—Ç root**  
   *–ü—Ä–æ–±–ª–µ–º–∞*: –û–¥–Ω–∞ –æ—à–∏–±–∫–∞ ‚Äî –∏ —Å–µ—Ä–≤–µ—Ä –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ "–∫–∏—Ä–ø–∏—á".  
   *–†–µ—à–µ–Ω–∏–µ*: –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å sudo.
2. **Docker –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤**  
   *–ü—Ä–æ–±–ª–µ–º–∞*: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —É—Ç–µ—á–∫–æ–π –ø–∞–º—è—Ç–∏ –ø–∞—Ä–∞–ª–∏–∑—É–µ—Ç —Å–µ—Ä–≤–µ—Ä.  
   *–†–µ—à–µ–Ω–∏–µ*: `--memory=512m` –≤ `docker run`.

---
 
## üéØ –í—ã–≤–æ–¥

* Docker —Å –±–∞–∑–æ–≤–æ–π –∑–∞—â–∏—Ç–æ–π –∏ –ª–æ–≥-–ª–∏–º–∏—Ç–∞–º–∏
* –ó–∞—â–∏—â—ë–Ω–Ω—ã–π SSH –∏ –±—Ä–∞–Ω–¥–º–∞—É—ç—Ä
* NGINX –∫–∞–∫ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ —Å HTTPS
* –û–ø—Ü–∏–∏ –¥–ª—è fail2ban