---
layout: post
title:  "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ PostgreSQL: SELECT FOR UPDATE –∏ –¥—Ä—É–≥–∏–µ —Å–ø–æ—Å–æ–±—ã –Ω–µ —Å–ª–æ–≤–∏—Ç—å race condition"
date:   2024-12-18 11:30:00 +0300
rate: 4
tags: PostgreSQL,Ruby on Rails,–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏,race condition,Sidekiq,–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø
version: A49X3
categories:
  - orm
  - rails
  - postgres
toc: true
menubar_toc: true
hero_image: /images/rails.jpg
hero_darken: true
---
–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ PostgreSQL ‚Äî –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race condition –ø—Ä–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ –∫ –¥–∞–Ω–Ω—ã–º. –í Ruby on Rails –º–µ—Ç–æ–¥—ã –≤—Ä–æ–¥–µ `lock` –∏ `SELECT FOR UPDATE` –ø–æ–º–æ–≥–∞—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –∑–∞–ø–∏—Å–∏, –∞ advisory locks –ø–æ–∑–≤–æ–ª—è—é—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

---
–£ —Ç–µ–±—è –¥–≤–∞ Sidekiq-–ø–æ—Ç–æ–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è—é—Ç –æ–¥–Ω—É –∑–∞–ø–∏—Å—å? –ò–ª–∏ –≥–æ–Ω–∫–∞ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∑–∞ —Ä–µ—Å—É—Ä—Å—ã? –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.

## üîí SELECT FOR UPDATE

```ruby
User.transaction do
  user = User.lock.find(42)
  user.update!(balance: user.balance - 100)
end
````

–≠—Ç–æ—Ç `lock` —Å–æ–∑–¥–∞—ë—Ç **SELECT ... FOR UPDATE**.
–û–Ω –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–æ –∫–æ–Ω—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ.

---

## üß¨ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

* –õ—é–±–æ–π –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫, –ø–æ–ø—ã—Ç–∞–≤—à–∏–π—Å—è `SELECT ... FOR UPDATE` —Ç—É –∂–µ —Å—Ç—Ä–æ–∫—É, –±—É–¥–µ—Ç –∂–¥–∞—Ç—å
* –ï—Å–ª–∏ –æ–±–µ—Ä–Ω—É—Ç—å –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é ‚Äî –∑–∞—â–∏—â–∞–µ—à—å –æ—Ç race condition
* –†–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏**

---

## ‚ö†Ô∏è –ë–µ–∑ lock ‚Äî –≤–æ–∑–º–æ–∂–Ω—ã –≥–æ–Ω–∫–∏

```ruby
# –ü–æ—Ç–æ–∫ 1
user = User.find(1)
user.balance -= 100
user.save

# –ü–æ—Ç–æ–∫ 2
user = User.find(1)
user.balance -= 100
user.save
```

–ò—Ç–æ–≥: –±–∞–ª–∞–Ω—Å —É–º–µ–Ω—å—à–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ 100, –∞ –¥–æ–ª–∂–µ–Ω –±—ã–ª –Ω–∞ 200 ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–±–∞ —Å—á–∏—Ç–∞–ª–∏ —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

---

## üõ† –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏

```ruby
User.lock("FOR UPDATE SKIP LOCKED")
```

* `SKIP LOCKED` ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –ø—É–ª–µ –∑–∞–¥–∞—á)
* `NOWAIT` ‚Äî –Ω–µ –∂–¥—ë—Ç, —Å—Ä–∞–∑—É –ø–∞–¥–∞–µ—Ç, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞

---

## üß± Advisory locks

–î–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ **–Ω–∞ —É—Ä–æ–≤–Ω–µ –ª–æ–≥–∏–∫–∏**, –∞ –Ω–µ —Å—Ç—Ä–æ–∫:

```ruby
ActiveRecord::Base.connection.execute("SELECT pg_advisory_lock(12345)")
# ... do critical section ...
ActiveRecord::Base.connection.execute("SELECT pg_advisory_unlock(12345)")
```

–†–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏. –û—á–µ–Ω—å –º–æ—â–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º.

---

## ü§ì –ö–∞–∫ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å

```sql
SELECT * FROM pg_locks l
JOIN pg_stat_activity a ON l.pid = a.pid;
```

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫—Ç–æ –∫–æ–≥–æ –¥–µ—Ä–∂–∏—Ç, –∏ –ø–æ—á–µ–º—É –≤—Å—ë –≤—Å—Ç–∞–ª–æ.

---

## üìå –†–µ–∑—é–º–µ

| –ú–µ—Ç–æ–¥                    | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å                      |
| ------------------------ | --------------------------------------- |
| `lock`                   | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏                       |
| `FOR UPDATE SKIP LOCKED` | –ü—É–ª –∑–∞–¥–∞—á, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑ –≥–æ–Ω–æ–∫          |
| `advisory_lock`          | –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–∫–µ—à, cron –∏ –¥—Ä.) |
| `NOWAIT`                 | –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏      |
