---
layout: post
title:  "–ò–Ω–¥–µ–∫—Å—ã –≤ PostgreSQL: –∫–∞–∫–∏–µ –±—ã–≤–∞—é—Ç –∏ –∫–∞–∫ –æ–Ω–∏ –∂–∏–≤—É—Ç –≤ Rails"
date:   2025-02-02 10:30:00 +0300
categories:
  - postgres
  - rails
toc: true
menubar_toc: true
hero_image: /images/rails.jpeg
hero_darken: true
---
–ò–Ω–¥–µ–∫—Å—ã –≤ PostgreSQL ‚Äî —ç—Ç–æ –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤, –Ω–æ –∏—Ö —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞. –í Rails –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å B-tree –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π, GIN –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON –∏ –º–∞—Å—Å–∏–≤–∞–º–∏, GiST –¥–ª—è –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö –∏ BRIN –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü —Å —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏. –†–∞–∑–±–µ—Ä—ë–º—Å—è, –∫–∞–∫ –ø–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–¥–∞—á—É –∏ –∏–∑–±–µ–∂–∞—Ç—å —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫.

–ï—Å–ª–∏ —É —Ç–µ–±—è –≤ –ø—Ä–æ–¥–µ —É–∂–µ –±–æ–ª—å—à–µ 100–ö –∑–∞–ø–∏—Å–µ–π, –∏–Ω–¥–µ–∫—Å—ã ‚Äî —ç—Ç–æ —Ç–≤–æ–π —Å–∞–º—ã–π –≤–µ—Ä–Ω—ã–π –¥—Ä—É–≥.  
–ù–æ –¥—Ä—É–∑—å—è –±—ã–≤–∞—é—Ç —Ä–∞–∑–Ω—ã–µ. –ö—Ç–æ-—Ç–æ –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º (`btree`), –∫—Ç–æ-—Ç–æ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Ç—Ä—É–¥–Ω—É—é –º–∏–Ω—É—Ç—É (`gin`), –∞ –∫—Ç–æ-—Ç–æ –∂–∏–≤—ë—Ç —Ç–∏—Ö–æ –≤ –ø–æ–¥–≤–∞–ª–µ, –ø–æ–∫–∞ –Ω–µ –Ω–∞—Å—Ç—É–ø–∏—Ç –∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å (`brin`).

–†–∞–∑–±–∏—Ä–∞–µ–º—Å—è, **—á—Ç–æ –∑–∞ –∏–Ω–¥–µ–∫—Å—ã** –±—ã–≤–∞—é—Ç –≤ PostgreSQL –∏ **–∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Ö –ø–æ–¥–∫–ª—é—á–∞—Ç—å –≤ Rails**.

---

## üß± `btree`: —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–æ–ª–¥–∞—Ç

–≠—Ç–æ –∏–Ω–¥–µ–∫—Å **–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**, –µ—Å–ª–∏ —Ç—ã –ø–∏—à–µ—à—å:

```ruby
add_index :users, :email
````

PostgreSQL —Å–æ–∑–¥–∞—ë—Ç —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ (B-tree), –≥–¥–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω–æ–π –∫–Ω–∏–≥–µ.

* –†–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ —Å `=`, `<`, `>`, `BETWEEN`
* –û—Ç–ª–∏—á–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `ORDER BY`
* –ë—ã—Å—Ç—Ä—ã–π, –Ω–æ –ø—Ä–∏ –±–æ–ª—å—à–æ–º —Ä–∞–∑–º–µ—Ä–µ ‚Äî –º–æ–∂–µ—Ç —Ä–∞–∑—Ä–∞—Å—Ç–∞—Ç—å—Å—è

üìå Rails –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ 99% —Å–ª—É—á–∞–µ–≤. –û–Ω —Å—Ç–∞–±–∏–ª–µ–Ω –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º, –∫–∞–∫ –¥–µ–¥–æ–≤—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –Ω–∞ Perl.

---

## üå≤ `GIN`: —Å—É–ø–µ—Ä–≥–µ—Ä–æ–π –¥–ª—è JSON –∏ –º–∞—Å—Å–∏–≤–æ–≤

–ï—Å–ª–∏ —Ç—ã –∫–æ–≥–¥–∞-–ª–∏–±–æ –ø–∏—Å–∞–ª:

```ruby
where("metadata @> ?", { status: "ok" }.to_json)
```

...–∏ –ø—Ä–∏ —ç—Ç–æ–º –Ω–µ –¥–æ–±–∞–≤–∏–ª GIN-–∏–Ω–¥–µ–∫—Å ‚Äî –±–∞–∑–∞ –Ω–µ–Ω–∞–≤–∏–¥–∏—Ç —Ç–µ–±—è –º–æ–ª—á–∞.
`GIN` (Generalized Inverted Index) —Å—Ç—Ä–æ–∏—Ç **–æ–±—Ä–∞—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å**, –∫–∞–∫ –ø–æ–∏—Å–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞: ¬´–≤–æ—Ç –∫–ª—é—á ‚Äî –≤–æ—Ç –≥–¥–µ –æ–Ω –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è¬ª.

–ò—Å–ø–æ–ª—å–∑—É–π:

```ruby
add_index :logs, :metadata, using: :gin
```

* –î–ª—è `jsonb`, `ARRAY`, `tsvector`
* –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ –∏—â–µ—Ç –ø–æ –∑–Ω–∞—á–µ–Ω–∏—è–º
* **–ú–µ–¥–ª–µ–Ω–Ω–æ —Å–æ–∑–¥–∞—ë—Ç—Å—è**, –∑–∞—Ç–æ –ø–æ—Ç–æ–º ‚Äî –ª–µ—Ç–∞–µ—Ç

üìå –ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º: –≤–º–µ—Å—Ç–æ –¥–µ—Ä–µ–≤–∞ ‚Äî —Ç–∞–±–ª–∏—Ü–∞ –≤ —Å—Ç–∏–ª–µ "—Å–ª–æ–≤–∞—Ä—å ‚Üí –ø–æ–∑–∏—Ü–∏–∏", –∫–∞–∫ –≤ Google Search.

---

## üåÄ `GiST`: –µ—Å–ª–∏ —É —Ç–µ–±—è PostGIS –∏ —à–ø–∏–æ–Ω—Å–∫–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã

`GiST` –Ω—É–∂–µ–Ω –¥–ª—è **–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤**: –≥–µ–æ-—Ç–æ—á–µ–∫, –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (`int4range`), –¥–µ—Ä–µ–≤—å–µ–≤. –û–Ω –Ω–µ —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π, –Ω–æ **–≥–∏–±–∫–∏–π**.

```ruby
add_index :places, :location, using: :gist
```

* –†–∞–±–æ—Ç–∞–µ—Ç —Å `PostGIS`, `range`, `ltree`
* –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã

üìå –ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ—Ö–æ–∂–∞ –Ω–∞ B-tree, –Ω–æ —Å —Ä–∞—Å—à–∏—Ä—è–µ–º—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏.

---

## üîé `BRIN`: —Å–ø—è—â–∏–π –∞–≥–µ–Ω—Ç

–ï—Å–ª–∏ —É —Ç–µ–±—è —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞ **–º–∏–ª–ª–∏–æ–Ω—ã –∑–∞–ø–∏—Å–µ–π**, –∏ –ø–æ—á—Ç–∏ –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–¥—É—Ç –ø–æ –ø–æ—Ä—è–¥–∫—É (`created_at`, `id`) ‚Äî –∑–æ–≤–∏ BRIN.

```ruby
add_index :events, :created_at, using: :brin
```

BRIN (Block Range INdex) ‚Äî —ç—Ç–æ –∫–∞–∫ –∑–∞–ø–∏—Å–Ω–∞—è –∫–Ω–∏–∂–∫–∞: "–≤ —ç—Ç–æ–º –±–ª–æ–∫–µ —Å—Ç—Ä–æ–∫–∏ —Å `created_at` –æ—Ç A –¥–æ B".

* –ü–æ—á—Ç–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤–µ—Å–∏—Ç
* –ú–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
* –ù–æ **–º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –Ω–µ—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã** (Postgres –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∞–ª—å—à–µ –≤—Ä—É—á–Ω—É—é)

üìå –ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º: –ø—Ä–æ—Å—Ç–æ –∫–∞—Ä—Ç–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –ø–æ –±–ª–æ–∫–∞–º. –ú–∏–Ω–∏–º—É–º –ø–∞–º—è—Ç–∏ ‚Äî –º–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑—ã.

---

## üß† –í—Å—è —Å—É—Ç—å ‚Äî –≤ –≤—ã–±–æ—Ä–µ –ø–æ–¥ –∑–∞–¥–∞—á—É

| –¢–∏–ø    | –õ—É—á—à–µ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ                            |
| ------ | -------------------------------------------- |
| B-tree | `=`, `<`, `>`, `ORDER BY`, `BETWEEN`         |
| GIN    | `jsonb`, `ARRAY`, full-text –ø–æ–∏—Å–∫            |
| GiST   | –≥–µ–æ, –¥–∏–∞–ø–∞–∑–æ–Ω—ã, –¥–µ—Ä–µ–≤—å—è, ltree               |
| BRIN   | –æ–≥—Ä–æ–º–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å –≤–æ–∑—Ä–∞—Å—Ç–∞—é—â–∏–º `created_at` |

---

## üõ†Ô∏è –ö–∞–∫ –≤ Rails?

Rails –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ç–∏–ø—ã:

```ruby
add_index :logs, :metadata, using: :gin
add_index :events, :created_at, using: :brin
```

–ò –¥–∞–∂–µ –Ω–∞ –≤—ã—Ä–∞–∂–µ–Ω–∏—è—Ö:

```ruby
add_index :documents, "to_tsvector('english', content)", using: :gin, name: :idx_fts
```

---

## üí° –ò–Ω–¥–µ–∫—Å—ã ‚â† –º–∞–≥–∏—è. –ü—Ä–æ–≤–µ—Ä—è–π EXPLAIN

–•–æ—á–µ—à—å –ø–æ–Ω—è—Ç—å, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –∏–Ω–¥–µ–∫—Å? –ò—Å–ø–æ–ª—å–∑—É–π:

```sql
EXPLAIN ANALYZE SELECT * FROM logs WHERE metadata @> '{"status": "ok"}';
```

–ò—â–∏ `Index Scan using ...` –≤–º–µ—Å—Ç–æ `Seq Scan`.

---

## üö® –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

* –î–æ–±–∞–≤–∏–ª –∏–Ω–¥–µ–∫—Å, –Ω–æ —Ç–∏–ø –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç ‚ûú `Seq Scan` –≤—Å—ë —Ä–∞–≤–Ω–æ
* –ò—Å–ø–æ–ª—å–∑—É–µ—à—å GIN –±–µ–∑ `jsonb` ‚ûú –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ
* –ù–µ –æ–±–Ω–æ–≤–ª—è–µ—à—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (`ANALYZE`) ‚ûú –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—à–∏–±–∞–µ—Ç—Å—è
* –î—É–º–∞–µ—à—å, —á—Ç–æ –∏–Ω–¥–µ–∫—Å ‚Äî —ç—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ ‚ûú –Ω–µ—Ç, –æ–Ω–∏ **—Ç–æ—Ä–º–æ–∑—è—Ç INSERT/UPDATE**

---

üìå *–í—ã–≤–æ–¥*: –∏–Ω–¥–µ–∫—Å ‚Äî –∫–∞–∫ –∫–∞—Å—Ç–æ–º–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥. –ü–æ–¥–±–µ—Ä–∏ –ø–æ–¥ —Å–µ–±—è, –Ω–µ –∫–æ–ø–∏—Ä—É–π –±–µ–∑–¥—É–º–Ω–æ –∏–∑ StackOverflow.
