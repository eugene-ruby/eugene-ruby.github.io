---
layout: post
subtitle: <div id="terminal"></div>
title:  "Ruby: const_missing, autoload, Zeitwerk –∏ –ø—Ä–æ—Å–≤–µ—Ç–ª–µ–Ω–∏–µ –≤ require"
date:   2021-11-17 10:00:00 +0300
tags: Ruby,–∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞,require,load,Rails,Zeitwerk
version: A9X
rate: 3
categories:
  - ruby
toc: true
menubar_toc: true
hero_image: /images/ruby.jpg
hero_darken: true
---

–†–∞–∑–±–∏—Ä–∞–µ—Ç–µ—Å—å, –∫–∞–∫ Ruby –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–ª–∞—Å—Å—ã –∏ –º–æ–¥—É–ª–∏? –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –º—ã –¥–µ—Ç–∞–ª—å–Ω–æ —Ä–∞–∑–±–µ—Ä—ë–º –º–µ—Ö–∞–Ω–∏–∑–º—ã –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏ –≤ Ruby ‚Äî –æ—Ç –±–∞–∑–æ–≤—ã—Ö `require` –∏ `load` –¥–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö —Ç–µ—Ö–Ω–∏–∫ –≤—Ä–æ–¥–µ `const_missing` –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ `autoload_paths` –≤ Rails. –í—ã —É–∑–Ω–∞–µ—Ç–µ, –ø–æ—á–µ–º—É `require_relative` –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø–∞—Å–µ–Ω, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ `autoload`, –∏ –ø–æ—á–µ–º—É Zeitwerk —Å—Ç–∞–ª –∑–æ–ª–æ—Ç—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–º –≤ Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö. –ú—ã –æ—Ç–≤–µ—Ç–∏–º –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤: ¬´–ü–æ—á–µ–º—É Ruby –Ω–µ –≤–∏–¥–∏—Ç –º–æ–π –∫–ª–∞—Å—Å?¬ª, ¬´–ù—É–∂–Ω–æ –ª–∏ –ø–∏—Å–∞—Ç—å require –≤ Rails?¬ª –∏ ¬´–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É –≤ –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö?¬ª ‚Äî —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–æ–¥–∞ –∏ –ª—É—á—à–∏–º–∏ –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏.

---

## üß± –ö–∞–∫ Ruby –Ω–∞—Ö–æ–¥–∏—Ç –∫–ª–∞—Å—Å—ã

–û–±—ã—á–Ω–æ —Ç—ã –ø–∏—à–µ—à—å:

```ruby
require 'json'
puts JSON.parse("{}")
````

Ruby –∏—â–µ—Ç —Ñ–∞–π–ª `json.rb` –∏–ª–∏ `json.so` –≤ –ø—É—Ç—è—Ö –∏–∑ `LOAD_PATH`.

---

## üß® `require` vs `require_relative`

* `require` –∏—â–µ—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º `$LOAD_PATH`
* `require_relative` ‚Äî –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞

```ruby
require_relative '../lib/my_tool'
```

üìå `require_relative` –±—ã—Å—Ç—Ä–µ–µ –∏ –Ω–∞–¥—ë–∂–Ω–µ–µ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ö –∏ —Å–∫—Ä–∏–ø—Ç–∞—Ö.

---

## üß™ `autoload`: –æ—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞

```ruby
autoload :Foo, "foo"

# –ö–ª–∞—Å—Å Foo –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω **—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏**
Foo.new
```

Ruby –æ—Ç–ª–æ–∂–∏—Ç –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞ `foo.rb`, –ø–æ–∫–∞ `Foo` —Ä–µ–∞–ª—å–Ω–æ –Ω–µ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è.
üí° –£—Å—Ç–∞—Ä–µ–≤–∞–µ—Ç –≤ –ø–æ–ª—å–∑—É Zeitwerk (—Å–º. –Ω–∏–∂–µ).

---

## üß† `const_missing` ‚Äî –º–∞–≥–∏—è –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã

```ruby
class Object
  def self.const_missing(name)
    puts "–ò—â—É #{name}..."
    require name.to_s.downcase
    const_get(name)
  end
end

User.new  # => –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è user.rb
```

–†–∞–±–æ—Ç–∞–µ—Ç –≤ —Å–≤—è–∑–∫–µ —Å `require`, –Ω–æ –ª–µ–≥–∫–æ —Å–ª–æ–º–∞—Ç—å –≤—Å—ë (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –≤ –∏–º–µ–Ω–∏ –æ—à–∏–±–∫–∞).

---

## üöÜ Zeitwerk: –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑—á–∏–∫ –≤ Rails

–ù–∞—á–∏–Ω–∞—è —Å Rails 6, `Zeitwerk` ‚Äî —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–≥—Ä—É–∑—á–∏–∫:

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `const_missing`
* –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º **convention over configuration**
* –¢—Ä–µ–±—É–µ—Ç —Å–æ–±–ª—é–¥–µ–Ω–∏—è —Å–æ–≥–ª–∞—à–µ–Ω–∏–π –æ–± –∏–º–µ–Ω–∞—Ö –∏ –ø—É—Ç—è—Ö

```ruby
# app/models/user.rb
# —Å–æ–¥–µ—Ä–∂–∏—Ç class User

User.new  # => –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
```

---

## üßπ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è Zeitwerk

1. **–ò–º–µ–Ω–∞ –∫–ª–∞—Å—Å–æ–≤ –∏ —Ñ–∞–π–ª–æ–≤ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å**

   ```ruby
   class SuperBot  # => –≤ super_bot.rb
   ```

2. **–ú–æ–¥—É–ª–∏ –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å**

   ```ruby
   module Admin
     class Report  # => –≤ admin/report.rb
   end
   ```

3. –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `require` –≤—Ä—É—á–Ω—É—é –≤–Ω—É—Ç—Ä–∏ `app/`

---

## üì¶ –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π –ø—É—Ç—å –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É

```ruby
Rails.autoloaders.main.push_dir("#{Rails.root}/lib")
```

–ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å `lib/` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—É—Ç—è–º–∏ –∏ –∏–º–µ–Ω–∞–º–∏ –∫–ª–∞—Å—Å–æ–≤.

---

## üß® –í–æ–ø—Ä–æ—Å —Å –ø–æ–¥–≤–æ—Ö–æ–º

```ruby
class App
  autoload :Config, "config"
end

App::Config  # –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç?
```

‚úÖ Ruby –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å `config.rb`, –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å `Config`, –∏ –≤—Å—ë –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.
üí• –ï—Å–ª–∏ `config.rb` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `Configuration`, –∞ –Ω–µ `Config` ‚Äî `NameError`.

---

## üö® –ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è –ø—Ä–æ—Å—Ç–æ `require 'user'` –≤ Rails?

–ü–æ—Ç–æ–º—É —á—Ç–æ:

* Rails –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Zeitwerk
* –¢—ã —Ä–∏—Å–∫—É–µ—à—å –∑–∞–≥—Ä—É–∑–∏—Ç—å **–≤—Ä—É—á–Ω—É—é**, –Ω–∞—Ä—É—à–∏–≤ lifecycle
* –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ reload –≤ dev-—Ä–µ–∂–∏–º–µ

–ò—Å–ø–æ–ª—å–∑—É–π `Rails.autoloaders`, –∞ –Ω–µ `require`.

---

üîö **–í—ã–≤–æ–¥:**
Ruby —É–º–µ–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –∫–ª–∞—Å—Å—ã, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—ã –Ω–µ –º–µ—à–∞–µ—à—å.
–ó–Ω–∞–π, —á—Ç–æ –¥–µ–ª–∞–µ—Ç `const_missing`, –∑–∞—á–µ–º Zeitwerk, –∏ –ø–æ—á–µ–º—É `autoload` —É–∂–µ –Ω–µ —Ç–æ—Ä—Ç. –≠—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—é—Ç ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–µ–¥—ë—Ç –∫ `uninitialized constant`, `CircularDependencyError` –∏ –æ—Ä—É—â–µ–º—É –ø—Ä–æ–¥—É.
