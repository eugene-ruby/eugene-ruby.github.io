---
layout: post
title:  "–î–æ–±–∞–≤–∏–ª –∏–Ω–¥–µ–∫—Å ‚Äî –∏ –ø—Ä–æ–¥ –ª—ë–≥. –ê –Ω–∞ —Å—Ç–µ–π–¥–∂–µ –≤—Å—ë –±—ã–ª–æ —Ö–æ—Ä–æ—à–æ!"
date:   2025-01-30 10:00:00 +0300
rate: 4
tags: PostgreSQL,–∏–Ω–¥–µ–∫—Å—ã,Rails,–º–∏–≥—Ä–∞—Ü–∏–∏,CONCURRENTLY,–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
version: A49X3
categories:
  - migration
  - postgres
  - rails
toc: true
menubar_toc: true
hero_image: /images/rails.jpg
hero_darken: true
---
–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ PostgreSQL ‚Äî –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤, –Ω–æ –±–µ–∑–¥—É–º–Ω–æ–µ –∏—Ö –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º —Ç–∞–±–ª–∏—Ü –Ω–∞ –ø—Ä–æ–¥–µ. –í —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤ Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö —Å –ø–æ–º–æ—â—å—é –∞–ª–≥–æ—Ä–∏—Ç–º–∞ CONCURRENTLY –∏ –∏–∑–±–µ–∂–∞—Ç—å —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –ø—Ä–æ—Å—Ç–æ—è–º.

---
–¢—ã –ø–∏—à–µ—à—å –º–∏–≥—Ä–∞—Ü–∏—é:

```ruby
add_index :users, :email
````

–í—Å—ë –±—ã—Å—Ç—Ä–æ –Ω–∞ staging ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞ —Å–µ–∫—É–Ω–¥—É.
–ù–∞ –ø—Ä–æ–¥–µ: —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞ 5 –º–∏–ª–ª–∏–æ–Ω–æ–≤ —Å—Ç—Ä–æ–∫, –±–∞–∑–∞ –ø–æ–≤–∏—Å–∞–µ—Ç, –∑–∞–ø—Ä–æ—Å—ã —Å—Ç–æ–ø–æ—Ä—è—Ç—Å—è, devops –∫–∏–¥–∞—é—Ç –≤ —Ç–µ–±—è —Ç–∞–ø–∫–∞–º–∏.

---

## üö® –ß—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫?

–ù–∞ staging ‚Äî 10 —Å—Ç—Ä–æ–∫.
–ù–∞ –ø—Ä–æ–¥–µ ‚Äî **–º–∏–ª–ª–∏–æ–Ω—ã**.
–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é **–±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É** –Ω–∞ –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è.

---

## üß† –ö–∞–∫ –Ω–∞–¥–æ –±—ã–ª–æ

–ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **`algorithm: :concurrently`**:

```ruby
add_index :users, :email, algorithm: :concurrently
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å **–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã**, –Ω–æ:

* –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ `change`, —Ç–æ–ª—å–∫–æ `up/down`
* –Ω–µ–ª—å–∑—è –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

---

## üßØ –¢–∏–ø–∏—á–Ω—ã–π —Ñ–∞–∫–∞–ø

```ruby
# –ø–ª–æ—Ö–æ
class AddIndexToUsers < ActiveRecord::Migration[7.1]
  def change
    add_index :users, :email, algorithm: :concurrently
  end
end
```

‚ùå –û—à–∏–±–∫–∞: *can't run concurrent index creation inside a transaction*

---

## ‚úÖ –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

```ruby
class AddIndexToUsers < ActiveRecord::Migration[7.1]
  disable_ddl_transaction!

  def change
    add_index :users, :email, algorithm: :concurrently
  end
end
```

---

## üß™ –ü—Ä–æ–≤–µ—Ä—å —Å–µ–±—è

* –ò–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–∞ –±–æ–ª—å—à—É—é —Ç–∞–±–ª–∏—Ü—É? ‚ûú `concurrently`
* –¢–∞–±–ª–∏—Ü–∞ –∞–∫—Ç–∏–≤–Ω–æ –ø–∏—à–µ—Ç—Å—è? ‚ûú `disable_ddl_transaction!`
* –í staging –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö? ‚ûú —Ç–µ—Å—Ç–∏—Ä—É–π –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ –¥–∞–º–ø–µ –∏–∑ –ø—Ä–æ–¥–∞

---

## üí° –ë–æ–Ω—É—Å: —É–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ —Ç–æ–∂–µ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å

```ruby
remove_index :users, :email, algorithm: :concurrently
```

## üõ°Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π `strong_migrations`

–ü–æ–¥–∫–ª—é—á–∏ –≥–µ–º [`strong_migrations`](https://github.com/ankane/strong_migrations), –∏ –æ–Ω **–ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç –æ —Ä–∏—Å–∫–∞—Ö**:

```ruby
gem "strong_migrations"
```

–û–Ω –Ω–µ –¥–∞—Å—Ç —Å–ª—É—á–∞–π–Ω–æ –ø–æ–≤–µ—Å–∏—Ç—å –ø—Ä–æ–¥, –µ—Å–ª–∏ —Ç—ã:

* —Å–æ–∑–¥–∞—ë—à—å –∏–Ω–¥–µ–∫—Å –±–µ–∑ `concurrently`
* —É–¥–∞–ª—è–µ—à—å –∫–æ–ª–æ–Ω–∫—É
* –º–µ–Ω—è–µ—à—å —Ç–∏–ø –ø–æ–ª—è –±–µ–∑ –±—ç–∫–∞–ø–∞

üì¢ –≠—Ç–æ –Ω–µ –ø–∞–Ω–∞—Ü–µ—è, –Ω–æ **–ø–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è –æ–±–æ—Ä–æ–Ω—ã**. –û—Å–æ–±–µ–Ω–Ω–æ, –µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–µ–ª–∞–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ —Å–∏–Ω—å–æ—Ä.

---

üìå *–í—ã–≤–æ–¥*: –≤ –º–∏–≥—Ä–∞—Ü–∏—è—Ö –≤–∞–∂–Ω–∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏–∫–∞, –Ω–æ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è. –û—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ –ø—Ä–æ–¥–µ.
