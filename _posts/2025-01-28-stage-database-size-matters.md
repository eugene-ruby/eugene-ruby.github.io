---
layout: post
subtitle: <div id="terminal"></div>
title:  "–ü–æ—á–µ–º—É staging –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—á—Ç–∏ –∫–∞–∫ –ø—Ä–æ–¥. –ò–ª–∏ –∂–¥–∏ –±–µ–¥—ã 31 –¥–µ–∫–∞–±—Ä—è –≤ 23:50"
date:   2025-01-28 12:00:00 +0300
rate: 3
tags: Ruby,PostgreSQL,ActiveRecord,SQL,—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ,N+1
version: A9X
categories:
  - postgres
toc: true
menubar_toc: true
hero_image: /images/posts/68.jpg
hero_darken: true
---
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø—É—Å—Ç–æ–π –±–∞–∑–µ staging ‚Äî —ç—Ç–æ –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–±–æ—Ç—É –¥–≤–∏–≥–∞—Ç–µ–ª—è –Ω–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ, –∫–æ–≥–¥–∞ —Ç–µ–±–µ –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –≥—Ä—É–∂—ë–Ω—ã–π –ö–∞–º–ê–ó. PostgreSQL –∏ ActiveRecord –º–æ–≥—É—Ç –≤–µ—Å—Ç–∏ —Å–µ–±—è —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –ø–æ-—Ä–∞–∑–Ω–æ–º—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–±—ä—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö, –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Å–≤—è–∑–µ–π –∏ –∏–Ω–¥–µ–∫—Å–æ–≤. –ï—Å–ª–∏ –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å —ç—Ç–∏ –Ω—é–∞–Ω—Å—ã, –¥–∞–∂–µ –ø—Ä–æ—Å—Ç–æ–π SQL-–∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–æ–¥–∞ —Å–ø–æ—Å–æ–±–Ω—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –ø—Ä–æ–¥ –≤ –∞–¥ –∏–∑ —Ç–∞–π–º–∞—É—Ç–æ–≤, N+1 –∏ Seq Scan –Ω–∞ –º–∏–ª–ª–∏–æ–Ω—ã —Å—Ç—Ä–æ–∫.

---

`SELECT COUNT(*) FROM users;`  
–ù–∞ –ø—Ä–æ–¥–µ: **1 258 917**  
–ù–∞ staging: **10**

–ï—Å–ª–∏ —É —Ç–µ–±—è —Ç–∞–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ ‚Äî –ø–æ–∑–¥—Ä–∞–≤–ª—è—é: —Ç—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Ç–∫–ª—é—á–∏–ª —Å–µ–±–µ 90% –ø—Ä–æ–¥–æ–≤—ã—Ö –±–∞–≥–æ–≤ –æ—Ç –æ—Ç–ª–æ–≤–∞ –Ω–∞ —Ç–µ—Å—Ç–∞—Ö.

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ù–∞ staging –≤—Å—ë –ª–µ—Ç–∞–µ—Ç. –ù–æ–≤—ã–π SQL-–∑–∞–ø—Ä–æ—Å, —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∏–ª–∏ –¥–∞–∂–µ –º–∏–≥—Ä–∞—Ü–∏—è ‚Äî –ø—Ä–æ—Ö–æ–¥–∏—Ç –∑–∞ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã.  
–ê –ø–æ—Ç–æ–º –ø—Ä–∏—Ö–æ–¥–∏—Ç **–≤–µ—á–µ—Ä 31 –¥–µ–∫–∞–±—Ä—è**, –∏ –Ω–∞ –ø—Ä–æ–¥–µ:

- –∑–∞–≤–∏—Å–∞–µ—Ç –≤–æ—Ä–∫–µ—Ä
- —Ç–∞–π–º–∞—É—Ç—ã –Ω–∞ API
- –±–∞–∑–∞ —É—Ö–æ–¥–∏—Ç –≤ swap
- –≤—Å–ø–ª—ã–≤–∞–µ—Ç `EXPLAIN` —Å `Seq Scan` –Ω–∞ –º–∏–ª–ª–∏–æ–Ω —Å—Ç—Ä–æ–∫

–ê —Ç—ã –≤–µ–¥—å —ç—Ç–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª‚Ä¶ –ù–æ –Ω–∞ –ø—É—Å—Ç–æ–π –±–∞–∑–µ. –ì–¥–µ –¥–∞–∂–µ `JOIN`'—É –±—ã–ª–æ —Å–∫—É—á–Ω–æ.

---

## üß† –ü–æ—á–µ–º—É staging ‚â† –ø—Ä–æ–¥

**PostgreSQL –∏ ActiveRecord –≤–µ–¥—É—Ç —Å–µ–±—è –ø–æ-—Ä–∞–∑–Ω–æ–º—É**, –∫–æ–≥–¥–∞:

- –º–µ–Ω—è–µ—Ç—Å—è **–æ–±—ä—ë–º** –¥–∞–Ω–Ω—ã—Ö
- —Ä–∞–∑–Ω—ã–µ **–∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç–∏** (`users ‚Üí posts`)
- –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç **–∏–Ω–¥–µ–∫—Å—ã** –≤ `WHERE ... IN (10 ids)`
- —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–Ω–∏–∂–µ–Ω–∞

---

## üß™ –ß—Ç–æ –º–æ–∂–Ω–æ –Ω–µ –∑–∞–º–µ—Ç–∏—Ç—å –Ω–∞ –ø—É—Å—Ç–æ–º staging

| –ü—Ä–æ–±–ª–µ–º–∞                    | –ù–∞ staging           | –ù–∞ –ø—Ä–æ–¥–µ                |
|----------------------------|----------------------|-------------------------|
| `N+1`                      | –ë—ã—Å—Ç—Ä–æ               | –í–∑—Ä—ã–≤–∞–µ—Ç—Å—è –≤ —Ü–∏–∫–ª–µ      |
| `Seq Scan`                 | –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ            | –ß–∏—Ç–∞–µ—Ç 1–ú —Å—Ç—Ä–æ–∫         |
| `Nested Loop`              | –ù–æ—Ä–º–∞–ª—å–Ω–æ            | –£–±–∏–≤–∞–µ—Ç CPU             |
| `GROUP BY`, `DISTINCT`     | –ú–∞–ª–µ–Ω—å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç  | –ü–∞–¥–∞–µ—Ç –≤ swap           |
| `COUNT(*)` –±–µ–∑ –∏–Ω–¥–µ–∫—Å–∞     | –ü–æ—á—Ç–∏ –Ω–µ–∑–∞–º–µ—Ç–Ω–æ      | –¢–∞–π–º–∞—É—Ç –≤ API           |

---

## ‚úÖ –ß—Ç–æ –¥–µ–ª–∞—Ç—å

- **–ó–∞–≥—Ä—É–∑–∏ staging –¥–∞–Ω–Ω—ã–º–∏** —Ö–æ—Ç—è –±—ã –≤ **10‚Äì30% –æ—Ç –ø—Ä–æ–¥–∞**
- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π –¥–∞–º–ø, –æ–±—Ä–µ–∂—å sensitive-–¥–∞–Ω–Ω—ã–µ
- –ó–∞–ø—É—Å–∫–∞–π —Ç–µ—Å—Ç—ã –∏ `EXPLAIN` **–∏–º–µ–Ω–Ω–æ —Ç–∞–º**
- –°–¥–µ–ª–∞–π cron: `pg_restore` —Å —Ä–µ–ø–ª–∏–∫–∏ ‚Üí staging —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é

---

## üß® –ö–æ–≥–¥–∞ —ç—Ç–æ –≤–∑—Ä—ã–≤–∞–µ—Ç—Å—è

–ß–∞—â–µ –≤—Å–µ–≥–æ:

- ‚ùÑÔ∏è 31 –¥–µ–∫–∞–±—Ä—è 23:50 (–æ—Ç—á—ë—Ç—ã)
- üì¶ –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞
- üöÄ –ù–æ–≤—ã–π —Ä–µ–ª–∏–∑ —Å –∑–∞–±—ã—Ç—ã–º `.includes`
- üìä –ù–æ–≤—ã–π `dashboard` –æ—Ç –ø—Ä–æ–¥–∞–∫—Ç–∞

---

üìå _–í—ã–≤–æ–¥_: staging ‚Äî –Ω–µ –¥–ª—è –≥–∞–ª–æ—á–∫–∏. –û–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–±–æ–µ–≤–æ–π –ø–µ—Å–æ—á–Ω–∏—Ü–µ–π**, –∞ –Ω–µ –∫–∞—Ä—Ç–æ–Ω–Ω–æ–π –∫–æ—Ä–æ–±–∫–æ–π.
