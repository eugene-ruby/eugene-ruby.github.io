---
layout: post
title:  "–ü–æ—á–µ–º—É default_scope = –±–æ–ª—å"
date:   2025-03-09 10:30:00 +0300
rate: 3
tags: Ruby,Rails,default_scope,PostgreSQL,SQL,–∑–∞–ø—Ä–æ—Å—ã
version: A49X3
categories:
  - orm
  - rails
toc: true
menubar_toc: true
hero_image: /images/architecture.jpg
hero_darken: true
---
Ruby on Rails –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –º–æ—â–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏, –Ω–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–∑ –Ω–∏—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä default_scope, –º–æ–≥—É—Ç –ø—Ä–∏–Ω–µ—Å—Ç–∏ –±–æ–ª—å—à–µ –ø—Ä–æ–±–ª–µ–º, —á–µ–º –ø–æ–ª—å–∑—ã. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π –∫ –∑–∞–ø—Ä–æ—Å–∞–º –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –∏–∑–±–µ–∂–∞—Ç—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å PostgreSQL –∏ —Å–ª–æ–∂–Ω—ã—Ö SQL-–∑–∞–ø—Ä–æ—Å–∞—Ö.

---
`default_scope` –∫–∞–∂–µ—Ç—Å—è —É–¥–æ–±–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º –∏–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è —Ñ–∏–ª—å—Ç—Ä–∞. –ù–æ —á–∞—â–µ –≤—Å–µ–≥–æ –æ–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –±–æ–ª–∏.

## üòá –ù–∞–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```ruby
class User < ApplicationRecord
  default_scope { where(active: true) }
end
````

–ö–∞–∂–µ—Ç—Å—è, —Ç—ã –∏–∑–±–∞–≤–∏–ª—Å—è –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è. –¢–µ–ø–µ—Ä—å `User.all` ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.

---

## üí• –ê –ø–æ—Ç–æ–º –ø—Ä–∏—Ö–æ–¥–∏—Ç –±–æ–ª—å

### üìå –¢–µ—Å—Ç—ã –Ω–µ –≤–∏–¥—è—Ç "–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö"

```ruby
User.create!(active: false)
expect(User.count).to eq(1) # üí• Nope. 0
```

### üìå –ê–¥–º–∏–Ω–∫–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–≤—Å–µ—Ö"

–¢—ã —Å–ª—É—á–∞–π–Ω–æ –Ω–∞–ø–∏—Å–∞–ª `User.all`, –∞ –Ω–µ `User.unscoped`.

### üìå –°–ª–æ–∂–Ω–æ—Å—Ç—å —Å join‚Äô–∞–º–∏ –∏ merge

```ruby
Company.joins(:users).merge(User)
# –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –ª–∏—à–Ω–∏–π where(active: true)
```

---

## üßØ –û–±—Ö–æ–¥—ã –∏ –∫–æ—Å—Ç—ã–ª–∏

–¢—ã –Ω–∞—á–∏–Ω–∞–µ—à—å:

* –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `unscoped`
* –¥–æ–±–∞–≤–ª—è—Ç—å "—Å—é—Ä–ø—Ä–∏–∑" –≤ SQL
* –≥—É–≥–ª–∏—Ç—å, –ø–æ—á–µ–º—É `merge` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –Ω–∞–¥–æ

---

## üîç –ß—Ç–æ –¥–µ–ª–∞—Ç—å –≤–º–µ—Å—Ç–æ?

–ò—Å–ø–æ–ª—å–∑—É–π **scope**, –∞ –Ω–µ **default\_scope**:

```ruby
class User < ApplicationRecord
  scope :active, -> { where(active: true) }
end

User.active
```

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å `.all`, —Å–¥–µ–ª–∞–π —ç—Ç–æ —è–≤–Ω–æ.

---

## üö® TL;DR

| –ü—Ä–æ–±–ª–µ–º–∞               | –ü—Ä–∏—á–∏–Ω–∞                           |
| ---------------------- | --------------------------------- |
| –ù–µ–≤–∏–¥–∏–º—ã–µ –∑–∞–ø–∏—Å–∏       | `default_scope` –¥–æ–±–∞–≤–ª—è–µ—Ç `where` |
| –û—à–∏–±–∫–∏ –≤ —Ç–µ—Å—Ç–∞—Ö        | –û–∂–∏–¥–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç |
| merge –Ω–µ –∫–∞–∫ –æ–∂–∏–¥–∞–ª–æ—Å—å | `default_scope` –Ω–µ—è–≤–Ω–æ –º–µ—à–∞–µ—Ç     |

**–ò—Ç–æ–≥:** `default_scope` —Å—Ç–æ–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –æ—á–µ–Ω—å —É–∑–∫–∏—Ö –∫–µ–π—Å–∞—Ö ‚Äî –∏ –≤—Å–µ–≥–¥–∞ –ø–æ–º–Ω–∏—Ç—å, —á—Ç–æ –æ–Ω *–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–µ–∑–¥–µ*.
