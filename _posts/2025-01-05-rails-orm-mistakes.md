---
layout: post
title:  "10 —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å ORM –≤ Rails"
date:   2025-01-05 11:00:00 +0300
rate: 3
tags: ActiveRecord,Ruby on Rails,ORM,PostgreSQL,N+1,scope
version: A49X3
categories:
  - orm
  - rails
toc: true
menubar_toc: true
hero_image: /images/rails.jpeg
hero_darken: true
---
ActiveRecord –≤ Ruby on Rails ‚Äî —ç—Ç–æ –º–æ—â–Ω—ã–π ORM, –Ω–æ –¥–∞–∂–µ –æ–ø—ã—Ç–Ω—ã–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–∞—Å—Ç–æ –¥–æ–ø—É—Å–∫–∞—é—Ç –æ—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–±–∏–≤–∞—é—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º 10 —Ç–∏–ø–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∫ PostgreSQL –∏ –ø–æ–∫–∞–∂–µ–º, –∫–∞–∫ –∏—Ö –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å ‚Äî –æ—Ç N+1 –¥–æ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è scope.

---
ActiveRecord ‚Äî –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç. –ù–æ —Å –Ω–∏–º –ª–µ–≥–∫–æ —Å–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ‚Ä¶ –∏ –ø—Ä–∏ —ç—Ç–æ–º —É–∂–∞—Å–Ω–æ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ. –í–æ—Ç 10 –æ—à–∏–±–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–≤–µ—Ä—à–∞—é—Ç –¥–∞–∂–µ –æ–ø—ã—Ç–Ω—ã–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏.

## 1. üîÅ N+1 –ø—Ä–∏ `each`

```ruby
User.all.each { |u| puts u.company.name }
# üí• –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 1 + N –∑–∞–ø—Ä–æ—Å–æ–≤
````

üõ† –†–µ—à–µ–Ω–∏–µ: `includes(:company)`

---

## 2. üí• `pluck(:id)` –≤ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞—Ö

```ruby
Post.where(user_id: User.active.pluck(:id))
```

–ó–∞–≥—Ä—É–∑–∏—Ç **–≤—Å–µ id –≤ –ø–∞–º—è—Ç—å**. –ú–æ–∂–µ—Ç –±—ã—Ç—å **–æ—á–µ–Ω—å –¥–æ—Ä–æ–≥–æ**.

üõ† –õ—É—á—à–µ: `User.active.select(:id)` –∏–ª–∏ `.ids`

---

## 3. üßä –ü–æ—Ç–µ—Ä—è –ø–æ–ª–µ–π –ø—Ä–∏ `select(...)`

```ruby
User.select("id").first.name # => nil
```

üõ† –í—ã–±–∏—Ä–∞–π –≤—Å–µ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π `pluck`

---

## 4. ü§∑‚Äç‚ôÇÔ∏è –ó–∞–±—ã–ª `.save` –∏–ª–∏ `.update`

```ruby
user.name = "John"
# –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç üòÖ
```

üõ† –ò—Å–ø–æ–ª—å–∑—É–π `update` –∏–ª–∏ –Ω–µ –∑–∞–±—ã–≤–∞–π –ø—Ä–æ `save`

---

## 5. üß† –î–µ–ª–∞–µ—à—å –∑–∞–ø—Ä–æ—Å—ã –≤ —Ü–∏–∫–ª–µ

```ruby
users.each { |u| u.posts.count }
```

üõ† –ò–ª–∏ `includes(:posts)` + `u.posts.size`

---

## 6. ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—à—å `default_scope`

–û–Ω –ø—Ä–∏–ª–∏–ø–∞–µ—Ç –∫–æ –≤—Å–µ–º –∑–∞–ø—Ä–æ—Å–∞–º –∏ –∏–Ω–æ–≥–¥–∞ –≤–µ–¥—ë—Ç —Å–µ–±—è **–æ—á–µ–Ω—å –Ω–µ–æ—á–µ–≤–∏–¥–Ω–æ**.

üõ† –ü—Ä–µ–¥–ø–æ—á—Ç–∏ —è–≤–Ω—ã–µ `scope :active, -> { where(active: true) }`

---

## 7. üß± –ó–∞–±—ã–ª `.readonly` –≤ —Å–ª–æ–∂–Ω—ã—Ö `joins`

–ö–æ–≥–¥–∞ —Å—Ç—Ä–æ–∏—à—å –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π SQL, Rails –º–æ–∂–µ—Ç –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—ä–µ–∫—Ç.
–≠—Ç–æ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ –æ—à–∏–±–∫–µ –∏–ª–∏ –±–∞–≥—É.

üõ† –î–æ–±–∞–≤—å `.readonly`

---

## 8. üìâ –ò—Å–ø–æ–ª—å–∑—É–µ—à—å `.count` –Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏

```ruby
users = User.all
users.count # => SELECT COUNT(*) FROM users
users.to_a.count # => Ruby-level count
```

üõ† –î–µ–ª–∞–π `.count` **–¥–æ** –∑–∞–≥—Ä—É–∑–∫–∏

---

## 9. üåÄ –ü—É—Ç–∞–µ—à—å `joins` –∏ `includes`

```ruby
User.joins(:posts).where(posts: { title: "foo" }) # ok
User.includes(:posts).where(posts: { title: "foo" }) # => –∏–Ω–æ–≥–¥–∞ –¥–µ–ª–∞–µ—Ç JOIN, –∏–Ω–æ–≥–¥–∞ –Ω–µ—Ç
```

üõ† –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—à—å ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π `joins`

---

## 10. üöÄ –ù–µ –∑–∞–º–µ—Ä—è–µ—à—å –∑–∞–ø—Ä–æ—Å—ã

Rails ‚Äî –Ω–µ —É–≥–∞–¥–∞–µ—Ç –∑–∞ —Ç–µ–±—è. –ò—Å–ø–æ–ª—å–∑—É–π `bullet`, `rack-mini-profiler` –∏ `EXPLAIN ANALYZE`

---

## üìå –†–µ–∑—é–º–µ

| –û—à–∏–±–∫–∞          | –ß—Ç–æ –¥–µ–ª–∞—Ç—å –≤–º–µ—Å—Ç–æ                        |
| --------------- | ---------------------------------------- |
| N+1             | `includes` –∏–ª–∏ `preload`                 |
| `pluck(:id)`    | `select(:id)` –∏–ª–∏ `.ids`                 |
| `select(...)`   | –î–æ–±–∞–≤–ª—è–π –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è —è–≤–Ω–æ                |
| –¶–∏–∫–ª—ã –∑–∞–ø—Ä–æ—Å–æ–≤  | –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∏–ª–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ |
| `default_scope` | –ò—Å–ø–æ–ª—å–∑—É–π –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ `scope`'—ã          |
