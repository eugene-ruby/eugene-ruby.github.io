---
layout: post
subtitle: <div id="terminal"></div>
title:  "Docker –¥–ª—è pet-–ø—Ä–æ–µ–∫—Ç–∞: –∫–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å ¬´—É –º–µ–Ω—è –Ω–∞ –ª–æ–∫–∞–ª–∫–µ —Ä–∞–±–æ—Ç–∞–ª–æ¬ª"
date:   2024-10-10 12:00:00 +0300
rate: 2
tags: Docker,Ruby on Rails,Pet
version: 3.2.2
categories:
  - pet
  - ruby
hero_image: /images/posts/37.jpg
hero_darken: true
toc: true
menubar_toc: true
---
–í—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª–∏ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π Rails-–ø—Ä–æ–µ–∫—Ç. –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ –≤—Å—ë –ª–µ—Ç–∞–µ—Ç, –Ω–æ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –µ–≥–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –æ—à–∏–±–∫–∏ –≤ –¥—É—Ö–µ ¬´Gem::Ext::BuildError¬ª –∏–ª–∏ ¬´Postgresql version mismatch¬ª. –ó–Ω–∞–∫–æ–º–æ? Docker —Ä–µ—à–∞–µ—Ç —ç—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã —Ä–∞–∑ –∏ –Ω–∞–≤—Å–µ–≥–¥–∞ ‚Äî –∏ –≤–æ—Ç –∫–∞–∫ –Ω–∞—á–∞—Ç—å –∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —É–∂–µ —Å–µ–≥–æ–¥–Ω—è.

---

## üêã –ü–æ—á–µ–º—É Docker ‚Äî —ç—Ç–æ –Ω–µ ¬´–¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö¬ª

### –ú–∏—Ñ: ¬´–Ø –∂–µ —Ç–æ–ª—å–∫–æ —É—á—É—Å—å, –∑–∞—á–µ–º –º–Ω–µ Docker?¬ª
**–ü—Ä–∞–≤–¥–∞:** Docker –Ω–µ —É—Å–ª–æ–∂–Ω—è–µ—Ç, –∞ —É–ø—Ä–æ—â–∞–µ—Ç –∂–∏–∑–Ω—å –Ω–æ–≤–∏—á–∫—É:
- –ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é Ruby, Postgres, Redis.
- –ù–µ –±—É–¥–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤–µ—Ä—Å–∏–π (¬´–ê —É –º–µ–Ω—è Ruby 3.3, –∞ –Ω–µ 2.7!¬ª).
- –õ–µ–≥–∫–æ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ–µ–∫—Ç–æ–º: –¥—Ä—É–≥ –∑–∞–ø—É—Å—Ç–∏—Ç –µ–≥–æ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π.

–ü—Ä–∏–º–µ—Ä –±–æ–ª–∏ –±–µ–∑ Docker:
```bash
# –ü–æ—Å–ª–µ —á–∞—Å–æ–≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞:
rails db:migrate
# => PG::ConnectionBad: FATAL:  database "myapp_development" does not exist
# (–ê –≥–¥–µ –≤–æ–æ–±—â–µ –º–æ–π Postgres?!)
```

---

## üõ†Ô∏è –ü—Ä–∞–∫—Ç–∏–∫–∞: Docker –¥–ª—è Rails + Postgres

### –®–∞–≥ 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è](https://docs.docker.com/get-docker/) –¥–ª—è –≤–∞—à–µ–π –û–°.
- –ü—Ä–æ–≤–µ—Ä—è–µ–º: `docker --version` –∏ `docker-compose --version`.

### –®–∞–≥ 2. –°–æ–∑–¥–∞—ë–º `Dockerfile`
–í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:
```dockerfile
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ Ruby
FROM ruby:3.2

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    nodejs

# –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º Gemfile –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–µ–º—ã
COPY Gemfile Gemfile.lock ./
RUN bundle install

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –∫–æ–¥
COPY . .

# –ü–æ—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å Rails
EXPOSE 3000

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
CMD ["rails", "server", "-b", "0.0.0.0"]
```

 ü§ì –ó–∞–≥–ª—è–Ω–∏ –≤ –ø–æ–ª–µ–∑–Ω—É—é —Å—Ç–∞—Ç—å—é: [–ö–∞–∫ –Ω–µ —Å–æ–±–∏—Ä–∞—Ç—å –∂–∏—Ä–Ω—ã–π Docker –æ–±—Ä–∞–∑](/posts/slow-fat-docker-image)

### –®–∞–≥ 3. –ü–∏—à–µ–º `docker-compose.yml`
```yaml
version: '3.8'

services:
  db:
    image: postgres:15
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: password

  web:
    build: .
    command: bash -c "rm -f tmp/pids/server.pid && rails server -b 0.0.0.0"
    volumes:
      - .:/app
    ports:
      - "3000:3000"
    depends_on:
      - db
    environment:
      DATABASE_URL: postgres://postgres:password@db:5432

volumes:
  postgres_data:
```

### –®–∞–≥ 4. –ó–∞–ø—É—Å–∫–∞–µ–º!
```bash
docker-compose build
docker-compose up
```
–¢–µ–ø–µ—Ä—å –≤–∞—à Rails-–ø—Ä–æ–µ–∫—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `localhost:3000`, –∞ Postgres –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω –∏ –ø–æ–¥–∫–ª—é—á—ë–Ω.

---

## üí° –õ–∞–π—Ñ—Ö–∞–∫–∏ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤

### 1. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** ¬´–ì–¥–µ –º–æ–∏ –¥–∞–Ω–Ω—ã–µ? –û–Ω–∏ –∏—Å—á–µ–∑–∞—é—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ!¬ª  
**–†–µ—à–µ–Ω–∏–µ:** Volumes –≤ `docker-compose.yml` (–∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ –≤—ã—à–µ) —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏.

### 2. –ö–∞–∫ –¥–µ–±–∞–∂–∏—Ç—å

```bash
# –ó–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
docker-compose exec web bash

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ Postgres:
docker-compose logs db
```

### 3. –ö–∞–∫ –Ω–µ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å –æ–±—Ä–∞–∑ –∫–∞–∂–¥—ã–π —Ä–∞–∑
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `volumes` –¥–ª—è –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ (–∫–∞–∫ –≤ `docker-compose.yml` –≤—ã—à–µ), —Ç–æ–≥–¥–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö –±—É–¥—É—Ç —Å—Ä–∞–∑—É –≤–∏–¥–Ω—ã.

---

## üî• –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏

| –û—à–∏–±–∫–∞                          | –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å                     |
|---------------------------------|----------------------------------|
| ¬´–ù–µ –≤–∏–¥–∏—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö¬ª          | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DATABASE_URL` –≤ `environment` |
| ¬´Gemfile.lock –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç¬ª      | –£–¥–∞–ª–∏—Ç–µ –µ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ –∏ –ø–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞–∑ |
| ¬´–ü–æ—Ä—Ç —É–∂–µ –∑–∞–Ω—è—Ç¬ª                | –ò–∑–º–µ–Ω–∏—Ç–µ `ports` –≤ `docker-compose.yml` |

–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—á–µ–≥–æ `database.yml` –¥–ª—è Docker:

```yaml
default: &default
  adapter: postgresql
  encoding: unicode
  host: db
  username: postgres
  password: password
  pool: 5

development:
  <<: *default
  database: myapp_development
```

---

## üöÄ **–î–µ–ø–ª–æ–π –Ω–∞ VPS**:   

```bash
git clone –≤–∞—à_–ø—Ä–æ–µ–∫—Ç && cd –≤–∞—à_–ø—Ä–æ–µ–∫—Ç && docker-compose up
```

ü§ì –ó–∞–≥–ª—è–Ω–∏ –≤ –ø–æ–ª–µ–∑–Ω—É—é —Å—Ç–∞—Ç—å—é: [CI/CD –ø—Ä–æ—â–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è](/posts/github-ssh-action-pet-deploy.html)

---

## üßæ –í—ã–≤–æ–¥

**Docker ‚Äî —ç—Ç–æ –Ω–µ —Å–ª–æ–∂–Ω–æ.**  
–≠—Ç–æ –≤–∞—à —Å—Ç—Ä–∞—Ö–æ–≤–æ–π –ø–æ–ª–∏—Å –æ—Ç ¬´–æ–Ω–æ —Ä–∞–±–æ—Ç–∞–ª–æ –Ω–∞ –º–æ–µ–π –º–∞—à–∏–Ω–µ¬ª. –ü–æ—Ç—Ä–∞—Ç—å—Ç–µ 2 —á–∞—Å–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî —Å—ç–∫–æ–Ω–æ–º–∏—Ç–µ 20 —á–∞—Å–æ–≤ –∑–∞–≤—Ç—Ä–∞. –ò –¥–∞, —Ç–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏: ¬´–Ø –∏—Å–ø–æ–ª—å–∑—É—é Docker –≤ —Å–≤–æ–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö¬ª.

---

> üîê –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –º—ã –Ω–µ –∫–∞—Å–∞–µ–º—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π –∏ —Å–µ–∫—Ä–µ—Ç–æ–≤ ‚Äî –≤—Å—ë –ø–æ–∫–∞–∑–∞–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–∞–∫–∏–µ –ø–æ–¥—Ö–æ–¥—ã –≤ –ø—Ä–æ–¥–µ ‚Äî [–¥–ª—è —ç—Ç–æ–≥–æ –µ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã](/posts/dotenv-pet-secrets.html)