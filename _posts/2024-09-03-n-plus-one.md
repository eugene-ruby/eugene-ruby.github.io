---
layout: post
title:  "N+1 –≤ Rails: –∫–∞–∫ –µ–≥–æ –Ω–∞–π—Ç–∏, –∑–∞ —á—Ç–æ –æ–Ω –æ—Ç–≤–µ—á–∞–µ—Ç –∏ –∫–∞–∫ –ø–æ–±–æ—Ä–æ—Ç—å"
date:   2024-09-03 10:30:00 +0300
rate: 3
tags: Ruby on Rails,N+1 –∑–∞–ø—Ä–æ—Å—ã,ActiveRecord,–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL,PostgreSQL,bullet
version: A49X3
categories:
  - orm
  - rails
toc: true
menubar_toc: true
hero_image: /images/rails.jpg
hero_darken: true
---
–ü—Ä–æ–±–ª–µ–º–∞ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ª–æ–≤—É—à–∫–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –Ω–∞ Ruby on Rails, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –±—ã—Å—Ç—Ä—ã–π –∫–æ–¥ –≤ –º–µ–¥–ª–µ–Ω–Ω—ã–π –∏–∑-–∑–∞ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ PostgreSQL. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ –Ω–∞—Ö–æ–¥–∏—Ç—å —Ç–∞–∫–∏–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞ —Å –ø–æ–º–æ—â—å—é –≥–µ–º–æ–≤ –≤—Ä–æ–¥–µ bullet, –∏ –Ω–∞—É—á–∏–º—Å—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —É—Å—Ç—Ä–∞–Ω—è—Ç—å –∏—Ö —á–µ—Ä–µ–∑ includes, preload –∏ –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã ActiveRecord. DevOps-–ø—Ä–∞–∫—Ç–∏–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–º–æ–≥—É—Ç –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–æ–¥–æ–±–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

---
–í—Å—ë –±—ã–ª–æ —Ö–æ—Ä–æ—à–æ‚Ä¶ –ø–æ–∫–∞ —Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Ö –∫–æ–º–ø–∞–Ω–∏—è–º–∏ ‚Äî –∏ –Ω–µ –ø–æ–ª—É—á–∏–ª 101 SQL-–∑–∞–ø—Ä–æ—Å. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ **–º–∏—Ä N+1** ‚Äî –≥–ª–∞–≤–Ω–æ–π –±–æ–ª–∏ ORM.

## üí• –ß—Ç–æ —Ç–∞–∫–æ–µ N+1?

```ruby
User.all.each do |user|
  puts user.company.name
end
````

–ï—Å–ª–∏ –Ω–µ —Å–¥–µ–ª–∞—Ç—å `includes(:company)`, Active Record —Å–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç `SELECT * FROM users`,
–∞ –∑–∞—Ç–µ–º –µ—â—ë **–ø–æ –æ–¥–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∞ –∫–∞–∂–¥—É—é `user.company`** ‚Äî –∏—Ç–æ–≥–æ **N+1 –∑–∞–ø—Ä–æ—Å**.

---

## üïµÔ∏è –ö–∞–∫ –Ω–∞–π—Ç–∏ N+1?

1. –í –ª–æ–≥–∞—Ö `development.log` ‚Äî –∏—â–∏ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è `SELECT ... WHERE id = ...`
2. –ì–µ–º [`bullet`](https://github.com/flyerhzm/bullet) –∫—Ä–∏—á–∏—Ç –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:

   > "N+1 detected: User => \[:company]"

---

## üõ° –ö–∞–∫ –±–æ—Ä–æ—Ç—å—Å—è?

### ‚úÖ includes

```ruby
User.includes(:company).each do |user|
  puts user.company.name
end
```

ActiveRecord –≤—ã–ø–æ–ª–Ω–∏—Ç **2 –∑–∞–ø—Ä–æ—Å–∞**, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π.

### ‚úÖ preload / eager\_load

| –ú–µ—Ç–æ–¥        | –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç                         |
| ------------ | ------------------------------------ |
| `includes`   | —Å–∞–º –≤—ã–±–∏—Ä–∞–µ—Ç preload –∏–ª–∏ eager\_load |
| `preload`    | –≤—Å–µ–≥–¥–∞ 2 –∑–∞–ø—Ä–æ—Å–∞                     |
| `eager_load` | –¥–µ–ª–∞–µ—Ç `LEFT OUTER JOIN`             |

---

## üß† –ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã

* **–ü—Ä–æ–≤–µ—Ä—å has\_many —á–µ—Ä–µ–∑** `includes(...).references(...)` ‚Äî –∏–Ω–∞—á–µ `WHERE` –ø–æ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
* **–ò–∑–±–µ–≥–∞–π –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö N+1**:

  ```ruby
  Post.includes(comments: :author)
  ```
* **–ü—Ä–æ—Ñ–∏–ª–∏—Ä—É–π —á–µ—Ä–µ–∑ `EXPLAIN`** –∏ `bullet`

---

## üöÄ –ù–æ–≤–∏—á–∫–∏ –ª—é–±—è—Ç .each ‚Äî –ø—Ä–æ—Ñ–∏ –ª—é–±—è—Ç .pluck

–ò–Ω–æ–≥–¥–∞ `pluck` —Ä–µ—à–∞–µ—Ç –≤—Å—ë:

```ruby
User.where(active: true).pluck(:id, :email)
```

1 –∑–∞–ø—Ä–æ—Å. –ù–∏–∫–∞–∫–∏—Ö –º–æ–¥–µ–ª–µ–π. –ë—ã—Å—Ç—Ä–æ.

---

üîö **–í—ã–≤–æ–¥:**
N+1 ‚Äî –Ω–µ –±–∞–≥ ORM, –∞ —Å–ª–µ–¥—Å—Ç–≤–∏–µ –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏. –ù–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏ –ø–æ–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤—ã —É–º–µ–µ—Ç–µ –µ–≥–æ –∑–∞–º–µ—á–∞—Ç—å –∏ —É–±–∏—Ä–∞—Ç—å ‚Äî —ç—Ç–æ –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö —á–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã—Ö performance-–≤–æ–ø—Ä–æ—Å–æ–≤.
