---
layout: post
title:  "Zeitwerk –ø—Ä–æ—Ç–∏–≤ require: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ –±–æ–ª–∏"
rate: 3
tags: Ruby,Zeitwerk,–∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞,require,–∫–ª–∞—Å—Å—ã,–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
version: A49X3
date:   2024-09-18 10:00:00 +0300
categories:
  - ruby
  - architecture
hero_image: /images/ruby.jpeg
hero_darken: true
toc: true
menubar_toc: true
---

–ü–æ–º–Ω–∏—Ç–µ —Ç–µ –≤—Ä–µ–º–µ–Ω–∞, –∫–æ–≥–¥–∞ –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π —Ñ–∞–π–ª –≤ Ruby-–ø—Ä–æ–µ–∫—Ç–µ —Ç—Ä–µ–±–æ–≤–∞–ª —Ä—É—á–Ω–æ–≥–æ `require`? –ö–æ–≥–¥–∞ –∑–∞–±—ã—Ç—ã–π `require_relative` –≤—ã–∑—ã–≤–∞–ª `NameError` –≤ —Å–∞–º—ã–π –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–π –º–æ–º–µ–Ω—Ç? –ê –ø–æ—Ç–æ–º –ø–æ—è–≤–∏–ª—Å—è Zeitwerk ‚Äî –∏ –≤—Å—ë –∏–∑–º–µ–Ω–∏–ª–æ—Å—å. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∞—Å—Å–æ–≤ —ç–≤–æ–ª—é—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–ª–∞ –æ—Ç –∫–∞–º–µ–Ω–Ω–æ–≥–æ –≤–µ–∫–∞ `require` –¥–æ –º–∞–≥–∏–∏ Zeitwerk, –∏ –ø–æ—á–µ–º—É —Ç–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–±—ã—Ç—å –ø—Ä–æ —Ä—É—á–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–Ω–æ –Ω–µ –ø—Ä–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É!).

---

## üß† –¢–µ–æ—Ä–∏—è: –æ—Ç `require` –∫ autoload

### –°—Ç–∞—Ä–∞—è —à–∫–æ–ª–∞: —Ä—É—á–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```ruby
# app/models/user.rb
require_relative "account"
require_relative "../lib/validators/email_validator"

class User
  # ...
end
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- **–•—Ä—É–ø–∫–æ—Å—Ç—å**: –∑–∞–±—ã–ª `require` ‚Äî –ø–æ–ª—É—á–∏–ª –æ—à–∏–±–∫—É.
- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å —Ç–æ—á–Ω—ã–π –ø—É—Ç—å –¥–æ —Ñ–∞–π–ª–∞.
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—ë —Å—Ä–∞–∑—É, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º.

### –ù–æ–≤—ã–π –º–∏—Ä: autoload –≤ Ruby

Ruby –¥–∞–≤–Ω–æ –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π `autoload`, –Ω–æ –æ–Ω:
- –¢—Ä–µ–±—É–µ—Ç —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç (`autoload :User, "models/user"`).
- –ù–µ —É–º–µ–µ—Ç –≤ namespace'—ã –±–µ–∑ –∫–æ—Å—Ç—ã–ª–µ–π.
- –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É –≤ development (–∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è Rails).

---

## üöÄ Zeitwerk: –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

Zeitwerk ‚Äî —ç—Ç–æ gem, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–∞–ª —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–º –≤ Rails 6+. –û–Ω:
1. –°–∫–∞–Ω–∏—Ä—É–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.
2. –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ —Å –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏ (`user.rb` ‚Üí `User`, `users/admin.rb` ‚Üí `Users::Admin`).
3. **–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–ª–∞—Å—Å—ã –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é**.

**–ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**

```ruby
# config/initializers/zeitwerk.rb
loader = Zeitwerk::Loader.new
loader.push_dir("app/models")
loader.push_dir("lib")
loader.setup # –≥–æ—Ç–æ–≤–æ!
```

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å—ã ‚Äî –æ–Ω–∏ –ø–æ–¥–≥—Ä—É–∑—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

```ruby
user = User.new # —Ñ–∞–π–ª app/models/user.rb –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —Å–∞–º
```

---

## üî• –ë–æ–ª—å—à–∏–µ –±–æ–ª–∏ –º–∞–ª–µ–Ω—å–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤

### 1. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è

**–ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω:**
```bash
app/
  models/
    user.rb
    user/
      admin.rb # –ë—É–¥–µ—Ç –ª–∏ —ç—Ç–æ User::Admin –∏–ª–∏ UserAdmin?
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ß—ë—Ç–∫–æ —Å–æ–±–ª—é–¥–∞—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ: `user/admin.rb` ‚Üí `User::Admin`.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `loader.collapse` –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤:

```ruby
loader.collapse("app/models/user") # —Ç–µ–ø–µ—Ä—å user/admin.rb ‚Üí UserAdmin
```

### 2. "–ú—ë—Ä—Ç–≤—ã–µ" —Ñ–∞–π–ª—ã

Zeitwerk –ø—Ä–æ–≤–µ—Ä—è–µ—Ç **–≤—Å–µ** —Ñ–∞–π–ª—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ. –ï—Å–ª–∏ –≤ `app/models/` –ª–µ–∂–∏—Ç `old_service.rb` –±–µ–∑ –∫–ª–∞—Å—Å–∞ `OldService` ‚Äî –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞.  

**–§–∏–∫—Å:**
- –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å.
- –ò—Å–∫–ª—é—á–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: `loader.ignore("app/legacy")`.

### 3. –ü—Ä–æ–±–ª–µ–º—ã —Å STI (Single Table Inheritance)

```ruby
# app/models/vehicle.rb
class Vehicle < ApplicationRecord
end

# app/models/vehicle/car.rb
class Vehicle::Car < Vehicle # –û—à–∏–±–∫–∞: Vehicle –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω!
end
```

**–†–µ—à–µ–Ω–∏–µ:**
- –Ø–≤–Ω–æ require —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–ª–∞—Å—Å:

```ruby
# app/models/vehicle/car.rb
require "vehicle"

class Vehicle::Car < Vehicle
end
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Zeitwerk

### RSpec + Zeitwerk = ‚ù§Ô∏è

```ruby
# spec/spec_helper.rb
require "zeitwerk"
loader = Zeitwerk::Loader.new
loader.push_dir("app")
loader.setup
```

**–ù–æ!** –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ:
- –¢–µ—Å—Ç—ã —Ç–µ–ø–µ—Ä—å –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–æ–≤.
- –ò–∑–±–µ–≥–∞–π—Ç–µ `require_relative` –≤ —Ç–µ—Å—Ç–∞—Ö ‚Äî —ç—Ç–æ –ª–æ–º–∞–µ—Ç –ª–æ–≥–∏–∫—É –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏.

---

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –º–∏—Ñ—ã –∏ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å

**–ú–∏—Ñ**: "Zeitwerk –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã".  
**–†–µ–∞–ª—å–Ω–æ—Å—Ç—å**:
- –í development ‚Äî –¥–∞, –∏–¥—ë—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏.
- –í production ‚Äî –Ω–µ—Ç, –ø—É—Ç–∏ –∫–µ—à–∏—Ä—É—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.

**–°–æ–≤–µ—Ç**: –î–ª—è –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (500+ –º–æ–¥–µ–ª–µ–π) –º–æ–∂–Ω–æ:
```ruby
loader.do_not_eager_load("app/models/concerns") # –æ—Ç–ª–æ–∂–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
```

---

## üé§ –ß—Ç–æ —Å–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏

> ‚Äî –ö–∞–∫ –≤—ã –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç–µ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É –∫–æ–¥–∞ –≤ Rails?

‚Äî –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º Zeitwerk, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–∞–ª —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–º –≤ Rails 6+. –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–±—ã—Ç—å –ø—Ä–æ —Ä—É—á–Ω—ã–µ `require`, —Å–ª–µ–¥—É—è —Å–æ–≥–ª–∞—à–µ–Ω–∏—é "–∏–º—è —Ñ–∞–π–ª–∞ = –∏–º—è –∫–ª–∞—Å—Å–∞". –î–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ `collapse`/`ignore`, –∞ –≤ —Ç–µ—Å—Ç–∞—Ö –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –æ–∂–∏–¥–∞–µ–º–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.

---

## üßæ –í—ã–≤–æ–¥

**Zeitwerk ‚Äî —ç—Ç–æ –∫–∞–∫ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∞—Å—Å–æ–≤.**  
–ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ:
- –ü–∏—Å–∞—Ç—å `require` –≤ –∫–∞–∂–¥–æ–º –≤—Ç–æ—Ä–æ–º —Ñ–∞–π–ª–µ.
- –†—É—á–∫–∞–º–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.
- –ë–æ—è—Ç—å—Å—è `NameError` –∏–∑-–∑–∞ –æ–ø–µ—á–∞—Ç–æ–∫ –≤ –ø—É—Ç—è—Ö.

–ù–æ –ø–æ–º–Ω–∏—Ç–µ: **–º–∞–≥–∏—è ‚Äî —ç—Ç–æ –Ω–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**. Zeitwerk –Ω–µ –∏–∑–±–∞–≤–ª—è–µ—Ç –æ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–¥—É–º—ã–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞, –∞ –ª–∏—à—å –¥–µ–ª–∞–µ—Ç –µ—ë –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–µ–Ω–µ–µ –±–æ–ª–µ–∑–Ω–µ–Ω–Ω–æ–π.

*P.S. –ï—Å–ª–∏ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –≤—Å—ë –µ—â—ë –Ω–∞ `require_relative` ‚Äî –≤—Ä–µ–º—è –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–∞! –ú–∏–≥—Ä–∞—Ü–∏—è –æ–±—ã—á–Ω–æ –∑–∞–Ω–∏–º–∞–µ—Ç 1-2 –¥–Ω—è –¥–∞–∂–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ–¥–æ–≤—ã—Ö –±–∞–∑.*
