---
layout: post
title:  "Debug, Benchmark, StackProf ‚Äî –∫–∞–∫ Ruby –ø–æ–º–æ–≥–∞–µ—Ç —Å–µ–±–µ —Å–∞–º"
rate: 3
tags: Ruby,Debug,Benchmark,StackProf,–æ—Ç–ª–∞–¥–∫–∞,–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
version: A49X3
date:   2024-09-18 12:00:00 +0300
categories:
  - performance
  - ruby
hero_image: /images/ruby.jpg
hero_darken: true
toc: true
menubar_toc: true
---

–í—ã –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –≤–∏–¥–µ–ª–∏, –∫–∞–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–ª–∞–¥–∏—Ç—å –∫–æ–¥, –¥–æ–±–∞–≤–ª—è—è `puts` –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ? –≠—Ç–æ –∫–∞–∫ –∏—Å–∫–∞—Ç—å —á—ë—Ä–Ω—É—é –∫–æ—à–∫—É –≤ —Ç—ë–º–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –∫–æ—à–∫–∞ ‚Äî —ç—Ç–æ —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ. –ö —Å—á–∞—Å—Ç—å—é, Ruby –¥–∞—ë—Ç –Ω–∞–º —Ü–µ–ª—ã–π –∞—Ä—Å–µ–Ω–∞–ª –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–∞–º–æ–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏. –°–µ–≥–æ–¥–Ω—è —Ä–∞–∑–±–µ—Ä—ë–º —Ç—Ä–∏ –∫–∏—Ç–∞: **Debug**, **Benchmark** –∏ **StackProf** ‚Äî –∏ –Ω–∞—É—á–∏–º—Å—è –Ω–µ —Ç—ã–∫–∞—Ç—å –≤ –∫–æ–¥ –Ω–∞—É–≥–∞–¥.

---

## üêû Debug: –∫–æ–≥–¥–∞ puts —É–∂–µ –Ω–µ —Å–º–µ—à–Ω–æ

### –¢–µ–æ—Ä–∏—è: –∑–∞—á–µ–º –Ω—É–∂–µ–Ω –¥–µ–±–∞–≥–≥–µ—Ä?

`puts` ‚Äî —ç—Ç–æ –∫–∞–∫ –∫—Ä–∏—á–∞—Ç—å "–≠–π, —è –∑–¥–µ—Å—å!" –≤ –∫–æ—Å–º–æ—Å–µ. –ê –¥–µ–±–∞–≥–≥–µ—Ä ‚Äî —ç—Ç–æ GPS —Å –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏. –í Ruby 3.1+ –ø–æ—è–≤–∏–ª—Å—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π `debug` –≥–µ–º, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç –æ—Ç–ª–∞–¥–∫—É –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–π.

**–ü—Ä–æ–±–ª–µ–º–∞**:  
```ruby
# app/services/payment_processor.rb
def process
  validate_amount! # –ø–∞–¥–∞–µ—Ç –≥–¥–µ-—Ç–æ –∑–¥–µ—Å—å... –Ω–æ –≥–¥–µ –∏–º–µ–Ω–Ω–æ?
  charge_card
  create_invoice
end
```

**–†–µ—à–µ–Ω–∏–µ**:  
```ruby
require "debug"

def process
  debugger # —Ç–æ—á–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
  validate_amount!
  binding.break # –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
  charge_card
end
```

–ó–∞–ø—É—Å–∫–∞–µ–º —Å `rdbg` –∏ –ø–æ–ª—É—á–∞–µ–º:
- –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∫–æ–Ω—Å–æ–ª—å
- –ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–µ–∫–∞ –≤—ã–∑–æ–≤–æ–≤
- –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –Ω–∞ –ª–µ—Ç—É

---

### –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–µ–±–∞–≥–∞

1. **"puts-driven development"**  
   ```ruby
   puts "–î–æ—à—ë–ª —Å—é–¥–∞, user_id = #{user.id}" # –ê –ø–æ—Ç–æ–º –∑–∞–±—ã–ª–∏ —É–¥–∞–ª–∏—Ç—å
   ```
2. **–î–µ–±–∞–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ**  
   –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Å—Ç–∞–≤–ª—è–π—Ç–µ `binding.pry` –≤ –∫–æ–¥–µ. –°–µ—Ä—å—ë–∑–Ω–æ, –Ω–∏–∫–æ–≥–¥–∞.

---

## ‚è± Benchmark: –∏–∑–º–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### –¢–µ–æ—Ä–∏—è: –ø–æ—á–µ–º—É Time.now ‚Äî –ø–ª–æ—Ö–∞—è –∏–¥–µ—è

–ó–∞–º–µ—Ä –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ `Time.now` ‚Äî —ç—Ç–æ –∫–∞–∫ –∏–∑–º–µ—Ä—è—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –ø–æ–¥–º—ã—à–∫–æ–π: –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Ü–∏—Ñ—Ä—ã, –Ω–æ –Ω–µ —Ç–æ—á–Ω—ã–µ. –í Ruby –µ—Å—Ç—å `Benchmark` –∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥**:  
```ruby
start = Time.now
1000.times { User.where(active: true).to_a }
puts "–ó–∞—Ç—Ä–∞—á–µ–Ω–æ: #{Time.now - start} —Å–µ–∫—É–Ω–¥"
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–º–µ—Ä**:  
```ruby
require "benchmark"

result = Benchmark.measure do
  1000.times { User.where(active: true).load }
end

puts result
#=> 0.020000   0.000000   0.020000 (  0.025678)
```
–í—ã–≤–æ–¥:  
- user CPU time  
- system CPU time  
- –æ–±—â–µ–µ –≤—Ä–µ–º—è  
- —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è

---

### –ü—Ä–∞–∫—Ç–∏–∫–∞: Benchmark IPS

–î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–≤—É—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º `benchmark-ips`:

```ruby
require "benchmark/ips"

Benchmark.ips do |x|
  x.report("with to_a") { User.where(active: true).to_a }
  x.report("with load") { User.where(active: true).load }
  x.compare!
end
```

–í—ã–≤–æ–¥:
```
Comparison:
       with load:      462.5 i/s
       with to_a:      428.6 i/s - 1.08x slower
```

---

## üî• StackProf: –Ω–∞—Ö–æ–¥–∏–º —É–∑–∫–∏–µ –º–µ—Å—Ç–∞

### –¢–µ–æ—Ä–∏—è: –ø—Ä–æ—Ñ–∞–π–ª–∏–Ω–≥ ‚Äî —ç—Ç–æ –Ω–µ —Ä–æ—Å–∫–æ—à—å

–ö–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç–æ—Ä–º–æ–∑–∏—Ç, –Ω–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ –≥–¥–µ ‚Äî –Ω—É–∂–µ–Ω –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä. `stackprof` ‚Äî sampling-–ø—Ä–æ—Ñ–∞–π–ª–µ—Ä –¥–ª—è Ruby, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:

- –ì–¥–µ —Ç—Ä–∞—Ç–∏—Ç—Å—è CPU
- –ö–∞–∫–∏–µ –º–µ—Ç–æ–¥—ã –≤—ã–∑—ã–≤–∞—é—Ç—Å—è —á–∞—â–µ –≤—Å–µ–≥–æ
- –ì–¥–µ –ø–∞–º—è—Ç—å —É—Ç–µ–∫–∞–µ—Ç –∫–∞–∫ –≤–æ–¥–∞

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞**:  
```bash
gem install stackprof
```

**–ó–∞–ø—É—Å–∫**:  
```ruby
require "stackprof"

StackProf.run(mode: :cpu, out: "tmp/stackprof.dump") do
  # –≤–∞—à –º–µ–¥–ª–µ–Ω–Ω—ã–π –∫–æ–¥
end
```

---

### –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

1. **–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç**:  
   ```bash
   stackprof tmp/stackprof.dump --text
   ```
   –ü–æ–∫–∞–∂–µ—Ç —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:
   ```
   Samples: 1000 (0.00% miss rate)
   GC: 50 (5.00%)
   TOTAL    (pct)     SAMPLES    (pct)     FRAME
     300  (30.0%)         200  (20.0%)     ActiveRecord::Relation#to_a
   ```

2. **Flamegraph**:  
   ```bash
   stackprof --flamegraph tmp/stackprof.dump > tmp/flamegraph.json
   ```
   –ò –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ https://speedscope.app

---

### –ë–æ–ª—å: –∫–æ–≥–¥–∞ –ø—Ä–æ—Ñ–∞–π–ª–∏–Ω–≥ –≤—Ä–µ—Ç

1. **–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ—Å—Ç—ã**  
   –ï—Å–ª–∏ –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–µ–Ω—å—à–µ 100–º—Å, sampling –º–æ–∂–µ—Ç –¥–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.

2. **–≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è**  
   –°–∞–º —Ñ–∞–∫—Ç –ø—Ä–æ—Ñ–∞–π–ª–∏–Ω–≥–∞ –∑–∞–º–µ–¥–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞.

---

## üß™ –ö–æ–º–±–æ: Debug + Benchmark + StackProf

**–†–µ–∞–ª—å–Ω—ã–π –∫–µ–π—Å**:  
API endpoint —Ç–æ—Ä–º–æ–∑–∏—Ç —Å 200–º—Å –¥–æ 2—Å –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π.

1. **Debugger**  
   –°—Ç–∞–≤–∏–º —Ç–æ—á–∫—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—Ä–µ–¥ –º–µ–¥–ª–µ–Ω–Ω—ã–º —É—á–∞—Å—Ç–∫–æ–º, —Å–º–æ—Ç—Ä–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤.

2. **Benchmark**  
   –ó–∞–º–µ—Ä—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
   ```ruby
   Benchmark.measure { Order.preload(:items).where(user: user) }
   ```

3. **StackProf**  
   –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä –Ω–∞ –ø–æ–ª–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ, –Ω–∞—Ö–æ–¥–∏–º N+1 –∑–∞–ø—Ä–æ—Å—ã –∏–ª–∏ —Ä–µ–∫—É—Ä—Å–∏—é.

---

## üéÅ –í—ã–≤–æ–¥—ã

1. **Debug** ‚Äî –¥–ª—è —Ç–æ—á–µ—á–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏ —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤  
2. **Benchmark** ‚Äî –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å –¥–≤–∞ –ø–æ–¥—Ö–æ–¥–∞  
3. **StackProf** ‚Äî –¥–ª—è –ø–æ–∏—Å–∫–∞ —É–∑–∫–∏—Ö –º–µ—Å—Ç –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ  

–ö–∞–∫ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –º—É–¥—Ä—ã–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:  
*"–ï—Å–ª–∏ –±—ã Ruby —É–º–µ–ª –≥–æ–≤–æ—Ä–∏—Ç—å, –æ–Ω –±—ã —Å–∞–º —Å–∫–∞–∑–∞–ª, –≥–¥–µ —É –Ω–µ–≥–æ –±–æ–ª–∏—Ç. –ù–æ –ø–æ–∫–∞ —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å —ç—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã."*

P.S. –ò –¥–∞, —É–¥–∞–ª–∏—Ç–µ –Ω–∞–∫–æ–Ω–µ—Ü —ç—Ç–∏ `puts` –∏–∑ –∫–æ–¥–∞.
