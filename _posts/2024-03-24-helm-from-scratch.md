---
layout: post
subtitle: <div id="terminal"></div>
title: "Helm —Å –Ω—É–ª—è: —á–∞—Ä—Ç—ã, values –∏ –¥–µ–ø–ª–æ–π –∫–∞–∫ —É –±–æ–ª—å—à–∏—Ö"
date: 2024-03-24 12:00:00 +0300
rate: 4
tags: Kubernetes, Helm, DevOps, Deployment, CI/CD
version: A9X
categories:
  - devops
  - architecture
hero_image: /images/ruby.jpg
hero_darken: true
toc: true
menubar_toc: true
---
Helm ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è Kubernetes, –∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –≤–∞—à `kubectl apply -f` –≤ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏. –í —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å —á–∞—Ä—Ç—ã, —Ä–∞–±–æ—Ç–∞—Ç—å —Å values.yaml –∏ –¥–µ–ø–ª–æ–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±–µ–∑ –≥–æ–ª–æ–≤–Ω–æ–π –±–æ–ª–∏, –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞—é—Ç –≤ production-—Å—Ä–µ–¥–∞—Ö.

---
–í—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª–∏ `kubectl apply -f deployment.yaml` –≤ —Ç—Ä–µ—Ç–∏–π —Ä–∞–∑ –∑–∞ —á–∞—Å, –ø–æ—Ç–æ–º—É —á—Ç–æ –∑–∞–±—ã–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–µ–ø–ª–∏–∫–∏ –∏–ª–∏ –≤–µ—Ä—Å–∏—é –æ–±—Ä–∞–∑–∞.  
–ü–æ–∑–¥—Ä–∞–≤–ª—è—é, –≤—ã –≥–æ—Ç–æ–≤—ã –∫ Helm!

---

## üß† –¢–µ–æ—Ä–∏—è: —á—Ç–æ —Ç–∞–∫–æ–µ Helm?

Helm ‚Äî —ç—Ç–æ **–ø–∞–∫–µ—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è Kubernetes**, –∫–æ—Ç–æ—Ä—ã–π:
- –£–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –≤ **—á–∞—Ä—Ç—ã** (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `.deb`/`.rpm`).
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥–∏ —á–µ—Ä–µ–∑ **values.yaml**.
- –£–ø—Ä–∞–≤–ª—è–µ—Ç –≤–µ—Ä—Å–∏—è–º–∏ —á–µ—Ä–µ–∑ **—Ä–µ–ª–∏–∑—ã** (releases).

–ü–æ —Å—É—Ç–∏, —ç—Ç–æ `Bundler` –¥–ª—è –≤–∞—à–µ–≥–æ Kubernetes.

---

## üîß –ü–µ—Ä–≤—ã–π —á–∞—Ä—Ç: –æ—Ç `helm create` –¥–æ –¥–µ–ø–ª–æ—è

–°–æ–∑–¥–∞—ë–º —Å–∫–µ–ª–µ—Ç —á–∞—Ä—Ç–∞:

```bash
helm create my-rails-app
```

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª—É—á–∏—Ç—Å—è —Ç–∞–∫–æ–π:

```
my-rails-app/
‚îú‚îÄ‚îÄ charts/          # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ Chart.yaml       # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–∫–∞–∫ Gemfile)
‚îú‚îÄ‚îÄ templates/       # –®–∞–±–ª–æ–Ω—ã –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ deployment.yaml
‚îÇ   ‚îú‚îÄ‚îÄ service.yaml
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ values.yaml      # –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
```

---

## üí° –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç values.yaml?

–≠—Ç–æ **—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥** –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤. –ü—Ä–∏–º–µ—Ä:

```yaml
# values.yaml
replicaCount: 3
image:
  repository: myregistry/rails-app
  tag: latest
  pullPolicy: IfNotPresent
service:
  type: ClusterIP
  port: 3000
```

–ê –≤ —à–∞–±–ª–æ–Ω–µ (`templates/deployment.yaml`) –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∞–∫:

{% raw %}
```yaml
spec:
  replicas: {{ .Values.replicaCount }}
  containers:
    - image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
```
{% endraw %}

---

## üöÄ –î–µ–ø–ª–æ–π: 3 —Å–ø–æ—Å–æ–±–∞

1. **–õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç** (–ø—Ä–æ–≤–µ—Ä–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤):
   ```bash
   helm install --dry-run --debug my-release ./my-raws-app
   ```

2. **–ü—Ä–æ–¥–∞–∫—à–Ω-–¥–µ–ø–ª–æ–π**:
   ```bash
   helm upgrade --install my-release ./my-rails-app \
     --set image.tag="v1.2.3" \
     --set replicaCount=5
   ```

3. **–ß–µ—Ä–µ–∑ CI/CD** (–Ω–∞–ø—Ä–∏–º–µ—Ä, GitLab):
   ```yaml
   deploy:
     script:
       - helm upgrade --install $CI_PROJECT_NAME ./chart \
           --set image.tag=$CI_COMMIT_SHA
   ```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –æ—Ç –ª–∏–Ω—Ç–µ—Ä–æ–≤ –¥–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞**:
   ```bash
   helm lint ./my-rails-app
   ```

2. **Unit-—Ç–µ—Å—Ç—ã** (–∏—Å–ø–æ–ª—å–∑—É–µ–º `helm-unittest`):

   ```yaml
   # tests/deployment_test.yaml
   suite: test deployment
   templates:
     - deployment.yaml
   tests:
     - it: should have 3 replicas
       set:
         replicaCount: 3
       asserts:
         - equal:
             path: spec.replicas
             value: 3
   ```

---

## üî• –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã

{% raw %}

| –û—à–∏–±–∫–∞                          | –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è                     | –†–µ—à–µ–Ω–∏–µ                                                |
|---------------------------------|---------------------------------|--------------------------------------------------------|
| –û–¥–∏–Ω –≥–∏–≥–∞–Ω—Ç—Å–∫–∏–π values.yaml     | –ù–µ—á–∏—Ç–∞–µ–º–æ—Å—Ç—å, –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã         | –†–∞–∑–¥–µ–ª—è—Ç—å –Ω–∞ env-—Ñ–∞–π–ª—ã                                 |
| –ñ—ë—Å—Ç–∫–∏–µ —Ç–µ–≥–∏ (`tag: latest`)    | –ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –¥–µ–ø–ª–æ—è        | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `tag: {{ .Chart.AppVersion }}` |
| 100500 –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ requirements.yaml | –°–ª–æ–∂–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π | –ü—Ä–æ–≤–µ—Ä—è—Ç—å `helm dependency update`                     |


{% endraw %}
---

## üé§ –ß—Ç–æ —Å–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏

> ‚Äî –ö–∞–∫ –≤—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ –∫–æ–Ω—Ñ–∏–≥–∞–º–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π?

‚Äî –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º Helm —Å –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω—ã–º–∏ values:  
`values.yaml` (–±–∞–∑–∞) ‚Üí `values-prod.yaml` (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è) ‚Üí `--set` (—ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∫–∏).  
–ü–ª—é—Å `helmfile` –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

---

## üßæ –í—ã–≤–æ–¥

**Helm ‚Äî —ç—Ç–æ –≤–∞—à "kubectl –Ω–∞ —Å—Ç–µ—Ä–æ–∏–¥–∞—Ö".**  
–û–Ω –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Ä—É—Ç–∏–Ω—É –≤ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å, –≥–¥–µ:
- –ö–æ–Ω—Ñ–∏–≥–∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä—É—é—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –∫–æ–¥–æ–º.
- –î–µ–ø–ª–æ–π —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º.
- –ê –≤—ã –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç–µ –ø—É—Ç–∞—Ç—å—Å—è, –∫–∞–∫–æ–π `yaml` –∫—É–¥–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç—å.

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –¥–µ–ø–ª–æ–∏—Ç—å –±–µ–∑ –º–æ–ª–∏—Ç–≤ –∏ –∫–æ—Ñ–µ-–±—Ä–µ–π–∫–æ–≤ –≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏.
