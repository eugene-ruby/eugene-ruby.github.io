---
layout: post
subtitle: <div id="terminal"></div>
title:  "XSS-–∞—Ç–∞–∫–∏ –∏ erb: –∫–∞–∫ Rails —Å–ø–∞—Å–∞–µ—Ç, –∞ –∫–æ–≥–¥–∞ ‚Äî –Ω–µ—Ç"
date:   2024-09-18 12:00:00 +0300
rate: 2
tags: Ruby on Rails, –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, XSS, ERB, PostgreSQL, –í–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
version: A49X3
categories:
  - security
  - rails
hero_image: /images/rails.jpg
hero_darken: true
toc: true
menubar_toc: true
---

XSS (Cross-Site Scripting) ‚Äî –æ–¥–Ω–∞ –∏–∑ —Å–∞–º—ã—Ö —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –ø–æ–∑–≤–æ–ª—è—é—â–∞—è –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞–º –≤–Ω–µ–¥—Ä—è—Ç—å –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–¥ –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. Rails –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –∑–∞—â–∏—Ç—ã, –Ω–æ –¥–∞–∂–µ –æ–Ω–∏ –∏–Ω–æ–≥–¥–∞ –¥–∞—é—Ç —Å–±–æ–π. –†–∞–∑–±–µ—Ä—ë–º—Å—è, –∫–∞–∫ ERB –∏ Rails –±–æ—Ä—é—Ç—Å—è —Å XSS, –∏ –≥–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∞–º–∏ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –¥–≤–µ—Ä–∏ –¥–ª—è –∞—Ç–∞–∫.

---

## üîí –ö–∞–∫ Rails –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç XSS –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ ERB
Rails –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ERB (Embedded Ruby) –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤, –∏ **–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è**:

```erb
<%= @user_input %> <!-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ: < –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—Å—è –≤ &lt; -->
```

–≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è –º–µ—Ç–æ–¥—É `html_escape`, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫, –Ω–µ –ø–æ–º–µ—á–µ–Ω–Ω—ã—Ö –∫–∞–∫ "–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ".

### `raw` –∏ `html_safe`: –∫–æ–≥–¥–∞ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è
–ù–æ –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ "–±–µ–∑–æ–ø–∞—Å–Ω–∞", —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è:

```erb
<%= raw @user_input %> <!-- –û–ø–∞—Å–Ω–æ! -->
<%= @user_input.html_safe %> <!-- –¢–æ–∂–µ –æ–ø–∞—Å–Ω–æ! -->
```

**–ü—Ä–∏–º–µ—Ä —É—è–∑–≤–∏–º–æ—Å—Ç–∏:**
```ruby
# –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
def show
  @comment = params[:comment]
end
```

```erb
<!-- –í—å—é—Ö–∞ -->
<div class="comment">
  <%= raw @comment %> <!-- XSS-–∞—Ç–∞–∫–∞ –≤–æ–∑–º–æ–∂–Ω–∞! -->
</div>
```

---

## üí• –ì–¥–µ —á–∞—â–µ –≤—Å–µ–≥–æ –æ—à–∏–±–∞—é—Ç—Å—è

### 1. JSON –≤ JavaScript
```erb
<script>
  var data = <%= raw @user_data.to_json %>; <!-- –£—è–∑–≤–∏–º–æ—Å—Ç—å! -->
</script>
```
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `json_escape` –∏–ª–∏ `to_json.html_safe` —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é.

### 2. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ CSS/JavaScript
```erb
<style>
  .profile { background: url(<%= @user_background %>); }
</style>
```
**–ê—Ç–∞–∫–∞:** `@user_background = 'red;}</style><script>alert(1)</script><style>'`.

### 3. –û—à–∏–±–∫–∏ –≤ —Ö–µ–ª–ø–µ—Ä–∞—Ö
```ruby
def custom_link(text, url)
  "<a href='#{url}'>#{text}</a>".html_safe
end
```
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è `text` –∏ `url`.

---

## üõ°Ô∏è –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è: –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –í—Å–µ–≥–¥–∞ —ç–∫—Ä–∞–Ω–∏—Ä—É–π—Ç–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```erb
<%= @user_input %> <!-- –¢–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ -->
```

### 2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `sanitize` –¥–ª—è HTML
```erb
<%= sanitize @user_html, tags: %w[a b i], attributes: %w[href] %>
```

### 3. Content Security Policy (CSP)
–î–æ–±–∞–≤—å—Ç–µ –≤ `config/initializers/content_security_policy.rb`:
```ruby
Rails.application.config.content_security_policy do |policy|
  policy.default_src :self
  policy.script_src :self, :https
end
```

### 4. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –≤ JavaScript
```erb
<script>
  var data = <%= @user_data.to_json.html_escape %>;
</script>
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞—â–∏—Ç—É

### –¢–µ—Å—Ç –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç—å –≤ RSpec
```ruby
describe "CommentsController" do
  it "—ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç HTML –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö" do
    post :create, params: { comment: '<script>alert(1)</script>' }
    expect(response.body).not_to include('<script>')
  end
end
```

### –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Brakeman
–î–æ–±–∞–≤—å—Ç–µ –≤ Gemfile:
```ruby
gem 'brakeman', require: false
```
–ò –∑–∞–ø—É—Å—Ç–∏—Ç–µ:
```bash
brakeman -q -w2
```

---

## üé§ –ß—Ç–æ —Å–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏

> ‚Äî –ö–∞–∫ Rails –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç XSS?

‚Äî ERB –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏, –Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –º–æ–∂–µ—Ç –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç—É —á–µ—Ä–µ–∑ `raw` –∏–ª–∏ `html_safe`. –í–∞–∂–Ω–æ –∏–∑–±–µ–≥–∞—Ç—å –≤—Å—Ç–∞–≤–∫–∏ –Ω–µ–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ JavaScript/CSS –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CSP.

---

## üßæ –í—ã–≤–æ–¥

Rails –¥–∞—ë—Ç –æ—Ç–ª–∏—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç XSS, –Ω–æ –æ–Ω–∏ —Ç—Ä–µ–±—É—é—Ç –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –Ω–µ –≤–æ–ª—à–µ–±–Ω–∞—è –ø–∞–ª–æ—á–∫–∞**, –∞ `html_safe` ‚Äî –Ω–µ "—É–¥–æ–±–Ω–∞—è —Ñ–∏—á–∞", –∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –¥—ã—Ä–∞. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –¥–∞–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ CSP –∏ –ø–æ–º–Ω–∏—Ç–µ: –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å, –∞ –Ω–µ —Ä–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞.
