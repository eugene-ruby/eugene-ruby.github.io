---
layout: post
subtitle: <div id="terminal"></div>
title:  "ü™¢ –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç–æ–¥—ã Ruby: eval, binding –∏ tap ‚Äî –∫–æ–≥–¥–∞ –∏ –∑–∞—á–µ–º?"
date:   2025-04-28 12:00:00 +0300
rate: 4
tags: Ruby,–º–µ—Ç–∞–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ,–æ—Ç–ª–∞–¥–∫–∞,—Ä–µ—Ñ–ª–µ–∫—Å–∏—è
version: 3.2.2
categories:
  - ruby
hero_image: /images/posts/78.jpg
hero_darken: true
toc: true
menubar_toc: true
---

Ruby ‚Äî —è–∑—ã–∫ —Å –±–æ–≥–∞—Ç—ã–º–∏ –º–µ—Ç–∞–ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏, –Ω–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –µ–≥–æ –º–µ—Ç–æ–¥—ã –≤—ã–∑—ã–≤–∞—é—Ç —Å–≤—è—â–µ–Ω–Ω—ã–π —É–∂–∞—Å —É –Ω–æ–≤–∏—á–∫–æ–≤ –∏ –≤–æ—Å—Ç–æ—Ä–≥ —É –æ–ø—ã—Ç–Ω—ã—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤. –°–µ–≥–æ–¥–Ω—è —Ä–∞–∑–±–µ—Ä—ë–º —Ç—Ä–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: `eval`, `binding` –∏ `Kernel#tap` ‚Äî –ø–æ–∫–∞–∂–µ–º –∏—Ö —Å–∏–ª—É, –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–µ–π—Å—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.

---

## üîÆ `eval` ‚Äî –º–∞–≥–∏—è —Å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è–º–∏

**–ß—Ç–æ —ç—Ç–æ?**  
–ú–µ—Ç–æ–¥ `eval` –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å—Ç—Ä–æ–∫—É –∫–∞–∫ Ruby-–∫–æ–¥. –≠—Ç–æ –∫–∞–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π `require`, –Ω–æ —Å –ø—Ä—è–º—ã–º –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ç–µ–∫—É—â–µ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É.

### üíº –ü—Ä–∏–º–µ—Ä: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —É—Å–ª–æ–≤–∏—è
```ruby
filters = { min_price: 100, category: "books" }
query = Product.all

filters.each do |key, value|
  query = query.where(eval("#{key} = ?"), value) # –û–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–±!
end
```
**–ü—Ä–æ–±–ª–µ–º–∞**: SQL-–∏–Ω—ä–µ–∫—Ü–∏—è —á–µ—Ä–µ–∑ `eval` ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å.

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞
```ruby
filters.each do |key, value|
  query = query.where("#{key} = ?", value) if Product.column_names.include?(key.to_s)
end
```

### üß® –ö–æ–≥–¥–∞ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
- –ü–∞—Ä—Å–∏–Ω–≥ JSON/XML (–µ—Å—Ç—å `JSON.parse`)
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ—Ç–æ–¥–æ–≤ (–ª—É—á—à–µ `define_method`)

**–í—ã–≤–æ–¥:** `eval` ‚Äî —ç—Ç–æ "—Ö–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–∏–π —Å–∫–∞–ª—å–ø–µ–ª—å". –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —Ç–∞–º, –≥–¥–µ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –ø—É—Ç–µ–π.

---

## üïµÔ∏è‚Äç‚ôÇÔ∏è `binding` ‚Äî –∑–∞–º–æ—á–Ω–∞—è —Å–∫–≤–∞–∂–∏–Ω–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç

**–ß—Ç–æ —ç—Ç–æ?**  
–û–±—ä–µ–∫—Ç `binding` ‚Äî —ç—Ç–æ "—Å–Ω–∏–º–æ–∫" —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –º–µ—Ç–æ–¥—ã, `self`).

### üíº –ü—Ä–∏–º–µ—Ä: –æ—Ç–ª–∞–¥–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
```ruby
def calculate_discount(user, items)
  discount = 0
  # ... 20 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∏–∫–∏ ...
  binding.irb # –°—é–¥–∞ —É–ø–∞–¥—ë—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–æ–Ω—Å–æ–ª—å!
  apply_discount(discount)
end
```
**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:** –í—ã–∑–æ–≤ `binding.irb` –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç REPL –ø—Ä—è–º–æ –≤ –º–µ—Å—Ç–µ –≤—ã–∑–æ–≤–∞, –≥–¥–µ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.

### üõ† –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:
1. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —à–∞–±–ª–æ–Ω—ã** (ERB):
```ruby
template = ERB.new("–ü—Ä–∏–≤–µ—Ç, <%= name %>!")
name = "–ê–Ω—Ç–æ–Ω"
template.result(binding) #=> "–ü—Ä–∏–≤–µ—Ç, –ê–Ω—Ç–æ–Ω!"
```

2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤**:
```ruby
it "test with context" do
  user = create(:user)
  b = binding
  expect(b.eval("user.name")).to eq("Test User")
end
```

**–í—ã–≤–æ–¥:** `binding` ‚Äî –≤–∞—à "—á–µ—Ä–Ω—ã–π —è—â–∏–∫" –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –º–µ—Ç–∞–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è.

---

## üö∞ `Kernel#tap` ‚Äî —Ç—Ä—É–±–∞ –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤

**–ß—Ç–æ —ç—Ç–æ?**  
–ú–µ—Ç–æ–¥ `tap` –ø–µ—Ä–µ–¥–∞—ë—Ç –æ–±—ä–µ–∫—Ç –≤ –±–ª–æ–∫ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∞–º –æ–±—ä–µ–∫—Ç. –≠—Ç–æ –∫–∞–∫ "—Ç—Ä–æ–π–Ω–∏–∫" –≤ —ç–ª–µ–∫—Ç—Ä–æ—Å–µ—Ç–∏ ‚Äî –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å, —á—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞–ª–∏, –Ω–æ —Ç–æ–∫ –∏–¥—ë—Ç –¥–∞–ª—å—à–µ.

### üíº –ü—Ä–∏–º–µ—Ä: –æ—Ç–ª–∞–¥–∫–∞ —Ü–µ–ø–æ—á–µ–∫
```ruby
User
  .active
  .tap { |users| puts "–ù–∞–π–¥–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö: #{users.count}" }
  .select(&:has_orders?)
```

### üèó –ü–∞—Ç—Ç–µ—Ä–Ω: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø–æ–±–æ—á–Ω—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏
```ruby
def create_config
  Config.new.tap do |c|
    c.set_defaults
    c.connect!
    Rails.logger.info "Config ##{c.id} created"
  end
end
```

### ‚ùå –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω:
```ruby
# –ü–ª–æ—Ö–æ: tap –¥–ª—è –ª–æ–≥–∏–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
user.tap do |u|
  u.update(role: :admin) # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true/false, –Ω–æ tap –≤–µ—Ä–Ω—ë—Ç user
end
```

**–í—ã–≤–æ–¥:** `tap` –∏–¥–µ–∞–ª–µ–Ω –¥–ª—è:
- –û—Ç–ª–∞–¥–∫–∏ –±–µ–∑ —Ä–∞–∑—Ä—ã–≤–∞ —Ü–µ–ø–æ—á–µ–∫
- –ü–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- –ö—Ä–∞—Å–∏–≤—ã—Ö DSL-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π

---

## üß™ –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –ú–µ—Ç–æ–¥      | –ò–∑–º–µ–Ω—è–µ—Ç –æ–±—ä–µ–∫—Ç? | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç      | –†–∏—Å–∫–∏               |
|------------|------------------|-----------------|---------------------|
| `eval`     | –î–∞ (–∫–æ–Ω—Ç–µ–∫—Å—Ç)    | –†–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–¥–∞  | –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å        |
| `binding`  | –ù–µ—Ç              | Binding object  | –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏       |
| `tap`      | –î–∞ (–º–æ–∂–Ω–æ)       | –ò—Å—Ö–æ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç | –ù–µ–æ—á–µ–≤–∏–¥–Ω—ã–π –∫–æ–¥     |

---

## üéØ –ö–æ–≥–¥–∞ —á—Ç–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å?

1. **`eval`** ‚Äî –¥–ª—è DSL, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–µ–º `RSpec` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–ª—è –º–∞—Ç—á–µ—Ä–æ–≤).
2. **`binding`** ‚Äî –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –æ—Ç–ª–∞–¥–∫–∏ –∏ —à–∞–±–ª–æ–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤.
3. **`tap`** ‚Äî –¥–ª—è —Ü–µ–ø–æ—á–µ–∫ –≤—ã–∑–æ–≤–æ–≤ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤ —Å —Å–∞–π–¥-—ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏.

---

## üö® –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ

–í—Å–µ —Ç—Ä–∏ –º–µ—Ç–æ–¥–∞ ‚Äî –æ—Å—Ç—Ä—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã. –ü—Ä–µ–∂–¥–µ —á–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, —Å–ø—Ä–æ—Å–∏—Ç–µ:
- –ï—Å—Ç—å –ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞?
- –ü–æ–Ω—è—Ç–Ω–æ –ª–∏ —ç—Ç–æ –±—É–¥–µ—Ç –∫–æ–ª–ª–µ–≥–∞–º?
- –ù–µ –Ω–∞—Ä—É—à–∞–µ—Ç –ª–∏ —ç—Ç–æ –∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—é?
