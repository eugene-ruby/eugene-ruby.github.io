---
layout: post
title:  "YJIT –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å Ruby 3+: —Å—Ç–æ–∏—Ç –ª–∏ —Ç–æ–≥–æ?"
rate: 3
tags: Ruby,YJIT,–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è,–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å,JIT-–∫–æ–º–ø–∏–ª—è—Ü–∏—è,–ø—Ä–æ–¥–∞–∫—à–µ–Ω
version: A49X3
date:   2024-09-20 12:00:00 +0300
categories:
  - performance
  - ruby
hero_image: /images/ruby.jpeg
hero_darken: true
toc: true
menubar_toc: true
---

YJIT ‚Äî —ç—Ç–æ –∫–∞–∫ —Ç—É—Ä–±–æ–Ω–∞–¥–¥—É–≤ –¥–ª—è –≤–∞—à–µ–≥–æ Ruby-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ù–æ –ø—Ä–µ–∂–¥–µ —á–µ–º –±—Ä–æ—Å–∞—Ç—å—Å—è –≤–∫–ª—é—á–∞—Ç—å –µ–≥–æ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ, –¥–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º—Å—è: –∫–æ–≥–¥–∞ –æ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–∞—ë—Ç –ø—Ä–∏—Ä–æ—Å—Ç, –∞ –∫–æ–≥–¥–∞ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ "—Ä–∞–∑–æ–≥–Ω–∞–Ω–Ω—ã–π —Ç–æ—Å—Ç–µ—Ä" ‚Äî —à—É–º–∏—Ç –º–Ω–æ–≥–æ, –∞ —Ç–æ–ª–∫—É –º–∞–ª–æ.

---

## ÔøΩ –ë–æ–ª—å: Ruby –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –≤–µ—á–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è

–ü–æ–º–Ω–∏—Ç–µ —ç—Ç–∏ –¥–Ω–∏, –∫–æ–≥–¥–∞ –≤–∞—à Rails-—Å–µ—Ä–≤–∏—Å –Ω–∞—á–∏–Ω–∞–ª –∑–∞–¥—ã—Ö–∞—Ç—å—Å—è –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π, –∞ –≤—ã –≤ –ø–∞–Ω–∏–∫–µ –¥–æ–±–∞–≤–ª—è–ª–∏ `includes`, –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –∏ –º–æ–ª–∏–ª–∏—Å—å Nginx'—É? 

```ruby
# –¢–∏–ø–∏—á–Ω—ã–π "—É–∑–∫–∏–π" —É—á–∞—Å—Ç–æ–∫
User.joins(:posts).where("posts.created_at > ?", 1.week.ago).each do |user|
  user.calculate_loyalty_score # 100500 –∏—Ç–µ—Ä–∞—Ü–∏–π
end
```

–î–æ Ruby 3.x –º—ã –∂–∏–ª–∏ –≤ –º–∏—Ä–µ, –≥–¥–µ:
- **MRI (CRuby)** ‚Äî —É–¥–æ–±–µ–Ω, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω—ã–π,
- **JRuby** ‚Äî –±—ã—Å—Ç—Ä—ã–π, –Ω–æ —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏,
- **TruffleRuby** ‚Äî –º–∞–≥–∏—è, –Ω–æ —Å–ª–æ–∂–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞.

–ò –≤–æ—Ç –ø–æ—è–≤–∏–ª—Å—è **YJIT** ‚Äî –æ–±–µ—â–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –±–µ–∑ –±–æ–ª–∏. –ù–æ —Ç–∞–∫ –ª–∏ —ç—Ç–æ?

---

## üöÄ –ß—Ç–æ —Ç–∞–∫–æ–µ YJIT?

**YJIT (Yet Another Just-In-Time Compiler)** ‚Äî —ç—Ç–æ JIT-–∫–æ–º–ø–∏–ª—è—Ç–æ—Ä, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ Ruby 3.1+. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç MJIT (–ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏), –æ–Ω:

- –ö–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç "–≥–æ—Ä—è—á–∏–µ" —É—á–∞—Å—Ç–∫–∏ –∫–æ–¥–∞ –≤ –º–∞—à–∏–Ω–Ω—ã–π –∫–æ–¥ **–≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**,
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (–Ω–µ —Ç–æ–ª—å–∫–æ —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤),
- –¢—Ä–µ–±—É–µ—Ç **–º–µ–Ω—å—à–µ –ø–∞–º—è—Ç–∏**, —á–µ–º MJIT.

–ù–æ –≥–ª–∞–≤–Ω–æ–µ ‚Äî –æ–±–µ—â–∞–Ω–∏–µ **—É—Å–∫–æ—Ä–µ–Ω–∏—è –Ω–∞ 10-30%** –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á.

---

## üîß –ö–∞–∫ –≤–∫–ª—é—á–∏—Ç—å YJIT?

–ü—Ä–æ—â–µ, —á–µ–º –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Sidekiq:

```bash
# –ó–∞–ø—É—Å–∫ Ruby —Å YJIT
RUBYOPT="--yjit" rails server

# –ò–ª–∏ –≤ –∫–æ–¥–µ
RubyVM::YJIT.enable
```

–ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç:

```ruby
RubyVM::YJIT.enabled? # => true
```

---

## üèéÔ∏è –¢–µ—Å—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ: YJIT vs –±–µ–∑ –Ω–µ–≥–æ

–í–æ–∑—å–º—ë–º —Ç–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

### 1. –¶–∏–∫–ª—ã —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π

```ruby
def calculate_stats
  users = User.active.limit(10_000)
  users.each { |user| user.update!(score: complex_calculation(user)) }
end
```

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- **–ë–µ–∑ YJIT**: 14.2 —Å–µ–∫
- **–° YJIT**: 11.8 —Å–µ–∫ (**~17% –±—ã—Å—Ç—Ä–µ–µ**)

### 2. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ JSON API

```ruby
get "/api/v1/posts" do
  Post.limit(100).to_json
end
```
- **–ë–µ–∑ YJIT**: 890 RPS
- **–° YJIT**: 1020 RPS (**~15% –ø—Ä–∏—Ä–æ—Å—Ç**)

### 3. ActiveRecord-–∑–∞–ø—Ä–æ—Å—ã

```ruby
User.includes(:posts).where(posts: { likes_count: 100.. }).find_each(&:profile)
```
–ó–¥–µ—Å—å —Ä–∞–∑–Ω–∏—Ü–∞ –≤—Å–µ–≥–æ **2-5%** ‚Äî YJIT –ø–æ—á—Ç–∏ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—Ä–µ–º—è SQL.

---

## üìâ –ö–æ–≥–¥–∞ YJIT –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω (–∏–ª–∏ –≤—Ä–µ–¥–µ–Ω)

1. **–ö–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã** (Rake-–∑–∞–¥–∞—á–∏, CLI-—Å–∫—Ä–∏–ø—Ç—ã)  
   –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏—é –º–æ–∂–µ—Ç –ø–µ—Ä–µ–≤–µ—Å–∏—Ç—å –≤—ã–≥–æ–¥—É.

2. **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å —É–∑–∫–∏–º SQL-–±—É—Ç—ã–ª–æ—á–Ω—ã–º –≥–æ—Ä–ª—ã—à–∫–æ–º**  
   –ï—Å–ª–∏ —É –≤–∞—Å 80% –≤—Ä–µ–º–µ–Ω–∏ ‚Äî —ç—Ç–æ `N+1` –∑–∞–ø—Ä–æ—Å—ã, YJIT –Ω–µ —Å–ø–∞—Å—ë—Ç.

3. **–°–∏—Å—Ç–µ–º—ã —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç—å—é**  
   YJIT –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ ~10-30MB RAM.

4. **Ruby < 3.1**  
   –í —Ä–∞–Ω–Ω–∏—Ö –≤–µ—Ä—Å–∏—è—Ö –æ–Ω –±—ã–ª —Å—ã—Ä–æ–π –∏ –º–æ–≥ –¥–∞–∂–µ –∑–∞–º–µ–¥–ª—è—Ç—å —Ä–∞–±–æ—Ç—É.

---

## üß™ –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –í–∫–ª—é—á–µ–Ω–∏–µ "–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π"

```ruby
# config/initializers/yjit.rb
RubyVM::YJIT.enable if Rails.env.production?
```
**–ü—Ä–æ–±–ª–µ–º–∞**: –±–µ–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤—ã –Ω–µ —É–∑–Ω–∞–µ—Ç–µ, –ø–æ–º–æ–≥–∞–µ—Ç –ª–∏ —ç—Ç–æ.

### 2. –û–∂–∏–¥–∞–Ω–∏–µ —á—É–¥–∞

"–í–∫–ª—é—á–∏–ª YJIT, –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Å—ë —Ä–∞–≤–Ω–æ —Ç–æ—Ä–º–æ–∑–∏—Ç" ‚Äî –∑–Ω–∞—á–∏—Ç, –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∞–ª–≥–æ—Ä–∏—Ç–º–∞—Ö, –∞ –Ω–µ –≤ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–µ.

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Ruby

YJIT –≤ Ruby 3.3 —Ä–∞–±–æ—Ç–∞–µ—Ç **–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ** –ª—É—á—à–µ, —á–µ–º –≤ 3.1.

---

## üõ†Ô∏è –ü—Ä–∞–∫—Ç–∏–∫–∞: –∫–∞–∫ –≤–Ω–µ–¥—Ä—è—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ

1. **–ó–∞–º–µ—Ä—è–µ–º –¥–æ/–ø–æ—Å–ª–µ** (–∏—Å–ø–æ–ª—å–∑—É–µ–º `benchmark-ips` –∏–ª–∏ `rbspy`):

```ruby
require 'benchmark/ips'

Benchmark.ips do |x|
  x.report("without YJIT") { some_code }
  x.report("with YJIT") { RubyVM::YJIT.enable; some_code }
end
```

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–º –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ**:
   - –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ (CPU, RAM, RPS) –¥–æ –∏ –ø–æ—Å–ª–µ,
   - –ò—Å–ø–æ–ª—å–∑—É–µ–º Datadog/NewRelic –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞.

3. **A/B-—Ç–µ—Å—Ç–∏—Ä—É–µ–º**:
   –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —á–∞—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å YJIT, —á–∞—Å—Ç—å ‚Äî –±–µ–∑.

---

## üé§ –ß—Ç–æ —Å–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏

> ‚Äî –ö–∞–∫–∏–µ –≤—ã –∑–Ω–∞–µ—Ç–µ —Å–ø–æ—Å–æ–±—ã —É—Å–∫–æ—Ä–∏—Ç—å Ruby-–∫–æ–¥?

‚Äî –ù–∞—á–∏–Ω–∞—è —Å Ruby 3.1, YJIT –¥–∞—ë—Ç –ø—Ä–∏—Ä–æ—Å—Ç –¥–æ 30% –¥–ª—è CPU-bound –∑–∞–¥–∞—á. –ù–æ –≤–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ –æ–Ω –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –∏ —Ä–∞–±–æ—Ç—É —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –í –Ω–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ –æ–Ω —É—Å–∫–æ—Ä–∏–ª API-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –Ω–∞ 15%, –Ω–æ –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏.

---

## üßÆ –í—ã–≤–æ–¥: —Å—Ç–æ–∏—Ç –ª–∏?

**–î–∞, –µ—Å–ª–∏:**
- –£ –≤–∞—Å Ruby ‚â• 3.1 (–ª—É—á—à–µ 3.3+),
- –ï—Å—Ç—å CPU-bound –∑–∞–¥–∞—á–∏ (—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥, –≤—ã—á–∏—Å–ª–µ–Ω–∏—è),
- –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏.

**–ù–µ—Ç, –µ—Å–ª–∏:**
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–ø–∏—Ä–∞–µ—Ç—Å—è –≤ I/O (SQL, HTTP-–∑–∞–ø—Ä–æ—Å—ã),
- –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å–ª–∞–±—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö,
- –≠—Ç–æ —Ä–∞–∑–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç.

P.S. –ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ —Ä–≤–∞—Ç—å—Å—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å YJIT ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–æ–∏—Ç —Å–Ω–∞—á–∞–ª–∞ –ø–æ—á–∏–Ω–∏—Ç—å —ç—Ç–∏ `N+1` –∑–∞–ø—Ä–æ—Å—ã? üòâ
