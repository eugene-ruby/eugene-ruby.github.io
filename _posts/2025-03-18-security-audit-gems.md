---
layout: post
subtitle: <div id="terminal"></div>
title:  "Brakeman, Bundler Audit –∏ –¥—Ä—É–≥–∏–µ: Ruby-–≥–µ–º—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
date:   2024-09-18 10:00:00 +0300
rate: 2
tags: Gem,–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å,DevOps,–∞—É–¥–∏—Ç,—É—è–∑–≤–∏–º–æ—Å—Ç–∏
version: A49X3
categories:
  - security
  - ruby
hero_image: /images/ruby.jpg
hero_darken: true
toc: true
menubar_toc: true
---

–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤ Ruby-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–æ HTTPS –∏ —Å–ª–æ–∂–Ω—ã–µ –ø–∞—Ä–æ–ª–∏. –≠—Ç–æ –ø—Ä–æ –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é —Ä—É—Ç–∏–Ω—É: –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–µ–º–æ–≤, –ø–æ–∏—Å–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∫–æ–¥–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–æ–∫. –†–∞–∑–±–µ—Ä—ë–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–ø–∞—Å—É—Ç –≤–∞—à –±—ç–∫–µ–Ω–¥ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π, —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –¥—Ä—É–≥–∏—Ö "–ø–æ–¥–∞—Ä–∫–æ–≤" –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.

---

## üîç –ü–æ—á–µ–º—É —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ?

–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ:
- –í—Å–µ –≥–µ–º—ã –≤ `Gemfile.lock` –±–µ–∑–æ–ø–∞—Å–Ω—ã?
- –í –≤–∞—à–∏—Ö —à–∞–±–ª–æ–Ω–∞—Ö –Ω–µ—Ç XSS?
- –ù–∏–∫—Ç–æ –Ω–µ –∑–∞–±—ã–ª –ø—Ä–æ `strong_params` –≤ –Ω–æ–≤–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ?

**–û—Ç–≤–µ—Ç—ã "–Ω–∞ –≥–ª–∞–∑–æ–∫" –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç.** –ù—É–∂–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–∫–∞–Ω–∏—Ä—É—é—Ç –ø—Ä–æ–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî –∫–∞–∫ –æ—Ö—Ä–∞–Ω–Ω–∏–∫ —Å –º–µ—Ç–∞–ª–ª–æ–¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–º –Ω–∞ –≤—Ö–æ–¥–µ –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç.

---

## üõ°Ô∏è Brakeman: —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è Rails

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç?
–°–∫–∞–Ω–∏—Ä—É–µ—Ç –∫–æ–¥ –Ω–∞:
- SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ (`User.where("name = '#{params[:name]}'")`),
- XSS (`<%= raw @comment.text %>`),
- –º–∞—Å—Å–æ–≤–æ–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ (`User.update(params[:user])`),
- –∏ –µ—â—ë [50+ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π](https://brakemanpro.com/security_warnings).

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞:
```bash
gem install brakeman
brakeman -o report.html
```

### –ü—Ä–∏–º–µ—Ä –æ—Ç—á—ë—Ç–∞:
```text
+------------+-------+
| Confidence | High  |
+------------+-------+
| Warning    | SQL Injection in User.search |
| File       | app/models/user.rb:42 |
| Code       | User.where("login LIKE '%#{params[:q]}%'") |
+------------+-------+
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ CI:
```yaml
# .github/workflows/security.yml
- name: Brakeman
  run: brakeman -z --no-pager
```

**–ü–ª—é—Å—ã:**
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∞–∂–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –º–∏–≥—Ä–∞—Ü–∏—è—Ö.

**–ú–∏–Ω—É—Å—ã:**
- –õ–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ `sanitize_sql`).
- –ù–µ –∏—â–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã –≤ JavaScript.

---

## üì¶ Bundler Audit: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### –ó–∞—á–µ–º?
–£—Å—Ç–∞—Ä–µ–≤—à–∏–π –≥–µ–º = –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –¥—ã—Ä–∞. –ù–∞–ø—Ä–∏–º–µ—Ä, `rack` –¥–æ 2.1.4 –¥–æ–ø—É—Å–∫–∞–µ—Ç [RCE](https://nvd.nist.gov/vuln/detail/CVE-2020-8184).

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
```bash
gem install bundler-audit
bundle-audit check --update
```

–í—ã–≤–æ–¥:
```text
Name: actionpack
Version: 5.2.3
Advisory: CVE-2020-8166
Criticality: Medium
URL: https://groups.google.com/.../rubyonrails-security/1hPWx...
Title: Possible XSS in Action Pack
Solution: upgrade to >= 5.2.4.3
```

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:
–î–æ–±–∞–≤—å—Ç–µ –≤ `Rakefile`:
```ruby
task :security do
  sh "bundle-audit check --update"
end
```

**–°–æ–≤–µ—Ç:** –ó–∞–ø—É—Å–∫–∞–π—Ç–µ `bundle-audit` –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ `bundle install` —á–µ—Ä–µ–∑ `post_install`-—Ö—É–∫.

---

## üîé –î—Ä—É–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

### 1. `ruby_audit`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–µ—Ä—Å–∏—é Ruby –Ω–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ CVE:
```bash
gem install ruby_audit
ruby-audit check
```

### 2. `bundler-outdated`
–ò—â–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –≥–µ–º—ã (–Ω–µ —Ç–æ–ª—å–∫–æ —É—è–∑–≤–∏–º—ã–µ):
```bash
bundle outdated --strict
```

### 3. `rails_best_practices`
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–∏—Å–∫–∏:
```bash
gem install rails_best_practices
rails_best_practices .
```

–ü—Ä–∏–º–µ—Ä –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:
```text
Don't use default_scope (app/models/user.rb:5)
```

---

## üíÄ –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 1. "–£ –Ω–∞—Å –º–∞–ª–µ–Ω—å–∫–∏–π –ø—Ä–æ–µ–∫—Ç ‚Äî –∑–∞—á–µ–º –∞—É–¥–∏—Ç?"
–û—Ç–≤–µ—Ç: –í–∑–ª–æ–º—ã —á–∞—Å—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã ‚Äî –±–æ—Ç—ã —Å–∫–∞–Ω–∏—Ä—É—é—Ç –¥–∞–∂–µ –ø–µ—Ç-–ø—Ä–æ–µ–∫—Ç—ã.

### 2. "–û–±–Ω–æ–≤–∏–º –≥–µ–º—ã, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≤—Ä–µ–º—è"
–ü—Ä–∏–º–µ—Ä: –í 2019 –≥–æ–¥—É —á–µ—Ä–µ–∑ —É—è–∑–≤–∏–º–æ—Å—Ç—å –≤ `activestorage` ([CVE-2019-5421](https://nvd.nist.gov/vuln/detail/CVE-2019-5421)) –∞—Ç–∞–∫–æ–≤–∞–ª–∏ —Ç—ã—Å—è—á–∏ Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

### 3. "Brakeman —Ä—É–≥–∞–µ—Ç—Å—è ‚Äî –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º –µ–≥–æ –≤ CI"
–õ—É—á—à–µ:
```ruby
# config/brakeman.yml
skip_checks: ["CheckRedirect"]
```

---

## üõ†Ô∏è –ü—Ä–∞–∫—Ç–∏–∫–∞: –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞–π–ø–ª–∞–π–Ω

1. **–õ–æ–∫–∞–ª—å–Ω–æ**: –•—É–∫–∏ –≤ `overcommit`:

```yaml
PreCommit:
  Brakeman:
    enabled: true
    command: ['brakeman', '-q', '-z']
```

2. **CI**: –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:

```yaml
jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: gem install brakeman bundler-audit
      - run: brakeman -z --no-pager
      - run: bundle-audit check --update
```

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã —á–µ—Ä–µ–∑ `cron` + Slack-–±–æ—Ç.

---

## üéØ –í—ã–≤–æ–¥

- **Brakeman** ‚Äî —Å–∫–∞–Ω–µ—Ä –∫–æ–¥–∞, –ª–æ–≤–∏—Ç "—Ö–∞—Ä–¥–∫–æ–¥-–∏–Ω—ä–µ–∫—Ü–∏–∏".
- **Bundler Audit** ‚Äî –¥–µ—Ç–µ–∫—Ç–æ—Ä —É—è–∑–≤–∏–º—ã—Ö –≥–µ–º–æ–≤.
- **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –Ω–µ –∑–∞–±—ã—Ç—å –ø—Ä–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.

–ö–∞–∫ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –º—É–¥—Ä—ã–π DevOps:  
*"–õ—É—á—à–µ –∫—Ä–∞—Å–Ω—ã–π CI, —á–µ–º –∫—Ä–∞—Å–Ω—ã–µ –≥–ª–∞–∑–∞ –æ—Ç –Ω–æ—á–Ω–æ–≥–æ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞"*. üî•
