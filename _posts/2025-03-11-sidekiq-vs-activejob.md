---
layout: post
subtitle: <div id="terminal"></div>
title:  "–û—á–µ—Ä–µ–¥—å –Ω–∞ –≤—ã–Ω–æ—Å: Sidekiq, ActiveJob, Resque –∏ Delayed::Job"
date:   2024-09-18 12:00:00 +0300
rate: 3
tags: Ruby on Rails,Background Jobs,Redis,PostgreSQL,Performance
version: A49X3
categories:
  - architecture
  - rails
hero_image: /images/ruby.jpg
hero_darken: true
toc: true
menubar_toc: true
---
–ö–æ–≥–¥–∞ –≤–∞—à–µ–º—É Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ, –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å CSV –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ-—Ç–æ –¥–æ–ª–≥–æ–µ, –≤—Å—Ç–∞—ë—Ç –≤–æ–ø—Ä–æ—Å: ¬´–ö–∞–∫ –Ω–µ –∑–∞—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∂–¥–∞—Ç—å?¬ª. –û—Ç–≤–µ—Ç ‚Äî —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏. –í —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º —á–µ—Ç—ã—Ä–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—á–µ—Ä–µ–¥—è–º–∏: –∏—Ö —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã, –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏ –∏ —Å–ª—É—á–∞–∏, –∫–æ–≥–¥–∞ –∫–∞–∂–¥—ã–π –∏–∑ –Ω–∏—Ö ‚Äî –∏–¥–µ–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä.

---
–í—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –Ω–∞–∂–∞–ª–∏ ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª‚Ä¶  
–ê –≤ —ç—Ç–æ –≤—Ä–µ–º—è –≥–¥–µ-—Ç–æ –≤ –Ω–µ–¥—Ä–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞:  
`ChargeCreditCardJob.perform_later(order_id)` ‚Üí `Sidekiq` ‚Üí `Redis` ‚Üí **üí∞**.  
–í–æ—Ç –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –≤–∞—à–µ–≥–æ —É—á–∞—Å—Ç–∏—è.

---

## üß† –¢–µ–æ—Ä–∏—è: –∑–∞—á–µ–º –Ω—É–∂–Ω—ã —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏?

–§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (background jobs) —Ä–µ—à–∞—é—Ç —Ç—Ä–∏ –∫–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî –¥–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
2. **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –º–µ–∂–¥—É –≤–æ—Ä–∫–µ—Ä–∞–º–∏

–ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç? –ó–∞–≤–∏—Å–∏—Ç –æ—Ç:
- –û–±—ä—ë–º–∞ –∑–∞–¥–∞—á
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏
- –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–µ—Å—Ç—å –ª–∏ Redis?)
- –°–ª–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

---

## üõ†Ô∏è –û–±–∑–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

### 1. Sidekiq (‚≠êÔ∏è –°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π)
```ruby
# Gemfile
gem 'sidekiq'
```

**–ü–ª—é—Å—ã:**
- –ú–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ (–±–ª–∞–≥–æ–¥–∞—Ä—è Redis)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ (Sidekiq-Cron)
- –ë–æ–≥–∞—Ç—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Web UI)

**–ú–∏–Ω—É—Å—ã:**
- –¢—Ä–µ–±—É–µ—Ç Redis
- –ù–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–±–µ–∑ Enterprise)

**–ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å:** –í—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã —Å Redis –≤ —Å—Ç—ç–∫–µ.

---

### 2. ActiveJob (‚ö°Ô∏è –°—Ç–∞–Ω–¥–∞—Ä—Ç Rails)
```ruby
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
config.active_job.queue_adapter = :sidekiq # –∏–ª–∏ :resque, :delayed_job
```

**–ü–ª—é—Å—ã:**
- –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –Ω–∞–¥ —Ä–∞–∑–Ω—ã–º–∏ –±—ç–∫–µ–Ω–¥–∞–º–∏
- –í—Å—Ç—Ä–æ–µ–Ω –≤ Rails (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
- –ï–¥–∏–Ω—ã–π API –¥–ª—è –≤—Å–µ—Ö –∞–¥–∞–ø—Ç–µ—Ä–æ–≤

**–ú–∏–Ω—É—Å—ã:**
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∞–¥–∞–ø—Ç–µ—Ä–∞
- –ú–µ–Ω—å—à–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π, —á–µ–º —É –Ω–∞—Ç–∏–≤–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π

**–ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å:** –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –≥–∏–±–∫–æ—Å—Ç—å –∏–ª–∏ –≤—ã –ø–∏—à–µ—Ç–µ –≥–µ–º/–±–∏–±–ª–∏–æ—Ç–µ–∫—É.

---

### 3. Resque (üé© –ù–∞—Å–ª–µ–¥–Ω–∏–∫ Twitter)
```ruby
# Gemfile
gem 'resque'
```

**–ü–ª—é—Å—ã:**
- –ü—Ä–æ—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Redis + –ø—Ä–æ—Ü–µ—Å—Å—ã)
- –•–æ—Ä–æ—à–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–ª–∞–≥–∏–Ω–æ–≤

**–ú–∏–Ω—É—Å—ã:**
- –ú–µ–¥–ª–µ–Ω–Ω–µ–µ Sidekiq
- –ù–µ—Ç –º—É–ª—å—Ç–∏–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏

**–ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å:** –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ—Å—Ç–æ—Ç–∞.

---

### 4. Delayed::Job (üóÑÔ∏è –î–ª—è –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–æ–≤)
```ruby
# Gemfile
gem 'delayed_job_active_record'
```

**–ü–ª—é—Å—ã:**
- –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±–æ–π –ë–î (PostgreSQL, MySQL)
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç Redis
- –ü—Ä–æ—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

**–ú–∏–Ω—É—Å—ã:**
- –ú–µ–¥–ª–µ–Ω–Ω–µ–µ —Ä–µ—à–µ–Ω–∏–π –Ω–∞ Redis
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å:** –î–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –±–µ–∑ Redis.

---

## üîß –ü—Ä–∞–∫—Ç–∏–∫–∞: —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

–¢–µ—Å—Ç: 10 000 –∑–∞–¥–∞—á ¬´–ø—É—Å—Ç—ã—à–µ–∫¬ª –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ (Ruby 3.2, PostgreSQL 14, Redis 6).

| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç       | –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | –ü–∞–º—è—Ç—å (—Å—Ä–µ–¥–Ω—è—è) |
|------------------|------------------|------------------|
| Sidekiq          | 42 —Å–µ–∫           | 120 MB           |
| Resque           | 1 –º–∏–Ω 20 —Å–µ–∫     | 150 MB           |
| Delayed::Job     | 2 –º–∏–Ω 15 —Å–µ–∫     | 90 MB            |
| ActiveJob+Sidekiq| 45 —Å–µ–∫           | 125 MB           |

–í—ã–≤–æ–¥: **Sidekiq ‚Äî —è–≤–Ω—ã–π –ª–∏–¥–µ—Ä**, –Ω–æ Delayed::Job —ç–∫–æ–Ω–æ–º–∏—Ç –ø–∞–º—è—Ç—å.

---

## üí• –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã

### 1. ¬´–ú–µ–≥–∞-–∑–∞–¥–∞—á–∞¬ª
```ruby
class ReportGenerationJob < ApplicationJob
  def perform(user_id)
    # 200 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, 5 SQL-–∑–∞–ø—Ä–æ—Å–æ–≤, 3 API-–≤—ã–∑–æ–≤–∞
  end
end
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –û–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –¥–µ–ª–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ. –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ–≥–æ –±–ª–æ–∫–∞.

**–†–µ—à–µ–Ω–∏–µ:** –†–∞–∑–±–∏–≤–∞—Ç—å –Ω–∞ –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –∑–∞–¥–∞—á–∏:
```ruby
GenerateDataJob.perform_later(user_id)
ExportToCsvJob.perform_later(data_id)
SendEmailJob.perform_later(csv_url)
```

---

### 2. –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
```ruby
class ChargeCreditCardJob < ApplicationJob
  def perform(order_id)
    order = Order.find(order_id)
    PaymentGateway.charge(order.total) # –ß—Ç–æ –µ—Å–ª–∏ job –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –¥–≤–∞–∂–¥—ã?
  end
end
```

**–†–µ—à–µ–Ω–∏–µ:**
```ruby
def perform(order_id)
  order = Order.find(order_id)
  return if order.paid? # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å

  order.with_lock do
    PaymentGateway.charge(order.total)
    order.update!(paid: true)
  end
end
```

---

### 3. ¬´–¢–∏—Ö–∏–π –ø—Ä–æ–≤–∞–ª¬ª
```ruby
class ImageProcessingJob < ApplicationJob
  def perform(image_id)
    image = Image.find(image_id)
    image.process! # –ê –µ—Å–ª–∏ image —É–¥–∞–ª—ë–Ω? –ò–ª–∏ process! –≤—ã–∑–æ–≤–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ?
  end
end
```

**–†–µ—à–µ–Ω–∏–µ:**
```ruby
rescue_from(ActiveRecord::RecordNotFound) do |exception|
  Rails.logger.error "Image not found: #{exception}"
end

rescue_from(Image::ProcessingError) do |exception|
  retry_job(wait: 5.minutes)
end
```

---

## üéõÔ∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å PostgreSQL

–î–ª—è Delayed::Job (–∏ ActiveJob —Å –∞–¥–∞–ø—Ç–µ—Ä–æ–º :async) PostgreSQL ‚Äî —Ä–æ–¥–Ω–∞—è —Å—Ä–µ–¥–∞. –ù–æ –µ—Å—Ç—å –Ω—é–∞–Ω—Å—ã:

### –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏
```sql
-- –î–ª—è –±–æ–ª—å—à–∏—Ö –æ—á–µ—Ä–µ–¥–µ–π –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å:
CREATE INDEX index_delayed_jobs_on_locked_at ON delayed_jobs (locked_at);
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
```ruby
# config/initializers/delayed_job.rb
Delayed::Worker.destroy_failed_jobs = false
Delayed::Worker.max_attempts = 3
Delayed::Worker.max_run_time = 15.minutes
```

---

## üé§ –ß—Ç–æ —Å–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏

> ‚Äî –ü–æ—á–µ–º—É –≤—ã –≤—ã–±—Ä–∞–ª–∏ Sidekiq, –∞ –Ω–µ Resque?

‚Äî –î–ª—è –Ω–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á, –∞ Sidekiq –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª—É—á—à—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–ª–∞–≥–æ–¥–∞—Ä—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π –º–æ–¥–µ–ª–∏. –ü–ª—é—Å, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫—É.

---

## üßæ –í—ã–≤–æ–¥

1. **High-load?** ‚Üí Sidekiq + Redis
2. **–ù—É–∂–Ω–∞ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è?** ‚Üí ActiveJob —Å –∞–¥–∞–ø—Ç–µ—Ä–æ–º –ø–æ–¥ –∑–∞–¥–∞—á—É
3. **–ë–µ–∑ Redis?** ‚Üí Delayed::Job –Ω–∞ PostgreSQL
4. **–õ–µ–≥–∞—Å–∏ –∏–ª–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å?** ‚Üí Resque

–§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ ‚Äî –∫–∞–∫ —Ö–æ—Ä–æ—à–∏–µ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç—ã: —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–∑–∞–º–µ—Ç–Ω–æ, –Ω–æ –±–µ–∑ –Ω–∏—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω –≤—Å—Ç–∞–Ω–µ—Ç. –í—ã–±–∏—Ä–∞–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã, –∏–∑–±–µ–≥–∞–π—Ç–µ –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤, –∏ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–∫–∞–∂–µ—Ç –≤–∞–º ¬´—Å–ø–∞—Å–∏–±–æ¬ª —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–æ–π.
