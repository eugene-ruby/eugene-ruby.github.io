---
layout: post
title:  "–ë—ã–ª JOIN ‚Äî –∏ –≤—Å—ë –±—ã–ª–æ —Ö–æ—Ä–æ—à–æ. –ü–æ–∫–∞ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –ø—Ä–µ–≤—ã—Å–∏–ª–∞ 1000 —Å—Ç—Ä–æ–∫..."
date:   2025-01-25 14:00:00 +0300
rate: 3
tags: Ruby,PostgreSQL,Rails,–±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö,–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å,DevOps
version: A49X3
categories:
  - postgres
toc: true
menubar_toc: true
hero_image: /images/rails.jpg
hero_darken: true
---
Ruby, PostgreSQL –∏ Rails ‚Äî –º–æ—â–Ω—ã–π —Å—Ç–µ–∫ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, –Ω–æ –¥–∞–∂–µ –≤ –Ω—ë–º –µ—Å—Ç—å –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏. –†–∞–∑–±–µ—Ä—ë–º—Å—è, –∫–∞–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö, –∏–∑–±–µ–≥–∞—Ç—å —É–∑–∫–∏—Ö –º–µ—Å—Ç –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –≤—ã—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–∞–¥—ë–∂–Ω—ã–µ DevOps-–ø—Ä–æ—Ü–µ—Å—Å—ã.

---
–¢—ã –∂–∏–≤—ë—à—å —Å `JOIN` –≤ –ø—Ä–æ–¥–µ, –≤—Å—ë –±—ã—Å—Ç—Ä–æ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ. –ù–æ –æ–¥–Ω–∞–∂–¥—ã –≤—Ç–æ—Ä–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–µ—Ä–µ–≤–∞–ª–∏–≤–∞–µ—Ç –∑–∞ 1000 –∑–∞–ø–∏—Å–µ–π ‚Äî –∏ –≤–Ω–µ–∑–∞–ø–Ω–æ **–∑–∞–ø—Ä–æ—Å –Ω–∞—á–∏–Ω–∞–µ—Ç —Ç–æ—Ä–º–æ–∑–∏—Ç—å**. –ü–æ—á–µ–º—É?

## üî• –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?

–î–æ –ø–æ—Ä–æ–≥–∞ –≤ ~1–ö —Å—Ç—Ä–æ–∫ Postgres –º–æ–≥:

- **–≤—ã–±–∏—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω** (`Nested Loop`, `Index Scan`)
- –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –∑–∞–ø–∏—Å–∏ –ø–æ –∏–Ω–¥–µ–∫—Å—É
- –¥–µ–ª–∞—Ç—å –≤—Å—ë –≤ –ø–∞–º—è—Ç–∏ (`shared_buffers`)

–ù–æ –∫–∞–∫ —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü–∞ –≤—ã—Ä–æ—Å–ª–∞ ‚Äî **Postgres –ø–µ—Ä–µ—Å—á–∏—Ç–∞–ª –ø–ª–∞–Ω**.

---

## üìâ –ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –≤ EXPLAIN?

```text
Nested Loop
  -> Seq Scan on main_table
  -> Index Scan on second_table
       Index Cond: ...
````

–ü—Ä–æ–±–ª–µ–º–∞: **–≤–Ω–µ—à–Ω—è—è —Ç–∞–±–ª–∏—Ü–∞ –±–æ–ª—å—à–∞—è**, –∞ `Index Scan` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è **–∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏**.

---

## üö® –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π —Ä–æ—Å—Ç ‚Äî –≤–Ω–µ–∑–∞–ø–Ω–∞—è –±–æ–ª—å

Postgres –≤—ã–±–∏—Ä–∞–µ—Ç –ø–ª–∞–Ω, **–∏—Å—Ö–æ–¥—è –∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏** (ANALYZE), –∏ –¥—É–º–∞–µ—Ç:

> ¬´–î–∞ —Ç—É—Ç –≤—Å–µ–≥–æ 999 —Å—Ç—Ä–æ–∫, –Ω–æ—Ä–º–∞–ª—å–Ω–æ!¬ª

–ù–æ –Ω–∞ 1001-–π ‚Äî **Nested Loop –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –∞–¥**: —Å–æ—Ç–Ω–∏ —Ç—ã—Å—è—á –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –∏–Ω–¥–µ–∫—Å—É.
–ü—Ä–æ–¥ "–≤–∏—Å–∏—Ç", CPU –∑–∞–±–∏—Ç–æ, Postgres –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç.

---

## üí° –ö–∞–∫ —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?

1. –ü—Ä–æ–≤–µ—Ä—å –ø–ª–∞–Ω —á–µ—Ä–µ–∑ `EXPLAIN (ANALYZE, BUFFERS)`
2. –°—Ä–∞–≤–Ω–∏ `actual rows` –∏ `estimated rows` ‚Äî –µ—Å–ª–∏ –æ–Ω–∏ **—Å–∏–ª—å–Ω–æ —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è**, —ç—Ç–æ —Å–∏–≥–Ω–∞–ª
3. –ó–∞–ø—É—Å—Ç–∏ `ANALYZE` –∏–ª–∏ `VACUUM ANALYZE` –≤—Ä—É—á–Ω—É—é
4. –£–∫–∞–∂–∏ `JOIN` —è–≤–Ω–æ (–≤–º–µ—Å—Ç–æ `WHERE ... IN`)
5. –ü–æ–ø—Ä–æ–±—É–π **—Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞—Ç—å** –ø–ª–∞–Ω:

```sql
SET enable_nestloop = off;
```

(–Ω–µ –≤ –ø—Ä–æ–¥–µ! –¢–æ–ª—å–∫–æ —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ–º–æ–∂–µ—Ç –ª–∏ `Hash Join`)

---

## üõ°Ô∏è –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞

* –†–µ–≥—É–ª—è—Ä–Ω—ã–π `ANALYZE`
* –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–∏—Ä–æ—Å—Ç–∞ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö
* –õ–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (`log_min_duration_statement`)
* –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –æ–±—ä—ë–º–∞—Ö, **–≤ 10 —Ä–∞–∑ –ø—Ä–µ–≤—ã—à–∞—é—â–∏—Ö —Ç–µ–∫—É—â–∏–µ**

---

üìå *–í—ã–≤–æ–¥*: –Ω–µ –¥–æ–≤–µ—Ä—è–π –º–∞–ª—ã–º —Ç–∞–±–ª–∏—Ü–∞–º. –û–Ω–∏ –≤—ã—Ä–∞—Å—Ç–∞—é—Ç ‚Äî –∏ –≤ —Å–∞–º—ã–π –ø–ª–æ—Ö–æ–π –º–æ–º–µ–Ω—Ç —Ä—É—à–∞—Ç —Ç–µ–±–µ –ø—Ä–æ–¥. –°–ª–µ–¥–∏ –∑–∞ —Ä–æ—Å—Ç–æ–º –∏ –±—É–¥—å –≥–æ—Ç–æ–≤ –ø–æ–º–µ–Ω—è—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é.
