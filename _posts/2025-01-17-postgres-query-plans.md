---
layout: post
title:  "PostgreSQL Query Plan: —á—Ç–æ –∑–Ω–∞—á–∞—Ç Nested Loop, Hash Join –∏ –ø—Ä–æ—á–∏–µ —Å—Ç—Ä–∞—à–Ω—ã–µ —Å–ª–æ–≤–∞"
date:   2025-01-17 10:30:00 +0300
categories:
  - postgres
toc: true
menubar_toc: true
hero_image: /images/rails.jpeg
hero_darken: true
---
PostgreSQL ‚Äî –º–æ—â–Ω–∞—è –°–£–ë–î, –Ω–æ –±–µ–∑ –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø–ª–∞–Ω–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–∞–∂–µ –æ–ø—ã—Ç–Ω—ã–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å—Ç–∞–ª–∫–∏–≤–∞—é—Ç—Å—è —Å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º–∏ —Ç–æ—Ä–º–æ–∑–∞–º–∏. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã JOIN-–æ–ø–µ—Ä–∞—Ü–∏–π (Nested Loop, Hash Join, Merge Join) –∏ –º–µ—Ç–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º (Index Scan, Seq Scan, Bitmap Scan), –∫–æ—Ç–æ—Ä—ã–µ –≤–ª–∏—è—é—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π. –£–∑–Ω–∞–µ–º, –∫–∞–∫ —á–∏—Ç–∞—Ç—å –≤—ã–≤–æ–¥ EXPLAIN ANALYZE –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Å —É—á—ë—Ç–æ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ work_mem.

–ö–æ–≥–¥–∞ —Ç—ã —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ `EXPLAIN ANALYZE`, –ø–µ—Ä–≤–æ–µ —á—É–≤—Å—Ç–≤–æ ‚Äî –ª–µ–≥–∫–æ–µ –∑–∞–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ.  
–í–æ—Ç –∫—Ä–∞—Ç–∫–∏–π —Å–ª–æ–≤–∞—Ä—å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å –ø–ª–∞–Ω—ã PostgreSQL —Å –ø–µ—Ä–≤–æ–≥–æ –≤–∑–≥–ª—è–¥–∞.

---

## üîÅ Nested Loop

–¶–∏–∫–ª –≤ —Ü–∏–∫–ª–µ: –¥–ª—è **–∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏** –∏–∑ –≤–Ω–µ—à–Ω–µ–π —Ç–∞–±–ª–∏—Ü—ã –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–ø–æ–∏—Å–∫** –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π.

```text
Nested Loop
  -> Seq Scan on orders
  -> Index Scan on users ...
````

üö® –ú–µ–¥–ª–µ–Ω–Ω–æ, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫ –º–Ω–æ–≥–æ. –ú–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å **1000+ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**.

üõ† –°–ø–∞—Å–∞–µ—Ç `LIMIT`, `–∏–Ω–¥–µ–∫—Å—ã`, `–∞–Ω–∞–ª–∏–∑ —Ä–∞–∑–º–µ—Ä–∞ –≤—ã–±–æ—Ä–∫–∏`.

---

## üß† Hash Join

–í–º–µ—Å—Ç–æ –ø–µ—Ä–µ–±–æ—Ä–∞ ‚Äî Postgres —Å—Ç—Ä–æ–∏—Ç **—Ö–µ—à-—Ç–∞–±–ª–∏—Ü—É** –ø–æ –æ–¥–Ω–æ–π –∏–∑ —Ç–∞–±–ª–∏—Ü –∏ –±—ã—Å—Ç—Ä–æ –∏—â–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è.

```text
Hash Join
  -> Seq Scan on users
  -> Hash
    -> Seq Scan on orders
```

üìå –û—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å—Ç—Ä–æ–∫, –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞–º—è—Ç—å.

---

## üìö Merge Join

–û–±–µ —Ç–∞–±–ª–∏—Ü—ã **–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã**, –∏ Postgres –∏–¥—ë—Ç –ø–æ –Ω–∏–º **–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ** –∫–∞–∫ merge –≤ merge-sort.

```text
Merge Join
  -> Index Scan on users
  -> Index Scan on orders
```

‚ö° –ë—ã—Å—Ç—Ä–æ, –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã **—É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ join-–∫–ª—é—á—É**.

---

## üîç Index Scan

–ò–¥–µ–∞–ª—å–Ω–æ: Postgres –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–∏–Ω–¥–µ–∫—Å**, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏.

```text
Index Scan using users_pkey on users
```

üìå –ë—ã—Å—Ç—Ä–æ, –µ—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –ø–æ–ø–∞–¥–∞–µ—Ç –ø–æ –∏–Ω–¥–µ–∫—Å—É.

---

## üë£ Seq Scan

–ü–æ—Å—Ç–≥—Ä–µ—Å **—á–∏—Ç–∞–µ—Ç –≤—Å—é —Ç–∞–±–ª–∏—Ü—É —Ü–µ–ª–∏–∫–æ–º**.

```text
Seq Scan on users
```

üö® –ë—ã–≤–∞–µ—Ç –±—ã—Å—Ç—Ä–æ (–µ—Å–ª–∏ –º–∞–ª–æ —Å—Ç—Ä–æ–∫) –∏–ª–∏ —É–∂–∞—Å–Ω–æ –º–µ–¥–ª–µ–Ω–Ω–æ (–µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –±–æ–ª—å—à–∞—è).

---

## üßÆ Bitmap Index Scan

–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –º–µ–∂–¥—É Index Scan –∏ Seq Scan. –°–Ω–∞—á–∞–ª–∞ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è —Å—Å—ã–ª–∫–∏, –ø–æ—Ç–æ–º –∏–¥—É—Ç –∑–∞ –¥–∞–Ω–Ω—ã–º–∏.

```text
Bitmap Heap Scan on users
  -> Bitmap Index Scan on index_users_on_email
```

üìå –•–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∫–æ–≥–¥–∞ —É—Å–ª–æ–≤–∏–µ –¥–∞—ë—Ç **–º–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π**.

---

## üß∞ –ß—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä –ø–ª–∞–Ω–∞

* –†–∞–∑–º–µ—Ä –≤—ã–±–æ—Ä–∫–∏
* –ù–∞–ª–∏—á–∏–µ –∏ —Å–æ—Å—Ç–∞–≤ –∏–Ω–¥–µ–∫—Å–æ–≤
* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (ANALYZE!)
* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–º—è—Ç–∏ (`work_mem`)
* –°–≤—è–∑–∞–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è `JOIN`, `WHERE`

---

## üß≠ –ó–∞–ø–æ–º–Ω–∏

| –¢–µ—Ä–º–∏–Ω            | –ß—Ç–æ —ç—Ç–æ                        | –ö–æ–≥–¥–∞ –±—ã—Å—Ç—Ä–æ                       |
| ----------------- | ------------------------------ | ---------------------------------- |
| Nested Loop       | –¶–∏–∫–ª –≤ —Ü–∏–∫–ª–µ                   | –ú–∞–ª–æ —Å—Ç—Ä–æ–∫, –±—ã—Å—Ç—Ä—ã–π –∏–Ω–¥–µ–∫—Å         |
| Hash Join         | –•–µ—à-—Ç–∞–±–ª–∏—Ü–∞                    | –ú–Ω–æ–≥–æ —Å—Ç—Ä–æ–∫, —Ö–æ—Ä–æ—à–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ |
| Merge Join        | –°–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏        | –ï—Å—Ç—å –∏–Ω–¥–µ–∫—Å –ø–æ join-–ø–æ–ª—é           |
| Seq Scan          | –ß—Ç–µ–Ω–∏–µ –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã            | –ú–∞–ª–µ–Ω—å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏–ª–∏ –Ω–µ—Ç –∏–Ω–¥–µ–∫—Å–∞  |
| Index Scan        | –¢–æ—á–Ω–æ–µ –ø–æ–ø–∞–¥–∞–Ω–∏–µ –ø–æ –∏–Ω–¥–µ–∫—Å—É    | –•–æ—Ä–æ—à–∏–µ –∏–Ω–¥–µ–∫—Å—ã                    |
| Bitmap Index Scan | –ú–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π, —Å–∂–∞—Ç—ã–π –ø–æ–∏—Å–∫ | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ Seq Scan –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞  |
