---
layout: post
title: "PgBouncer –∏ max_client_conn ‚Äî –ø–æ—á–µ–º—É –ª–∏–º–∏—Ç –Ω–µ —Å–ø–∞—Å–∞–µ—Ç"
date: 2025-05-12 16:30:00 +0300
rate: 4
tags: PostgreSQL,PgBouncer,Rails,DevOps,connection pooling,performance
version: A49X3
categories:
  - postgres
  - rails
toc: true
menubar_toc: true
hero_image: /images/rails.jpeg
hero_darken: true
---
PostgreSQL ‚Äî –º–æ—â–Ω–∞—è –°–£–ë–î, –Ω–æ –µ—ë –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å —É–∑–∫–∏–º –º–µ—Å—Ç–æ–º –≤ –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö. PgBouncer —Ä–µ—à–∞–µ—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É, –≤—ã—Å—Ç—É–ø–∞—è –≤ —Ä–æ–ª–∏ –ø—É–ª–µ—Ä–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, –æ–¥–Ω–∞–∫–æ –µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤—Ä–æ–¥–µ max_client_conn –∏ pool_size, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ DevOps-—Å—Ä–µ–¥–µ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏.

---
## üßÆ –ó–∞—á–µ–º –≤–æ–æ–±—â–µ PgBouncer?

PostgreSQL ‚Äî —Ç—è–∂—ë–ª—ã–π –Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –î–∞–∂–µ –ø—Ä–æ—Å—Ç–æ–µ `psql` —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π backend-–ø—Ä–æ—Ü–µ—Å—Å.

–ù–∞ highload-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –±–æ–ª—å:  
**1000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚â† 1000 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**. –≠—Ç–æ 1000 *—Ñ–æ—Ä–∫–æ–≤*.

PgBouncer –≤—ã—Å—Ç—É–ø–∞–µ—Ç –∫–∞–∫ **–ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑–¥–∞—ë—Ç —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ backend-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ –º–µ—Ä–µ –Ω–∞–¥–æ–±–Ω–æ—Å—Ç–∏.

---

## ‚ö†Ô∏è –ê —á—Ç–æ —Ç–∞–∫–æ–µ `max_client_conn`?

–≠—Ç–æ –ª–∏–º–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤, –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –∫ PgBouncer. –ù–∞–ø—Ä–∏–º–µ—Ä:

```ini
max_client_conn = 5000
````

–ó–≤—É—á–∏—Ç –∫–∞–∫ –±—É–¥—Ç–æ –º—ã –º–æ–∂–µ–º –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å 5000 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π‚Ä¶ –Ω–æ –≤—Å—ë –Ω–µ —Ç–∞–∫ –ø—Ä–æ—Å—Ç–æ.

---

## üí• –ì–¥–µ –ø–æ–¥–≤–æ—Ö?

**`max_client_conn` ‚Äî —ç—Ç–æ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—è, —ç—Ç–æ –º–∞–∫—Å–∏–º—É–º.**

PgBouncer —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É:

> –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è ‚Üí –∂–¥–∏ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ backend-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

–ï—Å–ª–∏ –∏—Ö –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç (–ø–æ `pool_size`), –∫–ª–∏–µ–Ω—Ç **–∂–¥—ë—Ç**. –ò–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—à–∏–±–∫—É `no more connections`.

---

## üß© –ò –∫–∞–∫ —ç—Ç–æ –≤—Å—ë –ª–æ–º–∞–µ—Ç –ø—Ä–æ–¥?

1. –£ –≤–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ `max_client_conn = 5000`
2. –ù–æ `pool_size = 100`, –∞ `default_pool_size = 20`
3. –í–Ω–µ–∑–∞–ø–Ω—ã–π —Ä–æ—Å—Ç —Ç—Ä–∞—Ñ–∏–∫–∞
4. PgBouncer –Ω–∞—á–∏–Ω–∞–µ—Ç –æ—Ç–∫–∞–∑—ã–≤–∞—Ç—å –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –∏–ª–∏ –∑–∞–≤–∏—Å–∞—Ç—å
5. –ê –≤—ã —Ç–∞–∫–∏–µ: ¬´–ù–æ –≤–µ–¥—å —É –Ω–∞—Å max\_client\_conn –±–æ–ª—å—à–æ–π!¬ª

---

## ‚úÖ –ö–∞–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å?

–°–º–æ—Ç—Ä–∏—Ç–µ:

```bash
SHOW POOLS;
SHOW STATS;
SHOW CLIENTS;
```

–ü–æ–ª–µ–∑–Ω—ã–µ –ø–æ–ª—è: `cl_active`, `cl_waiting`, `sv_active`, `sv_idle`

–ï—Å–ª–∏ –º–Ω–æ–≥–æ `cl_waiting` ‚Äî —ç—Ç–æ —Å–∏–≥–Ω–∞–ª —Ç—Ä–µ–≤–æ–≥–∏.

---

## ‚úÖ –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ?

* –ù–µ –≥–Ω–∞—Ç—å—Å—è –∑–∞ `max_client_conn`, –∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å `pool_size`
* –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å `waiting clients`
* –£—á–∏—Ç—ã–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Ä–∫–µ—Ä–æ–≤ Puma / Unicorn / Sidekiq

---

## üí° –í—ã–≤–æ–¥

PgBouncer ‚Äî –Ω–µ —Å–µ—Ä–µ–±—Ä—è–Ω–∞—è –ø—É–ª—è.
–ï–≥–æ –Ω—É–∂–Ω–æ **–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å, –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å**. –ê –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤—ã—Å—Ç–∞–≤–∏—Ç—å `max_client_conn = 5000` –∏ –Ω–∞–¥–µ—è—Ç—å—Å—è –Ω–∞ –ª—É—á—à–µ–µ.
