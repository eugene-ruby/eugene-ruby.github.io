---
layout: post
subtitle: <div id="terminal"></div>
title:  "Ruby: fork, Parallel, Ractor –∏ async ‚Äî –∫–æ–≥–¥–∞ GIL –Ω–µ –ø—Ä–æ–π–¥—ë—Ç"
date:   2023-10-10 13:00:00 +0300
rate: 3
tags: Ruby,–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å,GIL,–ø—Ä–æ—Ü–µ—Å—Å—ã,–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å,Ractor
version: A49X3
categories:
  - performance
  - ruby
toc: true
menubar_toc: true
hero_image: /images/ruby.jpg
hero_darken: true
---
Ruby –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç–∏, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è GIL. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º—Å—è, –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã —á–µ—Ä–µ–∑ fork, –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—Ä–æ–¥–µ Ractor, –∞ —Ç–∞–∫–∂–µ –∫–æ–≥–¥–∞ —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Ruby –≤—Ä–æ–¥–µ JRuby.

---

–í –ø—Ä–æ—à–ª–æ–π —Å—Ç–∞—Ç—å–µ –º—ã –≤—ã—è—Å–Ω–∏–ª–∏, —á—Ç–æ –ø–æ—Ç–æ–∫–∏ –≤ MRI Ruby ‚Äî —ç—Ç–æ –≤–µ–∂–ª–∏–≤—ã–π –æ–±–º–∞–Ω.  
–ê —á—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ **–Ω—É–∂–Ω–∞ –Ω–∞—Å—Ç–æ—è—â–∞—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å**? –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–ø—Ä–æ—Ü–µ—Å—Å—ã**, **–∞—Å–∏–Ω—Ö—Ä–æ–Ω—â–∏–Ω—É**, –∏ **–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ VM**. –°–µ–≥–æ–¥–Ω—è –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ:

- `fork`
- –≥–µ–º–∞—Ö —Ç–∏–ø–∞ `Parallel`
- `Ractor` (–≤ Ruby 3+)
- –∏ –Ω–µ–º–Ω–æ–≥–æ `async`, `httpx`, `falcon`

---

## üß† fork ‚Äî —Å–æ–∑–¥–∞—ë–º –ø—Ä–æ—Ü–µ—Å—Å—ã

```ruby
pid = fork do
  puts "–Ø –¥–æ—á–µ—Ä–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å, –º–æ–π PID #{Process.pid}"
  sleep 1
end

puts "–Ø —Ä–æ–¥–∏—Ç–µ–ª—å, PID #{Process.pid}"
Process.wait(pid)
````

* `fork` —Å–æ–∑–¥–∞—ë—Ç **–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å**, –∫–æ–ø–∏—é —Ç–µ–∫—É—â–µ–≥–æ.
* –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –ø–æ—Ç–æ–∫–æ–≤ ‚Äî —ç—Ç–æ –Ω–∞—Å—Ç–æ—è—â–∞—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å (–Ω–∞ —É—Ä–æ–≤–Ω–µ –û–°).
* –†–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –≤ Unix-—Å–∏—Å—Ç–µ–º–∞—Ö** (–Ω–µ Windows).

---

## ‚öôÔ∏è Parallel ‚Äî –≥–µ–º, –∫–æ—Ç–æ—Ä—ã–π –∞–±—Å—Ç—Ä–∞–≥–∏—Ä—É–µ—Ç `fork`

```ruby
require 'parallel'

results = Parallel.map([1, 2, 3, 4], in_processes: 4) do |i|
  i * i
end

puts results.inspect # => [1, 4, 9, 16]
```

* `Parallel.map` –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–¥ –≤ `fork`-–ø—Ä–æ—Ü–µ—Å—Å–∞—Ö.
* –ï—Å—Ç—å `in_threads`, –Ω–æ `in_processes` ‚Äî –±–µ–∑ GIL.

---

## üß¨ Ractor (Ruby 3+)

```ruby
r = Ractor.new do
  val = Ractor.receive
  Ractor.yield val * 2
end

r.send(21)
puts r.take # => 42
```

* **Ractor** ‚Äî –Ω–æ–≤—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ Ruby 3.
* –ö–∞–∂–¥—ã–π `Ractor` –∏–º–µ–µ—Ç —Å–≤–æ–π –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç–Ω—ã–π –º–∏—Ä.
* **–ë–µ–∑ GIL** ‚Äî –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Ruby-–∫–æ–¥–∞ –≤–æ–∑–º–æ–∂–Ω–æ.
* –ú–∏–Ω—É—Å: –∂—ë—Å—Ç–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–æ–±—ä–µ–∫—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å "shareable").

---

## üåä async ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –±–µ–∑ –ø–æ—Ç–æ–∫–æ–≤

```ruby
require 'async'
require 'net/http'

Async do
  3.times do
    Async do
      puts Net::HTTP.get(URI("https://example.com"))
    end
  end
end
```

* –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ [`async`](https://github.com/socketry/async)
* –†–µ–∞–ª–∏–∑—É–µ—Ç **–∫–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—É—é –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å**, –∫–∞–∫ `async/await` –≤ JS.
* –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫–∏, –ø–æ–∫–∞ –∂–¥—ë—Ç I/O.

---

## üöÄ Falcon –∏ HTTPX

* [`falcon`](https://github.com/socketry/falcon) ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Rack-—Å–µ—Ä–≤–µ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ `async`.
* [`httpx`](https://github.com/honeyryderchuck/httpx) ‚Äî HTTP/2-–∫–ª–∏–µ–Ω—Ç —Å async-–ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.

–ò–¥–µ–∞–ª—å–Ω—ã –¥–ª—è **–≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö I/O –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π** ‚Äî —á–∞—Ç-–±–æ—Ç–æ–≤, —Å—Ç—Ä–∏–º–∏–Ω–≥–∞, –ø—É—à–µ–π –∏ —Ç.–¥.

---

## ü§ñ –ê –µ—Å–ª–∏ –Ω—É–∂–µ–Ω —Ä–µ–∞–ª—å–Ω–æ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π Ruby?

* **JRuby** ‚Äî Ruby –Ω–∞ JVM: –ø–æ—Ç–æ–∫–∏ = –Ω–∞—Å—Ç–æ—è—â–∏–µ Java-–ø–æ—Ç–æ–∫–∏, GIL –Ω–µ—Ç.
* **TruffleRuby** ‚Äî —á–∞—Å—Ç—å GraalVM, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å.
* **Rubinius** ‚Äî –ø–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞—Ç—å Ruby –±–µ–∑ GIL (—É–∂–µ –Ω–µ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ).

---

## üß® –ß—Ç–æ –º–æ–≥—É—Ç —Å–ø—Ä–æ—Å–∏—Ç—å –Ω–∞ —Å–æ–±–µ—Å–µ?

> ‚Äú–ö–∞–∫ —Ç—ã —Ä–µ–∞–ª–∏–∑—É–µ—à—å CPU-bound –ø–∞—Ä—Ä–∞–ª–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ MRI?‚Äù

–û—Ç–≤–µ—Ç:

* **fork** —á–µ—Ä–µ–∑ `Parallel` (–µ—Å–ª–∏ Unix)
* –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JRuby/TruffleRuby
* Ractor ‚Äî –≤ —Ç–µ–æ—Ä–∏–∏, –Ω–æ –µ—â—ë —Å—ã—Ä–æ–π

---

üîö **–í—ã–≤–æ–¥:**
MRI Ruby –Ω–µ –ø—Ä–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–æ –æ–±—Ö–æ–¥–Ω—ã–µ –ø—É—Ç–∏ –µ—Å—Ç—å. –í–∞–∂–Ω–æ –∑–Ω–∞—Ç—å, **—á—Ç–æ –∫–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å**:

| –ó–∞–¥–∞—á–∞              | –ß—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å           |
| ------------------- | -------------------------- |
| I/O-bound           | `Thread`, `async`, `httpx` |
| CPU-bound (–≤ MRI)   | `fork`, `Parallel`         |
| CPU-bound (–±–µ–∑ MRI) | `JRuby`, `TruffleRuby`     |
| –•–∞—Ä–¥–∫–æ—Ä-–∏–∑–æ–ª—è—Ü–∏—è    | `Ractor`                   |
