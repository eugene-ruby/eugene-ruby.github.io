---
layout: post
subtitle: <div id="terminal"></div>
title:  "–ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è –ø—Ä–æ—Å—Ç–æ –≤–∑—è—Ç—å current_user"
date:   2025-04-27 12:00:00 +0300
rate: 3
tags: Ruby on Rails,current_user,—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏,—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è,PostgreSQL,DevOps
version: A9X
categories:
  - architecture
  - rails
toc: true
menubar_toc: true
hero_image: /images/architecture.jpg
hero_darken: true
---
–í —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –Ω–∞ Ruby on Rails —Ä–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª–æ–∂–Ω–µ–µ –ø–æ –º–µ—Ä–µ —Ä–æ—Å—Ç–∞ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –∫–æ–≥–¥–∞ –∑–∞–¥–∞—á–∏ –≤—ã—Ö–æ–¥—è—Ç –∑–∞ —Ä–∞–º–∫–∏ HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å current_user –≤ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö, —Å–æ–±—ã—Ç–∏—è—Ö –∏ —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞—Ö, –∏–∑–±–µ–≥–∞—è —Å–∫—Ä—ã—Ç—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –≤ PostgreSQL-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö. DevOps-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã –æ—Ü–µ–Ω—è—Ç –ø–æ–¥—Ö–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –∫–æ–¥ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º –∫–∞–∫ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ, —Ç–∞–∫ –∏ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏.

---

–ö–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–∞–ª–µ–Ω—å–∫–æ–µ ‚Äî `current_user` –ª–µ–≥–∫–æ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞.  
–ù–æ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º –≤—Å—ë –Ω–∞—á–∏–Ω–∞–µ—Ç –ª–æ–º–∞—Ç—å—Å—è: —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏, –≤–æ—Ä–∫–µ—Ä—ã, —Å–æ–±—ã—Ç–∏—è, –∫–æ–º–∞–Ω–¥—ã ‚Äî –∏ –≤—Å–µ –∫—Ä–∏—á–∞—Ç:
> –ê –∫—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-—Ç–æ?!

## üßµ –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ—Ä—è–µ—Ç—Å—è

–í–æ—Ç –ø—Ä–∏–º–µ—Ä:

```ruby
class CreateReportJob < ApplicationJob
  def perform(report_id)
    report = Report.find(report_id)
    ReportBuilder.new(report).call # –ê –∫—Ç–æ –≤—ã–∑–≤–∞–ª?!
  end
end
````

–ê —Ç–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ–±—É–π –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –ø–æ–¥–ø–∏—Å–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ë–µ–∑ `current_user` ‚Äî —ç—Ç–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.

---

## üß≥ –ü–µ—Ä–µ–¥–∞–≤–∞–π —è–≤–Ω–æ

–í–º–µ—Å—Ç–æ "–º–∞–≥–∏–∏ –∏–∑ –≤–æ–∑–¥—É—Ö–∞", –ø–µ—Ä–µ–¥–∞–≤–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **—è–≤–Ω–æ**:

```ruby
GenerateReport.call(user: current_user, report: report)
```

–ê –≤–Ω—É—Ç—Ä–∏:

```ruby
class GenerateReport
  def initialize(user:, report:)
    @user = user
    @report = report
  end
end
```

---

## üî• –ß—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫

* –í —Ç–µ—Å—Ç–∞—Ö `current_user` –±—É–¥–µ—Ç `nil`
* –í –∫–æ–Ω—Å—é–º–µ—Ä–µ Kafka –Ω–µ—Ç `request`
* –í Sidekiq –Ω–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
* –í event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ ‚Äî `current_user` –Ω–µ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è

---

## üõ°Ô∏è –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: context

–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏ –∏–ª–∏ –æ–±—ë—Ä—Ç–∫–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –ø—Ä–æ–∫–∏–¥—ã–≤–∞—Ç—å **context**:

```ruby
context = { current_user: user }
SomeService.call(context: context)
```

–ù–æ –≤ Rails —ç—Ç–æ –Ω–µ –¥–µ—Ñ–æ–ª—Ç ‚Äî –ª—É—á—à–µ –±—ã—Ç—å —è–≤–Ω—ã–º.

---

## ‚úÖ –í—ã–≤–æ–¥

–ú–µ–Ω—å—à–µ –º–∞–≥–∏–∏ ‚Äî –±–æ–ª—å—à–µ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏.
–ü–µ—Ä–µ–¥–∞–≤–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏ –≤–æ–æ–±—â–µ –≤—Å—ë –≤–∞–∂–Ω–æ–µ) **–≤ —è–≤–Ω–æ–π —Ñ–æ—Ä–º–µ**, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ —Ä–∞–±–æ—Ç–∞ —É—Ö–æ–¥–∏—Ç –∑–∞ —Ä–∞–º–∫–∏ –∑–∞–ø—Ä–æ—Å–∞.
