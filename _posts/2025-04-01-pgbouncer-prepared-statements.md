---
layout: post
subtitle: <div id="terminal"></div>
title: "PgBouncer –∏ Prepared Statements: –º–µ–¥–ª–µ–Ω–Ω–∞—è —Å–º–µ—Ä—Ç—å Rails"
date: 2025-04-01 16:00:00 +0300
rate: 3
tags: Ruby on Rails,PostgreSQL,PgBouncer,prepared statements,transaction mode,performance
version: A9X
categories:
  - postgres
  - rails
toc: true
menubar_toc: true
hero_image: /images/architecture.jpg
hero_darken: true
---
–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Ruby on Rails –∏ PostgreSQL –≤–∞–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ PgBouncer –≤ —Ä–µ–∂–∏–º–µ transaction, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –≤—Ä–æ–¥–µ PG::ProtocolViolation. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º, –ø–æ—á–µ–º—É –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å prepared statements, –∫–∞–∫ –∏—Ö –∏–∑–±–µ–∂–∞—Ç—å –∏ –∫–∞–∫–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ –º–µ–∂–¥—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å—é.

## üìâ –ü—Ä–æ–±–ª–µ–º–∞

–í—ã —Å—Ç–∞–≤–∏—Ç–µ `PgBouncer` –≤ —Ä–µ–∂–∏–º–µ `transaction`, –ø–æ–¥–∫–ª—é—á–∞–µ—Ç–µ Rails ‚Äî –∏ –≤—Å—ë –≤—Ä–æ–¥–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.  
–ê –ø–æ—Ç–æ–º –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç–∏:

- **–ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–µ –æ—à–∏–±–∫–∏**
- **–°–±–æ–∏ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏—è—Ö**
- **–í–Ω–µ–∑–∞–ø–Ω–æ ‚Äî `PG::ProtocolViolation`**

---

## üß† –ü–æ—á–µ–º—É —Ç–∞–∫?

Rails –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **prepared statements** ‚Äî —ç—Ç–æ SQL-–∑–∞–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∏ –∫–µ—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

–ê **PgBouncer –≤ —Ä–µ–∂–∏–º–µ `transaction`** —Ä–∞–∑–¥–∞—ë—Ç **—Ä–∞–∑–Ω—ã–µ** —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å.  
–ó–Ω–∞—á–∏—Ç ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ—Ç–µ—Ä—è–Ω.

---

## üî• –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è

1. –ó–∞–ø—Ä–æ—Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ A.
2. –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å —É—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ B.
3. PostgreSQL –æ—Ç–≤–µ—á–∞–µ—Ç: ¬´—è –Ω–µ –∑–Ω–∞—é, —á—Ç–æ –∑–∞ `$1`¬ª.
4. –ü–æ–ª—É—á–∞–µ–º –æ—à–∏–±–∫—É `PG::ProtocolViolation` –∏–ª–∏ `PG::InvalidPreparedStatementName`.

---

## üîß –ö–∞–∫ —Ä–µ—à–∏—Ç—å

### ‚úÖ –û—Ç–∫–ª—é—á–∏—Ç—å prepared statements –≤ Rails

–î–æ–±–∞–≤—å—Ç–µ –≤ `config/database.yml`:

```yaml
production:
  adapter: postgresql
  prepared_statements: false
````

### ‚úÖ –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∂–∏–º `session` –≤ PgBouncer

–ù–æ —Ç–æ–≥–¥–∞ —Ç–µ—Ä—è–µ—Ç—Å—è —Å—É—Ç—å PgBouncer: **–Ω–µ—Ç —ç–∫–æ–Ω–æ–º–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**.

---

## ü§î –ê –º–æ–∂–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å?

–ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ PgBouncer ‚Äî **–æ—Ç–∫–ª—é—á–∞–π—Ç–µ prepared statements** –≤ Rails.
–û–Ω–∏ –ø—Ä–æ—Å—Ç–æ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã –≤ `transaction`-—Ä–µ–∂–∏–º–µ, –∫–æ—Ç–æ—Ä—ã–π –∏ –¥–µ–ª–∞–µ—Ç PgBouncer –ø–æ–ª–µ–∑–Ω—ã–º.

---

## üß© –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞?

PostgreSQL 14+ —É–º–µ–µ—Ç **JIT**, –∞ Rails —Å `prepared_statements: false` –Ω–µ —Å–∏–ª—å–Ω–æ —Ç–µ—Ä—è–µ—Ç –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –∑–∞—Ç–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ.

---

## ‚úÖ –í—ã–≤–æ–¥

* PgBouncer –≤ —Ä–µ–∂–∏–º–µ `transaction` –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º —Å Rails –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
* –•–æ—Ç–∏—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –æ—Ç–∫–ª—é—á–∏—Ç–µ prepared statements.
* –•–æ—Ç–∏—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å ‚Äî —Å—Ç–∞–≤—å—Ç–µ Redis ü´£
