---
layout: post
subtitle: <div id="terminal"></div>
title:  "Docker –∏ –µ–≥–æ –¥—Ä—É–∑—å—è: Compose, Swarm, K8s"
date:   2024-09-18 12:00:00 +0300
rate: 3
tags: Docker,DevOps,Ruby on Rails,PostgreSQL,–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
version: A49X3
categories:
  - devops
  - architecture
hero_image: /images/ruby.jpg
hero_darken: true
toc: true
menubar_toc: true
---
Docker –∏–∑–º–µ–Ω–∏–ª –ø—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏ –¥–µ–ø–ª–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –Ω–æ –æ–¥–∏–Ω–æ–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äî –ª–∏—à—å –Ω–∞—á–∞–ª–æ –∏—Å—Ç–æ—Ä–∏–∏. –í —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ –µ–≥–æ –¥—Ä—É–∑—å—è ‚Äî Compose, Swarm –∏ Kubernetes ‚Äî –ø–æ–º–æ–≥–∞—é—Ç —Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã, –∏ –ø–æ–∫–∞–∂–µ–º –∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Ruby on Rails –∏ PostgreSQL.

---
–í—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –Ω–æ–≤—ã–π —Ñ–∏—á-—Ñ–ª–∞–≥ –≤ Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.  
`docker build -t myapp .` ‚Üí `docker run -p 3000:3000 myapp` ‚Äî –∏ –æ–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç!  
–ù–æ —á—Ç–æ –¥–∞–ª—å—à–µ? –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å 10 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π? –ö–∞–∫ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–µ–∫—Ä–µ—Ç–∞–º–∏?  
–í—Ä–µ–º—è –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å **—ç–∫–æ—Å–∏—Å—Ç–µ–º–æ–π Docker**.

---

## üê≥ Docker: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∫–∞–∫ LEGO

### –û—Å–Ω–æ–≤—ã
Docker —É–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ –≤—Å–µ–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ –≤ **–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä**:
- –ù–µ—Ç "—É –º–µ–Ω—è –Ω–∞ –ª–æ–∫–∞–ª–µ —Ä–∞–±–æ—Ç–∞–ª–æ"
- –û–¥–∏–Ω–∞–∫–æ–≤–∞—è —Å—Ä–µ–¥–∞ –æ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ (vs –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω)

**–ü—Ä–∏–º–µ—Ä Dockerfile –¥–ª—è Rails:**
```dockerfile
FROM ruby:3.2
RUN apt-get update && apt-get install -y postgresql-client
WORKDIR /app
COPY Gemfile* ./
RUN bundle install
COPY . .
CMD ["rails", "server", "-b", "0.0.0.0"]
```

---

## üéª Docker Compose: –æ—Ä–∫–µ—Å—Ç—Ä –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

### –ó–∞—á–µ–º?
–ö–æ–≥–¥–∞ –≤–∞—à –ø—Ä–æ–µ–∫—Ç —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
- Rails-—Å–µ—Ä–≤–µ—Ä–∞
- PostgreSQL
- Redis
- Sidekiq
- Elasticsearch

–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –∞–¥. **Compose** –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å—é —Å–∏—Å—Ç–µ–º—É –≤ YAML.

**–ü—Ä–∏–º–µ—Ä `docker-compose.yml`:**
```yaml
version: '3.8'
services:
  db:
    image: postgres:15
    volumes:
      - db_data:/var/lib/postgresql/data
  web:
    build: .
    ports:
      - "3000:3000"
    depends_on:
      - db
volumes:
  db_data:
```

–ó–∞–ø—É—Å–∫: `docker-compose up -d`

### –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã
1. **–ñ–∏—Ä–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã**: –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä = –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å (–Ω–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä + –≤–æ—Ä–∫–µ—Ä + cron)
2. **–•–∞—Ä–¥–∫–æ–¥ —Å–µ–∫—Ä–µ—Ç–æ–≤**: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `env_file` –∏–ª–∏ Docker Secrets
3. `depends_on` –Ω–µ –∂–¥—ë—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ë–î ‚Üí –Ω—É–∂–Ω—ã healthchecks

---

## üêù Docker Swarm: –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è "–Ω–∞ –º–∏–Ω–∏–º–∞–ª–∫–∞—Ö"

### –ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å?
- –ù—É–∂–Ω–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –±–µ–∑ —Å–ª–æ–∂–Ω–æ—Å—Ç–µ–π Kubernetes
- –ú–∞–ª–µ–Ω—å–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –æ–±—É—á–µ–Ω–∏–µ–º

**–†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ:**
```bash
docker swarm init  # –Ω–∞ –ø–µ—Ä–≤–æ–º —É–∑–ª–µ
docker stack deploy -c docker-compose.prod.yml myapp
```

**–ü–ª—é—Å—ã:**
- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π overlay-—Å–µ—Ç—å –∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫
- –°–µ—Ä–≤–∏—Å—ã –º–∞—Å—à—Ç–∞–±–∏—Ä—É—é—Ç—Å—è –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π
- Rolling updates –±–µ–∑ –¥–∞—É–Ω—Ç–∞–π–º–∞

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
- –ú–µ–Ω—å—à–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ vs K8s

---

## ‚ò∏Ô∏è Kubernetes: –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç

### –ü–æ—á–µ–º—É –≤—Å–µ –≥–æ–≤–æ—Ä—è—Ç –ø—Ä–æ K8s?
–ö–æ–≥–¥–∞ Swarm —É–∂–µ –º–∞–ª:
- 100+ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤
- –ê–≤—Ç–æ—Å–∫–µ–π–ª–∏–Ω–≥ –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º
- –°–ª–æ–∂–Ω—ã–µ CI/CD –ø–∞–π–ø–ª–∞–π–Ω—ã

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏:**
- **Pod**: –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ (1+ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)
- **Deployment**: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏—è–º–∏ –∏ —Ä–µ–ø–ª–∏–∫–∞–º–∏
- **Service**: —Å–µ—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø –∫ –ø–æ–¥–∞–º
- **Ingress**: –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è HTTP-—Ç—Ä–∞—Ñ–∏–∫–∞

**–ü—Ä–∏–º–µ—Ä `deployment.yml` –¥–ª—è Rails:**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web
spec:
  replicas: 3
  selector:
    matchLabels:
      app: web
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
      - name: web
        image: myapp:latest
        ports:
        - containerPort: 3000
```

---

## üî• –ë–æ–ª–∏ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–∏—Ä–∞

### 1. –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –≤ Kubernetes
**–ü–ª–æ—Ö–æ:**
```yaml
command: ["rails", "db:migrate && rails server"]
```
**–†–µ—à–µ–Ω–∏–µ:** Jobs –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π + initContainers –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ë–î.

### 2. –°–µ–∫—Ä–µ—Ç—ã
- Swarm: `docker secret create`
- K8s: `Secret`-—Ä–µ—Å—É—Ä—Å—ã + vault-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–ë–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–±–æ—Ä–∞ –ª–æ–≥–æ–≤ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ ‚Äî –≤—ã —Å–ª–µ–ø—ã. –í–∞—Ä–∏–∞–Ω—Ç—ã:
- ELK-—Å—Ç–µ–∫
- Loki + Grafana
- Cloud-—Ä–µ—à–µ–Ω–∏—è (AWS CloudWatch, GCP Stackdriver)

---

## ÔøΩ –ß—Ç–æ –≤—ã–±—Ä–∞—Ç—å –¥–ª—è Ruby-–ø—Ä–æ–µ–∫—Ç–∞?

| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç       | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å                     | –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è               |
|------------------|---------------------------------------|------------------------------------|
| Docker           | –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞                  | `docker run -p 3000:3000 myapp`    |
| Compose          | Dev-–æ–∫—Ä—É–∂–µ–Ω–∏–µ, –¥–µ–º–æ-—Å—Ç–µ–Ω–¥—ã            | –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Å—Ç–µ–∫–∞ (Rails+PG+Redis) |
| Swarm            | –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∫—à–Ω-–∫–ª–∞—Å—Ç–µ—Ä—ã             | Small/medium SaaS                  |
| Kubernetes       | –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã, –≤—ã—Å–æ–∫–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏        | Enterprise-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è              |

**–õ–∏—á–Ω—ã–π –æ–ø—ã—Ç:**  
–î–ª—è –º–æ–Ω–æ–ª–∏—Ç–∞ –Ω–∞ Rails —Å 5-10 —Å–µ—Ä–≤–∏—Å–∞–º–∏ Swarm ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏/–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π.  
–ö–æ–≥–¥–∞ –ø–æ—è–≤–ª—è—é—Ç—Å—è 15+ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ Ruby ‚Äî –≤—Ä–µ–º—è –ø–µ—Ä–µ–µ–∑–∂–∞—Ç—å –≤ Kubernetes.

---

## üé§ –ß—Ç–æ —Å–ø—Ä–æ—Å—è—Ç –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏

> ‚Äî –ö–∞–∫ –±—ã –≤—ã —Ä–∞–∑–≤–µ—Ä–Ω—É–ª–∏ Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ñ–æ–Ω–æ–≤—ã–º–∏ –≤–æ—Ä–∫–µ—Ä–∞–º–∏ –≤ K8s?

‚Äî –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –±—ã Deployment –¥–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π Deployment –¥–ª—è Sidekiq. –î–ª—è –º–∏–≥—Ä–∞—Ü–∏–π ‚Äî Job —Å —Ä—É—á–Ω—ã–º –∑–∞–ø—É—Å–∫–æ–º –∏–ª–∏ —Ö—É–∫–æ–º –≤ CI/CD. –°–µ–∫—Ä–µ—Ç—ã —á–µ—Ä–µ–∑ Secrets –∏–ª–∏ –≤–Ω–µ—à–Ω–∏–π Vault.

---

## üßæ –í—ã–≤–æ–¥

Docker ‚Äî —ç—Ç–æ –¥–≤–µ—Ä—å –≤ –º–∏—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏, –Ω–æ –Ω–∞—Å—Ç–æ—è—â–∞—è –º–∞–≥–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏:
- **Compose** ‚Äî –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏,  
- **Swarm** ‚Äî –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–æ–¥–∞–∫—à–Ω-—Å–µ—Ç–∞–ø–æ–≤,  
- **Kubernetes** ‚Äî –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ "—Ç—è–∂—ë–ª–∞—è –∞—Ä—Ç–∏–ª–ª–µ—Ä–∏—è".  

–ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –ø–µ—Ä–µ—É—Å–ª–æ–∂–Ω–∏—Ç—å. –ò–Ω–æ–≥–¥–∞ `docker-compose.prod.yml` —Ä–µ—à–∞–µ—Ç –≤—Å–µ –∑–∞–¥–∞—á–∏ –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞ –±–µ–∑ –≥–æ–ª–æ–≤–Ω–æ–π –±–æ–ª–∏ K8s.
