---
layout: post
subtitle: <div id="terminal"></div>
title:  "select, group, having, joins, merge ‚Äî –∫–∞–∫ —Å–ª–æ–º–∞—Ç—å ActiveRecord (–∏ –≤—ã–∂–∏—Ç—å)"
date:   2024-11-16 14:00:00 +0300
rate: 5
tags: ActiveRecord,PostgreSQL,SQL,Rails,group,having
version: A9X
categories:
  - orm
  - rails
toc: true
menubar_toc: true
hero_image: /images/posts/49.jpg
hero_darken: true
---
ActiveRecord –≤ Rails ‚Äî –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PostgreSQL, –Ω–æ –¥–∞–∂–µ –æ–ø—ã—Ç–Ω—ã–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å—Ç–∞–ª–∫–∏–≤–∞—é—Ç—Å—è —Å –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ group, having –∏ merge. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º —Ç–∏–ø–∏—á–Ω—ã–µ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ —Å–ª–æ–∂–Ω—ã—Ö SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ ActiveRecord –∏ —Å–ø–æ—Å–æ–±—ã –∏—Ö –∏–∑–±–µ–∂–∞—Ç—å.

---

–ö–∞–∂–µ—Ç—Å—è, –≤—Å—ë –ø—Ä–æ—Å—Ç–æ: –¥–æ–±–∞–≤–∏–ª `joins`, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–ª `group(...)`, –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–ª —á–µ—Ä–µ–∑ `having(...)`.  
–ê –ø–æ—Ç–æ–º –≤–Ω–µ–∑–∞–ø–Ω–æ `ActiveRecord::StatementInvalid`, `nil –≤–º–µ—Å—Ç–æ –ø–æ–ª—è` –∏–ª–∏ —Ç–µ—Ä—è—é—Ç—Å—è —É—Å–ª–æ–≤–∏—è. –ü–æ—á–µ–º—É?


## üòµ select + group

```ruby
User.select("users.id").group("users.id").first.name
# => nil üò±
````

–¢—ã —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–ª –ø–æ `id`, –Ω–æ `name` –Ω–µ –≤—ã–±—Ä–∞–ª. –í `User`-–æ–±—ä–µ–∫—Ç–µ –Ω–µ—Ç `name`, –∞ Rails –Ω–µ –∂–∞–ª—É–µ—Ç—Å—è ‚Äî –ø—Ä–æ—Å—Ç–æ `nil`.

---

## üîç having –±–µ–∑ group ‚Äî –æ—à–∏–±–∫–∞

```ruby
User.having("count(posts.id) > 10")
# => ActiveRecord::StatementInvalid: HAVING clause requires GROUP BY
```

`having` —Ä–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ —Å** `group`. –í –æ–±—ã—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–π `where`.

---

## ‚ö†Ô∏è merge –∏ –ø–æ—Ç–µ—Ä—è —É—Å–ª–æ–≤–∏–π

```ruby
scope :active, -> { where(active: true) }

Post.joins(:user).merge(User.active)
```

–≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ù–æ –µ—Å–ª–∏ —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å `includes` –∏–ª–∏ `eager_load`, merge –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –∏–ª–∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å—Å—è –≤ `WHERE 1=0`, –µ—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã.

---

## üëÄ –ê –µ—Å–ª–∏ `joins` + `merge`?

```ruby
User.joins(:posts).merge(Post.published)
```

–≠—Ç–æ **–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–ø–æ—Å–æ–±** –Ω–∞–ª–æ–∂–∏—Ç—å —É—Å–ª–æ–≤–∏—è –∏–∑ –¥—Ä—É–≥–æ–≥–æ scope, –Ω–æ –≤–∞–∂–Ω–æ: `merge` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ `joins`, –µ—Å–ª–∏ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—è –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.

---

## üß® –ò—Ç–æ–≥–æ ‚Äî —á–∞—Å—Ç—ã–µ –ª–æ–≤—É—à–∫–∏

| –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è                | –ü–æ–¥–≤–æ–¥–Ω—ã–π –∫–∞–º–µ–Ω—å                       |
| -------------------------- | -------------------------------------- |
| `select("...")`            | –ø–æ–ª—è –≤–Ω–µ select –±—É–¥—É—Ç `nil`            |
| `group(...).having(...)`   | `having` –±–µ–∑ `group` ‚Äî –æ—à–∏–±–∫–∞          |
| `merge(...)`               | —Ç—Ä–µ–±—É–µ—Ç `joins` / `includes`           |
| `joins(:assoc).merge(...)` | ok, –Ω–æ scope –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–µ–Ω       |
| `eager_load + merge`       | –º–æ–∂–µ—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –¥–∞—Ç—å –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç |

---

üìå –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —Å—Ç–∞–ª —Å–ª–æ–∂–Ω–µ–µ –ø–∞—Ä—ã –º–µ—Ç–æ–¥–æ–≤ ‚Äî –ø—Ä–æ–≤–µ—Ä—å SQL —á–µ—Ä–µ–∑ `.to_sql`.
Rails –≥–∏–±–∫–∏–π, –Ω–æ –ª–µ–≥–∫–æ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —Ü–µ–ø–æ—á–∫—É –≤ –º–∏–Ω–Ω–æ–µ –ø–æ–ª–µ.
