---
layout: post
title:  "–°–¥–µ–ª–∞–ª EXPLAIN ‚Äî –∏ —á—Ç–æ –¥–∞–ª—å—à–µ? –ö–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å"
date:   2025-01-22 11:00:00 +0300
rate: 4
tags: PostgreSQL,SQL,–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤,EXPLAIN ANALYZE,–∏–Ω–¥–µ–∫—Å—ã,JOIN
version: A49X3
categories:
  - postgres
toc: true
menubar_toc: true
hero_image: /images/rails.jpeg
hero_darken: true
---
PostgreSQL ‚Äî –º–æ—â–Ω–∞—è –°–£–ë–î, –Ω–æ –¥–∞–∂–µ –æ–ø—ã—Ç–Ω—ã–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å—Ç–∞–ª–∫–∏–≤–∞—é—Ç—Å—è —Å –º–µ–¥–ª–µ–Ω–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–∏—Ä–∞–µ–º, –∫–∞–∫ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ `EXPLAIN ANALYZE`, –Ω–∞—Ö–æ–¥–∏—Ç—å —É–∑–∫–∏–µ –º–µ—Å—Ç–∞ –∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ ‚Äî –æ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–æ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∞ JOIN'–æ–≤. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏ —á–µ–∫–ª–∏—Å—Ç –ø–æ–º–æ–≥—É—Ç —É—Å–∫–æ—Ä–∏—Ç—å –≤–∞—à–∏ SQL-–∑–∞–ø—Ä–æ—Å—ã –≤ Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö.

---

–¢—ã –Ω–∞–ø–∏—Å–∞–ª `EXPLAIN (ANALYZE, BUFFERS)` ‚Äî –∏ –ø–æ–ª—É—á–∏–ª —Å—Ç—Ä–∞—à–Ω–æ–µ –¥—Ä–µ–≤–æ –ø–ª–∞–Ω–æ–≤.  
–ö–∞–∫ –∏–∑ —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–π—Ç–∏ –∫ **—Ä–µ–∞–ª—å–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**?  
–í–æ—Ç –∫—Ä–∞—Ç–∫–∏–π —á–µ–∫–ª–∏—Å—Ç –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —à–∞–≥–æ–≤.

## üïµÔ∏è –®–∞–≥ 1. –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ **–ø–µ—Ä–≤—ã–π —É–∑–µ–ª**

–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–ª–∞–Ω–∞ ‚Äî –∫–ª—é—á–µ–≤–∞—è:

```text
Nested Loop  (actual time=...)
````

üìå –ï—Å–ª–∏ —Ç—É—Ç `Seq Scan`, `Nested Loop`, `rows=100000` ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –±–µ–¥–∞.
–ò—â–∏, –Ω–∞ —á—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ **`actual time`** –∏ **`loops=...`**

---

## üìö –®–∞–≥ 2. –ü–æ–π–º–∏ **–≥–¥–µ –∏ —á—Ç–æ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç—Å—è**

* `Seq Scan` –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ —Å –º–∏–ª–ª–∏–æ–Ω–∞–º–∏ —Å—Ç—Ä–æ–∫? üí£
* `Index Scan`, –Ω–æ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ `loops=...`? üîÅ
* `Bitmap Heap Scan` —Å **–º–Ω–æ–≥–æ read**? üíæ

üí° –°—Ä–∞–≤–Ω–∏ `rows` (–æ—Ü–µ–Ω–∫–∞) –∏ `actual rows` ‚Äî –µ—Å–ª–∏ –æ–Ω–∏ **—Å–∏–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è**, Postgres –æ—à–∏–±–∞–µ—Ç—Å—è –≤ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è—Ö.
üõ† –ò—Å–ø–æ–ª—å–∑—É–π `ANALYZE` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.

---

## üì¶ –®–∞–≥ 3. –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ BUFFERS

```text
Buffers: shared hit=400 read=800
```

* **read > hit** ‚Üí –¥–∞–Ω–Ω—ã–µ —Å –¥–∏—Å–∫–∞ ‚Üí –º–µ–¥–ª–µ–Ω–Ω–æ
* **dirtied** ‚Üí —Ç—ã —á—Ç–æ-—Ç–æ –ø–∏—à–µ—à—å (—É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ?)

---

## üîÑ –®–∞–≥ 4. –ü—Ä–æ–≤–µ—Ä—å –ø–æ—Ä—è–¥–æ–∫ `JOIN`'–æ–≤

–ï—Å–ª–∏ `Nested Loop` + –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ç–∞–±–ª–∏—Ü–∞ –±–æ–ª—å—à–∞—è ‚Äî —ç—Ç–æ **–ª–æ–≤—É—à–∫–∞**.
–ü–æ–º–µ–Ω—è–π –ø–æ—Ä—è–¥–æ–∫ —Ç–∞–±–ª–∏—Ü (`JOIN` –≤ –¥—Ä—É–≥–æ–º –ø–æ—Ä—è–¥–∫–µ) –∏–ª–∏ **–∑–∞—Å—Ç–∞–≤—å** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Hash Join` (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ `enable_nestloop = off` –≤—Ä–µ–º–µ–Ω–Ω–æ).

---

## üß† –®–∞–≥ 5. –ü–æ–¥—É–º–∞–π: –Ω—É–∂–µ–Ω –ª–∏ —Ç–µ–±–µ –ø–æ–¥–∑–∞–ø—Ä–æ—Å?

```sql
SELECT * FROM users WHERE id IN (
  SELECT user_id FROM posts WHERE ...
)
```

‚Üí –ú–µ–¥–ª–µ–Ω–Ω–æ, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ `IN (...)` –¥–ª–∏–Ω–Ω—ã–π.

üõ† –õ—É—á—à–µ `JOIN`, `EXISTS` –∏–ª–∏ CTE.

---

## üí° –°–æ–≤–µ—Ç—ã –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

| –ü—Ä–æ–±–ª–µ–º–∞                   | –ß—Ç–æ –¥–µ–ª–∞—Ç—å                                |
| -------------------------- | ----------------------------------------- |
| `Seq Scan`                 | –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å                           |
| `Nested Loop` + –º–Ω–æ–≥–æ rows | –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å `Hash Join`                   |
| `read > hit`               | –£–≤–µ–ª–∏—á–∏—Ç—å `work_mem`, –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏–∫—É |
| `Bitmap Heap Scan`         | –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏ –∏–Ω–¥–µ–∫—Å—ã          |
| –ù–µ—Ç `Index Scan`           | –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å, —É—Ç–æ—á–Ω–∏—Ç—å —É—Å–ª–æ–≤–∏–µ         |

---

## üß™ –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

1. –ù–∞–ø–∏—à–∏ –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
2. –°–¥–µ–ª–∞–π `EXPLAIN (ANALYZE, BUFFERS)`
3. –ò–∑–º–µ–Ω–∏ (JOIN, –∏–Ω–¥–µ–∫—Å—ã, LIMIT, —Ñ–∏–ª—å—Ç—Ä—ã)
4. –°–Ω–æ–≤–∞ `EXPLAIN`
5. –°—Ä–∞–≤–Ω–∏ –≤—Ä–µ–º—è, read/hit, –ø–ª–∞–Ω

---

üí¨ –ü–æ–¥—Å–∫–∞–∑–∫–∞: –∏—Å–ø–æ–ª—å–∑—É–µ—à—å Postgres ‚â•13? –ú–æ–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω –∏–∑ `pgAdmin`, –∞ –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –µ–≥–æ –≤ [https://explain.dalibo.com/](https://explain.dalibo.com/) ‚Äî –∏ –æ–Ω –ø–æ–∫–∞–∂–µ—Ç –≤—Å—ë –Ω–∞–≥–ª—è–¥–Ω–æ.
