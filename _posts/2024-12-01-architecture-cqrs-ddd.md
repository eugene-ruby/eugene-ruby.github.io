---
layout: post
title:  "CQRS, Event Sourcing –∏ DDD –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞—Ö –Ω–∞ Rails"
date:   2024-12-01 10:00:00 +0300
categories:
    - architecture
    - rails
toc: true
menubar_toc: true
hero_image: /images/architecture.jpeg
hero_darken: true
---

–ö–æ–≥–¥–∞ –≤—ã –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –æ—Ç –º–æ–Ω–æ–ª–∏—Ç–∞ –∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º, —Å—Ç–∞—Ä—ã–µ –ø–æ–¥—Ö–æ–¥—ã –Ω–∞—á–∏–Ω–∞—é—Ç —Å–∫—Ä–∏–ø–µ—Ç—å. –ü—Ä—è–º—ã–µ –∞–ø–¥–µ–π—Ç—ã –º–æ–¥–µ–ª–µ–π, –ø—Ä–æ—Å—Ç—ã–µ CRUD-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã, ActiveRecord-–∫–æ–ª–¥—É–Ω—Å—Ç–≤–æ ‚Äî –≤—Å—ë —ç—Ç–æ –Ω–∞—á–∏–Ω–∞–µ—Ç –º–µ—à–∞—Ç—å. –ù–∞ —Å—Ü–µ–Ω—É –≤—ã—Ö–æ–¥—è—Ç —Ç—Ä–∏ –∑–Ω–∞–∫–æ–º—ã—Ö –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—ã: CQRS, Event Sourcing –∏ DDD.

---

## üß† –ó–∞—á–µ–º —ç—Ç–æ –≤–æ–æ–±—â–µ –Ω—É–∂–Ω–æ

ActiveRecord –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–∫–∞ –≤—ã –Ω–µ –ø—ã—Ç–∞–µ—Ç–µ—Å—å —Ä–∞–∑–¥–µ–ª–∏—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ. –ù–æ –∫–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å:

* –≤ **—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥ –∏ –∑–∞–ø—Ä–æ—Å–æ–≤** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–¥–Ω–∏ —Å–µ—Ä–≤–∏—Å—ã —Ç–æ–ª—å–∫–æ –ø–∏—à—É—Ç, –¥—Ä—É–≥–∏–µ —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—é—Ç)
* –≤ **—Å–æ–±—ã—Ç–∏–π–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ**, –≥–¥–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–¥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å
* –≤ **–∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–æ–º–µ–Ω–æ–≤**, –≥–¥–µ –æ–¥–Ω–∞ —Å—É—â–Ω–æ—Å—Ç—å –º–æ–∂–µ—Ç –∑–Ω–∞—á–∏—Ç—å —Ä–∞–∑–Ω–æ–µ –≤ —Ä–∞–∑–Ω—ã—Ö —á–∞—Å—Ç—è—Ö —Å–∏—Å—Ç–µ–º—ã

... —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —è—Å–Ω–æ: –ø–æ—Ä–∞ –≤–Ω–æ—Å–∏—Ç—å —è—Å–Ω–æ—Å—Ç—å –∏ —Ä–∞–∑–¥–µ–ª—è—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.

---

## üü™ CQRS: Command Query Responsibility Segregation

CQRS –¥–µ–ª–∏—Ç –≤–∞—à—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –Ω–∞ –¥–≤–µ —á–∞—Å—Ç–∏:

* **–ö–æ–º–∞–Ω–¥—ã** (Command) ‚Äî –º–µ–Ω—è—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç (–≤ –∏–¥–µ–∞–ª–µ)
* **–ó–∞–ø—Ä–æ—Å—ã** (Query) ‚Äî —á–∏—Ç–∞—é—Ç –¥–∞–Ω–Ω—ã–µ, –Ω–æ –Ω–µ –º–µ–Ω—è—é—Ç –∏—Ö

–ü—Ä–∏–º–µ—Ä:

```ruby
class CreateUserCommand
  def call(name:, email:)
    User.create!(name: name, email: email)
  end
end

class UserQuery
  def self.active
    User.where(active: true)
  end
end
```

---

## üüß Event Sourcing: –Ω–µ –º–µ–Ω—è–µ–º ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º

–í–º–µ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º **–≤—Å–µ —Å–æ–±—ã—Ç–∏—è**, –∫–æ—Ç–æ—Ä—ã–µ –∫ –Ω–µ–º—É –ø—Ä–∏–≤–µ–ª–∏:

```ruby
UserEvent.create!(type: 'created', data: {name: 'Alice'})
UserEvent.create!(type: 'activated', data: {})
```

–ò –ø–æ—Ç–æ–º **–≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º** —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ —ç—Ç–∏—Ö —Å–æ–±—ã—Ç–∏–π.

**–ü–ª—é—Å—ã:**

* –∏–¥–µ–∞–ª—å–Ω–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
* –≥–∏–±–∫–∞—è –æ—Ç–∫–∞—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
* –ø—Ä–æ—â–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏

---

## üü• DDD: Domain Driven Design

–°–ª–æ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –Ω–µ —Å—Ç—Ä–æ—è—Ç—Å—è –≤–æ–∫—Ä—É–≥ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –û–Ω–∏ —Å—Ç—Ä–æ—è—Ç—Å—è –≤–æ–∫—Ä—É–≥ **–±–∏–∑–Ω–µ—Å-–¥–æ–º–µ–Ω–æ–≤**.

DDD –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç:

* –≤—ã–¥–µ–ª—è—Ç—å **–∫–æ–Ω—Ç–µ–∫—Å—Ç—ã** (bounded contexts)
* –Ω–µ —Ç–∞—â–∏—Ç—å AR-–º–æ–¥–µ–ª–∏ –≤–µ–∑–¥–µ, –∞ —Å—Ç—Ä–æ–∏—Ç—å **value objects** –∏ **domain logic**
* –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **domain events** –∫–∞–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±—â–µ–Ω–∏—è

–ü—Ä–∏–º–µ—Ä:

```ruby
class ActivateUser < ApplicationCommand
  def call(user:)
    return failure('already active') if user.active?

    user.activate!
    publish(UserActivated.new(user_id: user.id))
  end
end
```

---

## üí° –í Rails —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ

–¢—ã –º–æ–∂–µ—à—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª—é–±–∏–º—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏, ActiveRecord –∏ rake –∑–∞–¥–∞—á–∏. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –æ—Ç–¥–µ–ª–∏—Ç—å:

* –ü–∏—Å–∞—Ç–µ–ª–∏ –æ—Ç —á–∏—Ç–∞—Ç–µ–ª–µ–π
* –ë–∞–∑—É –æ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
* –ö–æ–º–∞–Ω–¥—ã –æ—Ç —Å–æ–±—ã—Ç–∏–π

–ò —Ç–æ–≥–¥–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –Ω–µ –±—É–¥—É—Ç –ø–æ—Ö–æ–∂–∏ –Ω–∞ –º–æ–Ω–æ–ª–∏—Ç, —Ä–∞—Å–ø–∏–ª–µ–Ω–Ω—ã–π –ø–æ HTTP.
