---
layout: post
subtitle: <div id="terminal"></div>
title:  "ActiveRecord –∏ PostgreSQL JSONB: –∫–æ–≥–¥–∞ –æ–±—ã—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü —É–∂–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ"
date:   2024-09-18 12:00:00 +0300
rate: 3
tags: Ruby,PostgreSQL,JSONB,Rails,–±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö,–º–∏–≥—Ä–∞—Ü–∏–∏
version: A49X3
categories:
  - postgres
  - rails
hero_image: /images/rails.jpg
hero_darken: true
toc: true
menubar_toc: true
---

–í—ã –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å —á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∏, —á—Ç–æ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã ‚Äî —ç—Ç–æ –∫–∞–∫ –ø—ã—Ç–∞—Ç—å—Å—è –≤–ø–∏—Ö–Ω—É—Ç—å –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ–ª—ã—à–µ–∫ –≤ –∫—Ä—É–≥–ª–æ–µ –æ—Ç–≤–µ—Ä—Å—Ç–∏–µ? –ö–æ–≥–¥–∞ –æ—á–µ—Ä–µ–¥–Ω–æ–π `users` —Å 50 –∫–æ–ª–æ–Ω–∫–∞–º–∏ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –∞–¥ –º–∏–≥—Ä–∞—Ü–∏–π, –∞ `serialize :preferences, JSON` –ø—Ä–æ—Å—Ç–æ —Å–º–µ—ë—Ç—Å—è –≤–∞–º –≤ –ª–∏—Ü–æ —Å–≤–æ–µ–π –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é ‚Äî –ø–æ—Ä–∞ –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å **PostgreSQL JSONB**.


---
–í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ –≥—Ä–∞–º–æ—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JSONB –≤ Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∏ —Ä–∞—Å—Å—É–¥–æ–∫.

## üß† –¢–µ–æ—Ä–∏—è: JSONB vs JSON vs Hstore

PostgreSQL –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ç—Ä–∏ —Å–ø–æ—Å–æ–±–∞ —Ö—Ä–∞–Ω–∏—Ç—å "–Ω–µ—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–µ" –¥–∞–Ω–Ω—ã–µ:

| –¢–∏–ø       | –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ | –ò–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å |
|-----------|----------------|-----------------------|--------------|
| JSON      | –ù–µ—Ç            | –î–∞                    | –î–∞           |
| JSONB     | –î–∞             | –î–∞                    | –î–∞           |
| Hstore   | –î–∞             | –ù–µ—Ç                   | –î–∞           |

**JSONB** ‚Äî —ç—Ç–æ "–±–∏–Ω–∞—Ä–Ω—ã–π JSON" —Å:
- –ü–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–Ω–¥–µ–∫—Å–æ–≤ (GIN/GIST)
- –ë—ã—Å—Ç—Ä—ã–º –ø–æ–∏—Å–∫–æ–º –ø–æ –≤–ª–æ–∂–µ–Ω–Ω—ã–º –ø–æ–ª—è–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

---

## üîß –ü—Ä–∞–∫—Ç–∏–∫–∞: –¥–æ–±–∞–≤–ª—è–µ–º JSONB –≤ Rails

–î–æ–ø—É—Å—Ç–∏–º, —É –Ω–∞—Å –µ—Å—Ç—å –º–æ–¥–µ–ª—å `User` —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:

```ruby
# –ú–∏–≥—Ä–∞—Ü–∏—è
class AddPreferencesToUsers < ActiveRecord::Migration[7.0]
  def change
    add_column :users, :preferences, :jsonb, default: {}
    add_index :users, :preferences, using: :gin  # –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
  end
end
```

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Å –æ–±—ã—á–Ω—ã–º —Ö—ç—à–µ–º:

```ruby
user = User.create!(
  email: "dev@example.com",
  preferences: {
    theme: "dark",
    notifications: {
      email: true,
      push: false
    }
  }
)

user.preferences.dig(:notifications, :email) # => true
```

---

## üí° –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JSONB?

1. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã** (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
2. **–õ—ë–≥–∫–∏–µ NoSQL-—Å—Ç—Ä—É–∫—Ç—É—Ä—ã** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ API)
3. **–ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏–µ** (–∫–æ–≥–¥–∞ —Å—Ö–µ–º–∞ –µ—â—ë –Ω–µ —É—Å—Ç–∞–∫–∞–Ω–∏–ª–∞—Å—å)

–ù–æ –ø–æ–º–Ω–∏—Ç–µ: –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ **–∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –±–∏–∑–Ω–µ—Å–∞** –∏ —Ç—Ä–µ–±—É—é—Ç —Å–ª–æ–∂–Ω—ã—Ö JOIN ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –ø–æ–≤–æ–¥ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã.

---

## üöÄ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ–∏—à–∫–∏

### 1. –ü–æ–∏—Å–∫ –ø–æ –≤–ª–æ–∂–µ–Ω–Ω—ã–º –ø–æ–ª—è–º

```ruby
# –ù–∞–π—Ç–∏ –≤—Å–µ—Ö —Å —Ç—ë–º–Ω–æ–π —Ç–µ–º–æ–π
User.where("preferences->>'theme' = ?", "dark")

# –¢–µ, –∫—Ç–æ –æ—Ç–∫–ª—é—á–∏–ª email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
User.where("preferences->'notifications'->>'email' = ?", "false")
```

### 2. –ß–∞—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

```ruby
user.update!(
  "preferences.notifications.push": true
)
```

### 3. –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –º–æ–¥–µ–ª—å

```ruby
class User < ApplicationRecord
  attribute :preferences, :jsonb, default: -> {
    {
      theme: "light",
      notifications: {
        email: true
      }
    }
  }
end
```

---

## üí£ –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã

### 1. JSONB –∫–∞–∫ –º—É—Å–æ—Ä–∫–∞

```ruby
# –ü–ª–æ—Ö–æ: –≤—Å—ë –ø–æ–¥—Ä—è–¥
{
  last_login_ip: "...",
  cached_api_response: "...",
  temp_flags: [...]
}

# –õ—É—á—à–µ: —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
{
  ui_settings: { ... },
  notification_rules: [ ... ]
}
```

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å—Ö–µ–º—ã

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —á—ë—Ç–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é:

```ruby
validate :preferences_schema

def preferences_schema
  errors.add(:preferences, "must include theme") unless preferences.key?(:theme)
end
```

### 3. –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤

–ë–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ–∏—Å–∫ –ø–æ JSONB –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ `O(n)`:

```ruby
# –í –º–∏–≥—Ä–∞—Ü–∏–∏
add_index :users, "(preferences->>'theme')", name: "index_users_on_preferences_theme"
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```ruby
describe User do
  describe "preferences" do
    let(:user) { build(:user, preferences: { theme: "dark" }) }

    it "validates presence of theme" do
      user.preferences.delete(:theme)
      expect(user).not_to be_valid
    end

    it "allows nested updates" do
      user.update!("preferences.notifications.email" => false)
      expect(user.preferences.dig(:notifications, :email)).to eq false
    end
  end
end
```

---

## üé§ –ß—Ç–æ —Å–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏

> ‚Äî –ü–æ—á–µ–º—É –≤—ã –≤—ã–±—Ä–∞–ª–∏ JSONB –≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫?

‚Äî –ú—ã —Ö—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ —Å–ª–∞–±–æ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –Ω–∏–∑–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å—é. JSONB –¥–∞—ë—Ç –Ω–∞–º –≥–∏–±–∫–æ—Å—Ç—å –±–µ–∑ –ø–æ—Ç–µ—Ä—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–ª–∞–≥–æ–¥–∞—Ä—è –∏–Ω–¥–µ–∫—Å–∞–º GIN, –ø—Ä–∏ —ç—Ç–æ–º —Å–æ—Ö—Ä–∞–Ω—è—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ PostgreSQL-–æ–ø–µ—Ä–∞—Ç–æ—Ä—ã.

---

## ÔøΩ –í—ã–≤–æ–¥

JSONB –≤ PostgreSQL ‚Äî —ç—Ç–æ –∫–∞–∫ —à–≤–µ–π—Ü–∞—Ä—Å–∫–∏–π –Ω–æ–∂: 
- **–†–µ–∂–µ—Ç** –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏
- **–û—Ç–∫—Ä—ã–≤–∞–µ—Ç** –±—É—Ç—ã–ª–∫–∏ —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
- **–ò –¥–∞–∂–µ** –º–æ–∂–µ—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è –≤ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö

–ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–±–∏–≤–∞—Ç—å –∏–º –≥–≤–æ–∑–¥–∏ (—á–∏—Ç–∞–π: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –≤—Å–µ–≥–æ –ø–æ–¥—Ä—è–¥). –ö–æ–≥–¥–∞ —Å—Ö–µ–º–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–∏—à–ª–æ –≤—Ä–µ–º—è –¥–ª—è "–Ω–∞—Å—Ç–æ—è—â–∏—Ö" —Ç–∞–±–ª–∏—Ü.

P.S. –ï—Å–ª–∏ –≤–∞—à JSONB-–ø–æ–ª–µ —Å—Ç–∞–ª–æ –≥–ª—É–±–∂–µ, —á–µ–º –ú–∞—Ä–∏–∞–Ω—Å–∫–∞—è –≤–ø–∞–¥–∏–Ω–∞ ‚Äî —ç—Ç–æ –≤–µ—Ä–Ω—ã–π –∑–Ω–∞–∫, —á—Ç–æ –ø–æ—Ä–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å.
