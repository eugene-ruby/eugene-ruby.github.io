---
layout: post
subtitle: <div id="terminal"></div>
title:  "Prometheus –∏ Grafana: –º–µ—Ç—Ä–∏–∫–∏, –¥–∞—à–±–æ—Ä–¥—ã –∏ –∑–¥—Ä–∞–≤—ã–π —Å–º—ã—Å–ª"
date: 2024-09-18 12:00:00 +0300
rate: 4
tags: Ruby on Rails,Monitoring,DevOps,PostgreSQL,Prometheus,Grafana
version: A49X3
categories:
  - devops
  - performance
hero_image: /images/ruby.jpg
hero_darken: true
toc: true
menubar_toc: true
---
–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π ‚Äî —ç—Ç–æ –Ω–µ —Ä–æ—Å–∫–æ—à—å, –∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å. Prometheus –∏ Grafana —Å—Ç–∞–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–º –¥–µ-—Ñ–∞–∫—Ç–æ –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ –∏ –∏—Ö –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏. –ù–æ –∫–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ –∏ –Ω–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –¥–∞—à–±–æ—Ä–¥—ã –≤ "—Å—Ç–µ–Ω—É —É–∂–∞—Å–∞"? –†–∞–∑–±–µ—Ä—ë–º –Ω–∞ –ø—Ä–∏–º–µ—Ä–∞—Ö Ruby-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

---

## ÔøΩ –ü–æ—á–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ‚Äî —ç—Ç–æ –±–æ–ª—å

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ: –Ω–æ—á—å, production, —É –≤–∞—Å –ø–∞–¥–∞—é—Ç –∑–∞–ø—Ä–æ—Å—ã. –í—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ Grafana –∏ –≤–∏–¥–∏—Ç–µ:
- 15 –≥—Ä–∞—Ñ–∏–∫–æ–≤ `server_responses_5xx`, –Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ `database_query_time`;
- dashboard —Å 50 –º–µ—Ç—Ä–∏–∫–∞–º–∏, –≥–¥–µ –∫—Ä–∏—Ç–∏—á–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–æ –±–ª–µ–¥–Ω–æ-—Ä–æ–∑–æ–≤—ã–º;
- –∞–ª–µ—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É–∂–µ 3 —á–∞—Å–∞, –Ω–æ –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–º–µ—Ç–∏–ª.

–ó–Ω–∞–∫–æ–º–æ? –¢–æ–≥–¥–∞ –ø–æ–µ—Ö–∞–ª–∏ —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è.

---

## üìä –¢–µ–æ—Ä–∏—è: Prometheus + Grafana –∑–∞ 5 –º–∏–Ω—É—Ç

**Prometheus** ‚Äî —ç—Ç–æ:
- –°–∏—Å—Ç–µ–º–∞ —Å–±–æ—Ä–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ (time-series);
- Pull-–º–æ–¥–µ–ª—å (—Å–∞–º —Ö–æ–¥–∏—Ç –∑–∞ –º–µ—Ç—Ä–∏–∫–∞–º–∏);
- –ú—É–ª—å—Ç–∏-–¥–∏–º–µ–Ω—Å–∏–æ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (labels);
- –Ø–∑—ã–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ PromQL.

**Grafana** ‚Äî —ç—Ç–æ:
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫;
- –ì–∏–±–∫–∏–µ –¥–∞—à–±–æ—Ä–¥—ã;
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤.

–°–≤—è–∑–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫:  
`–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí (—ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–∏–∫–∏) ‚Üí Prometheus ‚Üí (—Ö—Ä–∞–Ω–∏—Ç) ‚Üí Grafana ‚Üí (—Ä–∏—Å—É–µ—Ç)`

---

## üõ†Ô∏è –ü—Ä–∞–∫—Ç–∏–∫–∞: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Ruby on Rails

### 1. –î–æ–±–∞–≤–ª—è–µ–º `prometheus-client`

```ruby
# Gemfile
gem 'prometheus-client'
```

### 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫

```ruby
# config/initializers/prometheus.rb
require 'prometheus/client'

Prometheus::Client.configure do |config|
  config.logger = Rails.logger
end

METRICS = {
  http_requests: Prometheus::Client::Counter.new(
    :http_requests_total,
    'Total HTTP requests',
    %i[method path status]
  ),
  db_query_time: Prometheus::Client::Histogram.new(
    :db_query_time_seconds,
    'Database query time',
    %i[model]
  )
}
```

### 3. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏—Ä—É–µ–º –∫–æ–¥

```ruby
# around_action –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
around_action :track_request_metrics

def track_request_metrics
  start = Time.now
  yield
ensure
  duration = Time.now - start
  METRICS[:http_requests].increment(
    method: request.method,
    path: request.path,
    status: response.status
  )
  METRICS[:request_duration].observe(duration)
end
```

### 4. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–µ—Ç—Ä–∏–∫–∏

```ruby
# config/routes.rb
require 'prometheus/middleware/collector'
require 'prometheus/middleware/exporter'

Rails.application.routes.draw do
  # ...
  get '/metrics', to: Prometheus::Middleware::Exporter.new
end
```

---

## üéõÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Prometheus

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'rails_app'
    scrape_interval: 15s
    static_configs:
      - targets: ['your-app:3000']
```

---

## üñ•Ô∏è –ü—Ä–∏–º–µ—Ä –¥–∞—à–±–æ—Ä–¥–∞ –≤ Grafana

**–ß—Ç–æ —Å—Ç–æ–∏—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –≤ Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:**
1. HTTP-–∑–∞–ø—Ä–æ—Å—ã (RPS, latency, error rate);
2. –ë–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (query time, connection pool);
3. –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (Sidekiq/ActiveJob);
4. –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏.

**–ü—Ä–∏–º–µ—Ä –ø–æ–ª–µ–∑–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞:**

```
sum(rate(http_requests_total{status=~"5.."}[1m])) by (path)
/
sum(rate(http_requests_total[1m])) by (path)
```

–≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫ –ø–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º.

---

## üí£ –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã

### 1. –ú–µ—Ç—Ä–∏–∫–∏ —Ä–∞–¥–∏ –º–µ—Ç—Ä–∏–∫
–°–æ–±–∏—Ä–∞—Ç—å –≤—Å—ë –ø–æ–¥—Ä—è–¥ ‚Äî –ø—É—Ç—å –∫ "—à—É–º—É".  
**–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**  
- –ú–µ—Ç—Ä–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å;
- –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Äî –Ω–µ —Å–æ–±–∏—Ä–∞–π—Ç–µ.

### 2. –î–∞—à–±–æ—Ä–¥-–ø–æ–º–æ–π–∫–∞
50 –≥—Ä–∞—Ñ–∏–∫–æ–≤ –Ω–∞ –æ–¥–Ω–æ–º —ç–∫—Ä–∞–Ω–µ ‚Äî —ç—Ç–æ –Ω–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, —ç—Ç–æ –≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å.  
**–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**  
- 5-9 –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π –¥–∞—à–±–æ—Ä–¥;
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Å–º—ã—Å–ª—É (HTTP, DB, Background);
- –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞: –∫—Ä–∞—Å–Ω—ã–π = –ø—Ä–æ–±–ª–µ–º–∞.

### 3. –ê–ª—ë—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∏–∫—Ç–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç
100 –∞–ª—ë—Ä—Ç–æ–≤ = 0 –∞–ª—ë—Ä—Ç–æ–≤.  
**–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**  
- –ê–ª–µ—Ä—Ç ‚Äî —ç—Ç–æ –æ–±–µ—â–∞–Ω–∏–µ, —á—Ç–æ –∫—Ç–æ-—Ç–æ –ø—Ä–æ—Å–Ω—ë—Ç—Å—è –Ω–æ—á—å—é;
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ severity levels (warning, critical);
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ —ç—Å–∫–∞–ª–∞—Ü–∏–∏.

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫

–ú–µ—Ç—Ä–∏–∫–∏ ‚Äî —ç—Ç–æ —Ç–æ–∂–µ –∫–æ–¥. –ò—Ö –Ω—É–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å.

```ruby
describe 'Metrics' do
  it 'increments http_requests on request' do
    expect {
      get '/some-path'
    }.to change {
      METRICS[:http_requests].get(labels: { method: 'GET', path: '/some-path', status: 200 })
    }.by(1)
  end
end
```

---

## üéØ –í—ã–≤–æ–¥

1. **Prometheus + Grafana** ‚Äî –º–æ—â–Ω—ã–π –¥—É—ç—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Rails-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.
2. **–ú–µ—Ç—Ä–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º–∏** ‚Äî —Å–æ–±–∏—Ä–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –±—É–¥–µ—Ç–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å.
3. **–î–∞—à–±–æ—Ä–¥—ã ‚Äî —ç—Ç–æ UI** ‚Äî –¥–µ–ª–∞–π—Ç–µ –∏—Ö –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –¥–∞–∂–µ –≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏.
4. **–ê–ª–µ—Ä—Ç—ã ‚Äî —ç—Ç–æ –æ–±–µ—â–∞–Ω–∏—è** ‚Äî –µ—Å–ª–∏ –Ω–µ –≥–æ—Ç–æ–≤—ã —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å, –Ω–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ.

> "–•–æ—Ä–æ—à–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ –Ω–æ—á—å—é –ø—Ä–æ—Å—ã–ø–∞—é—Ç—Å—è –ø–æ –¥–µ–ª—É, –∞ –Ω–µ –æ—Ç —Å–ø–∞–º–∞ –∞–ª—ë—Ä—Ç–∞–º–∏."
