---
layout: post
subtitle: <div id="terminal"></div>
title:  "–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –∏ –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ Rails: –∫–æ–≥–¥–∞, –∑–∞—á–µ–º –∏ –∫–∞–∫"
date:   2024-12-26 10:30:00 +0300
rate: 3
tags: Ruby on Rails,PostgreSQL,–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏,–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞,–ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞,DevOps
version: 3.2.2
categories:
  - orm
  - rails
  - postgres
toc: true
menubar_toc: true
hero_image: /images/posts/58.jpg
hero_darken: true
---
–í –º–∏—Ä–µ –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ Ruby on Rails —Ä–∞–±–æ—Ç–∞ —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–±—É–µ—Ç –æ—Å–æ–±–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è. PostgreSQL –∏ Rails –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç –¥–≤–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–∞ ‚Äî –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—É—é –∏ –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ. –≠—Ç–∏ –ø–æ–¥—Ö–æ–¥—ã –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω—ã –≤ DevOps-—Å—Ä–µ–¥–µ, –≥–¥–µ –≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –¥–µ–ª–∞—é—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º–æ–π.

–ö–æ–≥–¥–∞ —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å —Å –¥–∞–Ω–Ω—ã–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–ª–∏ –ø–æ—Ç–æ–∫–∏, –≤–∞–∂–Ω–æ –Ω–µ –∏—Å–ø–æ—Ä—Ç–∏—Ç—å –∏—Ö.  
–ò Rails –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –¥–≤–∞ –ø–æ–¥—Ö–æ–¥–∞: **–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ** –∏ **–ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ** –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ.

---

## ü§î –ß—Ç–æ —Ç–∞–∫–æ–µ –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞?

–≠—Ç–æ –∫–æ–≥–¥–∞ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å: "–Ø –±—É–¥—É —Ä–∞–±–æ—Ç–∞—Ç—å —Å —ç—Ç–æ–π –∑–∞–ø–∏—Å—å—é ‚Äî **–Ω–∏–∫–æ–º—É –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å!**"

```ruby
User.transaction do
  user = User.lock.find(42)
  user.update!(name: "New name")
end
````

üîí `SELECT ... FOR UPDATE` ‚Äî –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–æ –∫–æ–Ω—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
–í—Å–µ, –∫—Ç–æ –ø–æ–ø—Ä–æ–±—É–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Ç—É –∂–µ —Å—Ç—Ä–æ–∫—É —á–µ—Ä–µ–∑ `lock`, –±—É–¥—É—Ç **–∂–¥–∞—Ç—å**.

üß† –•–æ—Ä–æ—à–æ –ø–æ–¥—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞:

* –≤–∞–∂–Ω–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
* –¥–µ–π—Å—Ç–≤–∏—è –∑–∞–Ω–∏–º–∞—é—Ç –≤—Ä–µ–º—è
* –≤–æ–∑–º–æ–∂–Ω—ã —á–∞—Å—Ç—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã

---

## üòå –ß—Ç–æ —Ç–∞–∫–æ–µ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞?

–¢—ã –≥–æ–≤–æ—Ä–∏—à—å: "–Ø –Ω–∞–¥–µ—é—Å—å, —á—Ç–æ –Ω–∏–∫—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç... –Ω–æ –µ—Å–ª–∏ –≤–¥—Ä—É–≥ ‚Äî —è –∑–∞–º–µ—á—É".

### –®–∞–≥ 1: –î–æ–±–∞–≤—å `lock_version`

```ruby
rails generate migration AddLockVersionToUsers lock_version:integer
```

Rails –Ω–∞—á–Ω—ë—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ –ø–æ–ª–µ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ `update`.

```ruby
user1 = User.find(1)
user2 = User.find(1)

user1.update!(name: "Alice") # OK
user2.update!(name: "Bob")   # üí• ActiveRecord::StaleObjectError
```

–ï—Å–ª–∏ `lock_version` –∏–∑–º–µ–Ω–∏–ª—Å—è, `update!` —É–ø–∞–¥—ë—Ç.

üß† –•–æ—Ä–æ—à–æ, –∫–æ–≥–¥–∞:

* –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Ä–µ–¥–∫–∏
* –≤–∞–∂–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
* –∑–∞–ø–∏—Å—å –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—Ä–æ—Å–∏—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å

---

## üîç –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥?

| –ü–æ–¥—Ö–æ–¥                         | –ü—Ä–∏–º–µ–Ω—è—Ç—å, –µ—Å–ª–∏‚Ä¶                          |
| ------------------------------ | ----------------------------------------- |
| –ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–π (`lock`)        | –ù—É–∂–Ω–æ —Å—Ç—Ä–æ–≥–æ –∑–∞—â–∏—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π (`lock_version`) | –ú–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—Ä–æ—Å–∏—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å |

---

## ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* –ù–µ –∑–∞–±—ã–≤–∞–π –æ–±–µ—Ä–Ω—É—Ç—å `lock` –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é ‚Äî –∏–Ω–∞—á–µ –æ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!
* –î–ª—è `lock_version` –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `update!`, –∞ –Ω–µ `update` ‚Äî –∏–Ω–∞—á–µ –Ω–µ —É–≤–∏–¥–∏—à—å –æ—à–∏–±–∫–∏.

---

üß© **–°–æ–≤–µ—Ç**: –µ—Å–ª–∏ —Ç—ã —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—à—å –∞–¥–º–∏–Ω–∫—É, background job –∏–ª–∏ API —Å –∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—â–∏–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ ‚Äî –∑–Ω–∞–π –æ–±–∞ –º–µ—Ç–æ–¥–∞ –∏ –≤—ã–±–∏—Ä–∞–π –ø–æ–¥ –∑–∞–¥–∞—á—É.
