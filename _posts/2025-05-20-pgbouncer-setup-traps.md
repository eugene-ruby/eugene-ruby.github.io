---
layout: post
title: "PgBouncer: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞, –ø—Ä–æ–±–ª–µ–º—ã –∏ –ª–æ–≤—É—à–∫–∏"
date: 2025-05-20 14:00:00 +0300
categories:
  - postgres
  - rails
toc: true
menubar_toc: true
hero_image: /images/architecture.jpeg
hero_darken: true
---

> PgBouncer ‚Äî –∫–∞–∫ –∑–∞—Ç—ã—á–∫–∞ –≤ –≤–∞–Ω–Ω—É: –ø–æ–∫–∞ —Å—Ç–æ–∏—Ç ‚Äî –≤—Å—ë –¥–µ—Ä–∂–∏—Ç—Å—è. –£–±–µ—Ä–∏ ‚Äî –∏ –±–∞–∑–∞ –∑–∞—Ö–ª–µ–±–Ω—ë—Ç—Å—è.

---

## üß† –ó–∞—á–µ–º –Ω—É–∂–µ–Ω PgBouncer

PostgreSQL ‚Äî –Ω–µ –ª—é–±–∏—Ç –¥–µ—Å—è—Ç–∫–∏ –∏ —Å–æ—Ç–Ω–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.  
–ö–∞–∂–¥–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ = 1 –ø—Ä–æ—Ü–µ—Å—Å –≤ –û–°. –ü—Ä–∏ 100‚Äì200 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è—Ö ‚Äî –≤—Å—ë —Ç–æ—Ä–º–æ–∑–∏—Ç.

PgBouncer –±–µ—Ä—ë—Ç –Ω–∞ —Å–µ–±—è –ª–∞–≤–∏–Ω—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –æ—Ç Puma, Sidekiq –∏ Cron-–∑–∞–¥–∞—á, —É–¥–µ—Ä–∂–∏–≤–∞—è –∫ –ë–î 5‚Äì10 –Ω–∞—Å—Ç–æ—è—â–∏—Ö –∫–æ–Ω–Ω–µ–∫—Ç–æ–≤.

---

## ‚öôÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

PgBouncer ‚Äî —ç—Ç–æ –ø—É–ª–ª–µ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π. –û–Ω –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ç—Ä—ë—Ö —Ä–µ–∂–∏–º–∞—Ö:

| –†–µ–∂–∏–º         | –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç                             | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å         |
|---------------|------------------------------------------|----------------------------|
| `session`     | —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ –≤—Å—é —Å–µ—Å—Å–∏—é                 | –ø–æ—á—Ç–∏ –Ω–µ –¥–∞—ë—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞      |
| `transaction` | —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ –≤—Ä–µ–º—è SQL —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏       | **—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è**          |
| `statement`   | —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ –æ–¥–∏–Ω SQL-–∑–∞–ø—Ä–æ—Å            | —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è         |

---

## üõ† –ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```ini
# /etc/pgbouncer/pgbouncer.ini
[databases]
myapp = host=127.0.0.1 port=5432 dbname=myapp

[pgbouncer]
listen_port = 6432
listen_addr = 127.0.0.1
auth_type = trust
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 20
````

–í Rails:

```yaml
# config/database.yml
production:
  host: 127.0.0.1
  port: 6432
  pool: 20
```

---

## ü™§ –õ–æ–≤—É—à–∫–∏

### 1. `ActiveRecord::Base.connection.active?` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç false

–î–∞, PgBouncer –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ –ø—É–ª –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
Rails —Å—á–∏—Ç–∞–µ—Ç –µ–≥–æ "–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º", —Ö–æ—Ç—è –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç. –ù–µ –ø—É–≥–∞–π—Ç–µ—Å—å.

---

### 2. PgHero –ª–æ–º–∞–µ—Ç—Å—è

PgHero –ª—é–±–∏—Ç —Å–∏–¥–µ—Ç—å –≤ —Å–µ—Å—Å–∏–∏. –° PgBouncer –≤ —Ä–µ–∂–∏–º–µ `transaction` –æ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç –æ—à–∏–±–∞—Ç—å—Å—è.
–í—ã–≤–æ–¥: PgHero –ø–æ–¥–∫–ª—é—á–∞–π **–Ω–∞–ø—Ä—è–º—É—é**, –≤ –æ–±—Ö–æ–¥ PgBouncer.

---

### 3. –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ `rails db:prepare`

–û–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `connection.transaction`.
–ï—Å–ª–∏ –≤—ã –≤ —Ä–µ–∂–∏–º–µ `statement`, –ø–æ–ª—É—á–∏—Ç–µ `cannot PREPARE a transaction in this mode`.

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `transaction` –∏–ª–∏ –¥–µ–ª–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é –∫ PostgreSQL.

---

## üß© –í—ã–≤–æ–¥

PgBouncer –º–æ–∂–µ—Ç —Ä–∞–∑–≥—Ä—É–∑–∏—Ç—å PostgreSQL –∏ –ø—Ä–æ–¥–ª–∏—Ç—å –µ–≥–æ –∂–∏–∑–Ω—å –Ω–∞ –≥–æ–¥—ã.
–ù–æ **–Ω–µ –∑–∞–±—ã–≤–∞–π—Ç–µ**, —á—Ç–æ —ç—Ç–æ –Ω–µ –º–∞–≥–∏—è, –∞ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏.
