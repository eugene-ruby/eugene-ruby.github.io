---
layout: post
subtitle: <div id="terminal"></div>
title:  "–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WHERE –¥–ª—è JSONB –≤ PostgreSQL. –†–∞–∑–±–∏—Ä–∞–µ–º JSONB-–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –∂–∏–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å—Ç–µ–Ω–¥–∞ –Ω–∞ 10.000 —Å—Ç—Ä–æ–∫"
date:  2025-04-20 11:00:00 +0300
rate: 3
tags: PostgreSQL  JSONB SQL performance
version: A9X
categories:
   - postgres
   - database
toc: true
menubar_toc: true
hero_image: /images/posts/35.jpg
hero_darken: true
---

PostgreSQL —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π JSONB ‚Äî —ç—Ç–æ ~~–±–µ–∑–¥–æ–Ω–Ω–∞—è~~ –º–∞–≥–∏—á–µ—Å–∫–∞—è —Å—É–º–∫–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞: –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—É—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø—Ä–∏ —ç—Ç–æ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å. –í —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä—ë–º —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ —Å `WHERE` –ø–æ JSONB-–ø–æ–ª—è–º –∏ —Å–æ–±–µ—Ä—ë–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å—Ç–µ–Ω–¥ –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤.

---

## ü§î JSON vs JSONB, —á—Ç–æ —ç—Ç–æ –∑–∞ `B`

–ü–æ–ª–µ JSONB –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—É—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ JSON, —Ç–∏–ø JSONB —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `–±–∏–Ω–∞—Ä–Ω–æ–º` –≤–∏–¥–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é. –≠—Ç–æ –¥–∞—ë—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∏ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π –º–æ–¥–µ–ª—å—é.

## üß± –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ç–µ–Ω–¥–∞

–ü—Ä–µ–∂–¥–µ —á–µ–º –ø—Ä—ã–≥–∞—Ç—å –≤ –∑–∞–ø—Ä–æ—Å—ã, —Å–æ–∑–¥–∞–¥–∏–º —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ä–µ–¥—É. –í–æ—Ç Docker-–∫–æ–º–ø–æ–∑ –¥–ª—è PostgreSQL + —Å–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:

```bash
# docker-compose.yml
services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_PASSWORD: test
    ports:
      - "5432:5432"
    volumes:
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
```

```sql
-- init.sql
CREATE TABLE products (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100),
  attributes JSONB NOT NULL
);

-- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
INSERT INTO products (name, attributes)
SELECT 
  'Product ' || i,
  jsonb_build_object(
    'price', (random() * 100)::numeric(10,2),
    'tags', CASE WHEN random() > 0.5 
           THEN jsonb_build_array('sale', 'new') 
           ELSE jsonb_build_array('popular') END,
    'specs', jsonb_build_object(
      'weight', (random() * 10)::numeric(5,2),
      'color', CASE floor(random()*4)
               WHEN 0 THEN 'red'
               WHEN 1 THEN 'blue'
               ELSE 'black' END
    )
  )
FROM generate_series(1, 10000) AS i;
```

---

### –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–µ–Ω–¥–∞

#### –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `attributes`

–ü–æ–ª–µ `attributes` —Å–æ–¥–µ—Ä–∂–∏—Ç JSONB-–æ–±—ä–µ–∫—Ç —Å —Ç–∞–∫–∏–º–∏ –∫–ª—é—á–∞–º–∏:

| –ö–ª—é—á    | –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö             | –ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è                      |
| ------- | ---------------------- | ------------------------------------ |
| `price` | —á–∏—Å–ª–æ (decimal)        | `49.75`                              |
| `tags`  | –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫           | `["sale", "new"]` –∏–ª–∏ `["popular"]`  |
| `specs` | –≤–ª–æ–∂–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç JSONB | `{ "weight": 3.42, "color": "red" }` |

---

#### –ü—Ä–∏–º–µ—Ä –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏

```json
{
  "price": 67.23,
  "tags": ["sale", "new"],
  "specs": {
    "weight": 7.85,
    "color": "black"
  }
}
```

---

### üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º

```bash
docker-compose up -d
psql -d postgres -h 127.0.0.1 -U postgres -W
```
–ø–∞—Ä–æ–ª—å `test`

–∏–ª–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: `docker ps` –ø–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ, —É –º–µ–Ω—è `jsonb-where-postgres-postgres-1`
```bash
docker exec -it jsonb-where-postgres-postgres-1 bash
psql -U postgres
```

```bash
SELECT COUNT(*) FROM products;
 count 
-------
  10000
```

–¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å 10.000 —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ –≤ JSONB.

---

## üîç –ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ WHERE —Å JSONB

### 1. –ü–æ–∏—Å–∫ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é –∫–ª—é—á–∞
```sql
-- –¢–æ–≤–∞—Ä—ã –∫—Ä–∞—Å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
SELECT name, attributes->'specs'->>'color' AS color
FROM products
WHERE attributes->'specs'->>'color' = 'red';
```

### 2. –§–∏–ª—å—Ç—Ä –ø–æ —á–∏—Å–ª–æ–≤–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é
```sql
-- –¢–æ–≤–∞—Ä—ã –¥–µ—à–µ–≤–ª–µ 50
SELECT name, attributes->>'price' AS price
FROM products
WHERE (attributes->>'price')::numeric < 50;
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–ª—é—á–∞
```sql
-- –¢–æ–≤–∞—Ä—ã —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –≤–µ—Å–æ–º
SELECT name 
FROM products
WHERE attributes->'specs' ? 'weight';
```

---

## üß© –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –ü–æ–∏—Å–∫ –ø–æ –º–∞—Å—Å–∏–≤—É —Ç–µ–≥–æ–≤
```sql
-- –¢–æ–≤–∞—Ä—ã —Å —Ç–µ–≥–æ–º 'sale'
SELECT name, attributes->'tags' AS tags
FROM products
WHERE attributes->'tags' @> '["sale"]'::jsonb;
```

### –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
```sql
-- –ö—Ä–∞—Å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã —Å–æ —Å–∫–∏–¥–∫–æ–π —Ç—è–∂–µ–ª–µ–µ 5 –∫–≥
SELECT name
FROM products
WHERE attributes->'specs'->>'color' = 'red'
  AND (attributes->'specs'->>'weight')::numeric > 5
  AND attributes->'tags' @> '["sale"]'::jsonb;
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GIN-–∏–Ω–¥–µ–∫—Å–æ–≤
–î–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ JSONB:

```sql
CREATE INDEX idx_products_attributes ON products USING GIN (attributes jsonb_path_ops);
```
> –ò –≤—Å–µ? –≤ JSONB —Ç–∞–∫ –ª–µ–≥–∫–æ —Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π? –ê–≥–∞, —Å–µ–π—á–∞—Å üòÖ –≠—Ç–æ —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä, –∞ —Ç–∞–º —É–π–º–∞ —Å–≤–æ–∏—Ö –ø—Ä–∏–∫–æ–ª–æ–≤ –∏ –±–æ–ª–∏! ü§Ø

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: EXPLAIN –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ

–ü—Ä–æ–≤–µ—Ä–∏–º —Ä–∞–∑–Ω–∏—Ü—É —Å –∏–Ω–¥–µ–∫—Å–æ–º –∏ –±–µ–∑:
```sql
EXPLAIN ANALYZE
SELECT * FROM products
WHERE attributes @> '{"tags": ["sale"]}'::jsonb;
```

–î–æ –∏–Ω–¥–µ–∫—Å–∞:
```
  Seq Scan on products  (cost=0.00..334.00 rows=4949 width=136) (actual time=0.014..7.555 rows=4969 loops=1)
```

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è GIN-–∏–Ω–¥–µ–∫—Å–∞:
```
 Bitmap Heap Scan on products  (cost=54.36..325.22 rows=4949 width=136) (actual time=0.519..3.522 rows=4969 loops=1)
```

–î–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–Ω–¥–µ–∫—Å
```sql
DROP INDEX idx_products_attributes;
```

> ‚ö†Ô∏è –ú—ã —Å–æ–∑–¥–∞–ª–∏ 10 000 —Å—Ç—Ä–æ–∫, —á—Ç–æ–±—ã –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ ¬´–ª–µ–Ω–∏–ª—Å—è¬ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å, –∏ –≤—ã –Ω–µ –ª–µ–Ω–∏—Ç–µ—Å—å –¥–µ–ª–∞—Ç—å —Å—Ç–µ–Ω–¥ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—ã–π –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É.

---

## üí• –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã

1. **–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤**  
   ```sql
   -- –ü–ª–æ—Ö–æ: –Ω–µ—è–≤–Ω–æ–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤
   WHERE attributes->>'price' < '50';
   
   -- –•–æ—Ä–æ—à–æ: —è–≤–Ω–æ–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ
   WHERE (attributes->>'price')::numeric < 50;
   ```

2. **–ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**  
   –í–º–µ—Å—Ç–æ —Ü–µ–ø–æ—á–∫–∏ `->'a'->'b'->>'c'` –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `#>>'{a,b,c}'`:
   ```sql
   -- –û–ø—Ç–∏–º–∞–ª—å–Ω–æ:
   WHERE attributes#>>'{specs,color}' = 'red';
   ```

3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤**  
   –ü–æ–∏—Å–∫ –ø–æ JSONB –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö ‚Äî –ø—É—Ç—å –∫ –º–µ–¥–ª–µ–Ω–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º.

---

## ü§ì–í—ã–≤–æ–¥

1. **JSONB –≤ PostgreSQL** ‚Äî –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –Ω–æ —Ç—Ä–µ–±—É—é—â–∏–π –∞–∫–∫—É—Ä–∞—Ç–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã `@>`, `?`, `->>`** –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è
3. **–ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –ø—Ä–æ –∏–Ω–¥–µ–∫—Å—ã** –¥–ª—è —á–∞—Å—Ç–æ —Ñ–∏–ª—å—Ç—Ä—É–µ–º—ã—Ö –ø–æ–ª–µ–π
4. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–ª–∞–Ω—ã –∑–∞–ø—Ä–æ—Å–æ–≤** ‚Äî EXPLAIN –≤–∞—à –ª—É—á—à–∏–π –¥—Ä—É–≥
